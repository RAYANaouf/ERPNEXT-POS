(()=>{pos_ar.PointOfSale.Controller=class{constructor(e){this.wrapper=$(e).find(".layout-main-section"),this.page=e.page,this.customersList=[],this.itemGroupList=[],this.itemList=[],this.itemPrices=[],this.priceLists=[];let t=frappe.model.get_new_doc("POS Invoice");t.items=[],this.selectedItemMaps=new Map([["C1",t]]),this.warehouseList=[],this.PosProfileList=[],this.binList=[],this.selectedItem={},this.selectedField={},this.selectedTab={tabName:"C1"},this.selectedPaymentMethod={methodName:""},this.selectedCustomer={name:""},this.sellInvoices=new Map,this.POSOpeningEntry={},this.invoiceData={grandTotal:0,paidAmount:0,toChange:0},this.db=null,this.start_app()}async start_app(){this.db=new pos_ar.PointOfSale.pos_db,this.prepare_container(),await this.prepare_app_defaults(),await this.checkForPOSEntry(),await this.prepare_components(),this.setListeners(),console.log("selectedItemMaps ::: ",this.selectedItemMaps)}async refreshApp(){console.log("refresh"),this.$components_wrapper.text(""),await this.checkForPOSEntry(),await this.prepare_components(),this.setListeners()}async prepare_app_defaults(){if(this.customersList=await this.fetchCustomers(),this.itemGroupList=await this.fetchItemGroups(),this.itemList=await this.fetchItems(),this.itemPrices=await this.fetchItemPrice(),this.priceLists=await this.fetchPriceList(),this.warehouseList=await this.fetchWarehouseList(),this.PosProfileList=await this.fetchPosProfileList(),this.binList=await this.fetchBinList(),this.sales_taxes_and_charges=await this.fetchSalesTaxesAndCharges(),this.taxes_and_charges_template=await this.fetchSalesTaxesAndChargesTemplate(),this.sales_tax=this.getSalesTax(),console.log("loooooooooooooooooooke at here : ",this.sales_tax),this.PosProfileList.length==0){frappe.set_route("Form","POS Profile");return}console.log("customersList => ",this.customersList),console.log("itemGroupList => ",this.itemGroupList),console.log("itemList      => ",this.itemList),console.log("itemPrices    => ",this.itemPrices),console.log("priceLists    => ",this.priceLists),console.log("warehouseList => ",this.warehouseList),console.log("POSProfileList => ",this.PosProfileList),console.log("bin list       => ",this.binList),console.log("taxes and charges templates  => ",this.taxes_and_charges_template),console.log("taxes and charges            => ",this.sales_taxes_and_charges)}prepare_container(){this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/selectorBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/itemDetailsCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/paymentMethodCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/customerBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/cartBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/historyCarts.css">'),this.wrapper.append('<div id="MainContainer" class="rowBox"></div>'),this.$components_wrapper=this.wrapper.find("#MainContainer")}prepare_components(){this.set_right_and_left_sections(),this.init_item_selector(),this.init_customer_box(),this.init_selected_item(),this.init_item_details(),this.init_paymentCart(),this.init_historyCart()}async checkForPOSEntry(){try{let e=await frappe.db.get_list("POS Opening Entry",{filters:{pos_profile:this.PosProfileList[0].name,status:"Open",user:frappe.session.user},fields:["name","pos_profile","period_start_date","company"],limit:1});return e.length===0?(this.create_opening_voucher(),!1):(Object.assign(this.POSOpeningEntry,e[0]),console.log("==> ",this.POSOpeningEntry),!0)}catch(e){return console.error("error occured : ",e),frappe.throw("Error checking for POS Opening Entry."),!1}}create_opening_voucher(){let e=this,t=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",options:"company:company_currency",change:function(){s.fields_dict.balance_details.df.data.some(a=>{if(a.idx==this.doc.idx)return a.opening_amount=this.value,s.fields_dict.balance_details.grid.refresh(),!0})}}],i=()=>{let a=s.fields_dict.pos_profile.get_value();!a||frappe.db.get_doc("POS Profile",a).then(({payments:o})=>{s.fields_dict.balance_details.df.data=[],o.forEach(l=>{let{mode_of_payment:r}=l;s.fields_dict.balance_details.df.data.push({mode_of_payment:r,opening_amount:"0"})}),s.fields_dict.balance_details.grid.refresh()})},s=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>n(),onchange:()=>i()},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:t}],primary_action:async function({company:a,pos_profile:o,balance_details:l}){if(!l.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");l=l.filter(d=>d.mode_of_payment);let r="erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher",c=await frappe.call({method:r,args:{pos_profile:o,company:a,balance_details:l},freeze:!0});!c.exc&&e.prepare_app_defaults(c.message),Object.assign(e.POSOpeningEntry,{name:c.message.name,pos_profile:c.message.pos_profile,period_start_date:c.message.period_start_date,company:c.message.company}),s.hide()},primary_action_label:__("Submit")});s.show();let n=()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:s.fields_dict.company.get_value()}})}set_right_and_left_sections(){this.$components_wrapper.append('<div id="LeftSection" class="columnBox"></div>'),this.$components_wrapper.append('<div id="RightSection" class="columnBox"></div>'),this.$rightSection=this.$components_wrapper.find("#RightSection"),this.$leftSection=this.$components_wrapper.find("#LeftSection")}init_item_selector(){console.log("item list from controller : ",this.itemList),this.item_selector=new pos_ar.PointOfSale.pos_item_selector(this.$leftSection,this.itemList,this.itemGroupList,this.itemPrices,e=>{this.itemClick_selector(e)})}init_customer_box(){this.customer_box=new pos_ar.PointOfSale.pos_customer_box(this.$rightSection,this.customersList,this.selectedCustomer,this.onSync.bind(this),this.onClosePOS.bind(this),this.onHistoryClick.bind(this))}init_selected_item(){this.selected_item_cart=new pos_ar.PointOfSale.pos_selected_item_cart(this.$rightSection,this.selectedItemMaps,this.selectedTab,this.selectedItem,this.selectedField,e=>{this.onSelectedItemClick(e)},e=>{this.onClose_details()},(e,t)=>{this.onKeyPressed(e,t)},this.onCheckout.bind(this))}init_item_details(){console.log("warehouse ==> ",this.PosProfileList[0].warehouse),this.item_details=new pos_ar.PointOfSale.pos_item_details(this.$leftSection,this.PosProfileList[0].warehouse,this.priceLists,this.itemPrices,this.binList,this.selectedItem,this.selectedField,(e,t,i)=>{this.onInput(e,t,i)},this.onClose_details.bind(this))}init_paymentCart(){console.log("im heeeeeeeeeeeeer @#$%^&*(*&^%$##$%^&*()^%$#@"),console.log(" hiiiiiiiiiiiiiiiiiiii payment ::"),this.payment_cart=new pos_ar.PointOfSale.pos_payment_cart(this.$leftSection,this.selectedItemMaps,this.selectedTab,this.selectedPaymentMethod,this.invoiceData,this.onClose_payment_cart.bind(this),this.onCompleteOrder.bind(this),(e,t,i)=>{this.onInput(e,t,i)}),console.log(" hiiiiiiiiiiiiiiiiiiii payment ",this.payment_cart)}init_historyCart(){this.history_cart=new pos_ar.PointOfSale.pos_history(this.wrapper,this.db)}itemClick_selector(e){let t=structuredClone(e);t.discount_amount=0,t.discount_percentage=0,this.addItemToPosInvoice(e),console.log("updated ===> ",this.selectedItemMaps),this.selected_item_cart.calculateNetTotal(),this.selected_item_cart.calculateQnatity(),this.selected_item_cart.calculateGrandTotal(),this.selected_item_cart.refreshSelectedItem()}onSelectedItemClick(e){Object.assign(this.selectedItem,e),console.log("selected item clicked ::: ",e),console.log("item_details :: ",this.item_details),console.log("item_selector :: ",this.item_selector),console.log("payment_cart :: ",this.payment_cart),this.item_details.show_cart(),this.selected_item_cart.showKeyboard(),this.item_selector.hideCart(),this.payment_cart.hideCart(),this.selected_item_cart.setKeyboardOrientation("landscape"),this.item_details.refreshDate(e)}onCheckout(){this.payment_cart.showCart(),this.item_selector.hideCart(),this.item_details.hide_cart(),this.payment_cart.calculateGrandTotal(),this.selected_item_cart.setKeyboardOrientation("landscape"),this.selected_item_cart.cleanHeighlight(),this.selected_item_cart.showKeyboard()}onClose_details(){this.item_selector.showCart(),this.payment_cart.hideCart(),this.item_details.hide_cart(),this.selected_item_cart.hideKeyboard(),this.selected_item_cart.setKeyboardOrientation("portrait"),this.selected_item_cart.cleanHeighlight()}onClose_payment_cart(){this.item_selector.showCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.selected_item_cart.hideKeyboard(),this.selected_item_cart.setKeyboardOrientation("portrait"),this.selected_item_cart.cleanHeighlight()}onHistoryClick(){console.log("history ::",this.history_cart),this.history_cart.show_cart(),this.payment_cart.hideCart(),this.item_details.hide_cart(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.customer_box.hideActionBar()}onInput(e,t,i){if(console.log("<<we are in onInpute function >>  event : ",e," field : ",t," value : ",i),e=="focus"||e=="blur"){e=="focus"&&Object.assign(this.selectedField,{field_name:t}),e=="blur"&&Object.assign(this.selectedField,{field_name:null}),this.item_details.makeSelectedFieldHighlighted(),this.selected_item_cart.makeSelectedButtonHighlighted();return}if(t=="quantity")this.selectedItem.quantity=i,this.editPosItemQty(this.selectedItem.name,this.selectedItem.quantity),console.log("item ==>>> ",this.selectedItem),this.selected_item_cart.refreshSelectedItem();else if(t=="rate"){this.selectedItem.rate=i,this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate);let s=this.selectedItem.rate,n=this.selectedItem.discount_percentage,a=s*(n/100);this.selectedItem.discount_percentage=n,this.selectedItem.discount_amount=a,console.log("item ==>>> ",this.selectedItem),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(t=="discount_percentage"){let n=this.selectedItem.rate*(i/100);this.selectedItem.discount_percentage=parseFloat(i),this.selectedItem.discount_amount=n,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemDiscountPercentage(this.selectedItem.name,this.selectedItem.discount_percentage),console.log("item ==>>> ",this.selectedItem),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(t=="discount_amount"){let s=this.selectedItem.rate,n=(i*100/s).toFixed(2),a=parseFloat(i);n>100&&(n=100),i>s&&(a=s),this.selectedItem.discount_percentage=parseFloat(n),this.selectedItem.discount_amount=a,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemDiscountPercentage(this.selectedItem.name,this.selectedItem.discount_percentage),console.log("item ==>>> ",this.selectedItem),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}}onKeyPressed(e,t){var i;if(console.log("<<we are in onKeyPressed function >>"),console.log("action ::: ",e," key ::: ",t),e=="quantity")this.item_details.requestFocus("quantity");else if(e=="rate")this.item_details.requestFocus("rate");else if(e=="discount")this.item_details.requestFocus("discount_percentage");else if(e=="remove")this.selectedItemMaps.get(this.selectedTab.tabName).delete(this.selectedItem.name),this.selected_item_cart.refreshSelectedItem();else if(e=="delete"){let s=this.item_details.deleteCharacter();if(this.selectedField.field_name=="quantity")this.selectedItem.quantity=s,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem));else if(this.selectedField.field_name=="rate")this.selectedItem.amount=s,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem));else if(this.selectedField.field_name=="discount_percentage"){let a=this.selectedItem.amount*(s/100);this.selectedItem.discount_percentage=s,this.selectedItem.discount_amount=a,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem))}else if(this.selectedField.field_name=="discount_percentage"){let a=this.selectedItem.amount*(s/100);this.selectedItem.discount_percentage=s,this.selectedItem.discount_amount=a,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem))}this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(e=="cash")console.log("action :: ",e," key :: ",t),this.paid_amount=t,this.payment_cart.refreshData();else if(e=="addToField"){if(this.selectedField.field_name=="cash")this.payment_cart.handleInput(t);else if(this.selectedField.field_name=="quantity")this.selectedItem.quantity+=t,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem)),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem);else if(this.selectedField.field_name=="rate")this.selectedItem.amount+=t,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem)),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem);else if(this.selectedField.field_name=="discount_percentage"){let s=this.selectedItem.amount,a=`${(i=this.selectedItem.discount_percentage)!=null?i:0}`+t,o=parseFloat(a);o>100&&(o=100);let l=s*(o/100),r=s-l;this.selectedItem.discount_percentage=o,this.selectedItem.discount_amount=l,this.selectedItem.amount=r,this.selectedItemMaps.get(this.selectedTab.tabName).set(this.selectedItem.name,Object.assign({},this.selectedItem)),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}}}onCompleteOrder(){let e=[];if(this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{let o={item_name:a.name,item_code:a.name,rate:a.rate,qty:a.qty,description:a.name,image:a.image,expense_account:"Cost of Goods Sold - MS",use_serial_batch_fields:1,discount_percentage:a.discount_percentage,discount_amount:a.discount_amount,warehouse:this.PosProfileList[0].warehouse,income_account:this.PosProfileList[0].income_account,item_tax_rate:{}};e.push(o)}),e.length==0)return;let t=0,i=0;e.forEach(a=>{t+=a.qty,i+=a.rate*a.qty});let s=frappe.model.get_new_doc("POS Invoice");s.customer=this.customersList[0].name,s.pos_profile=this.PosProfileList[0].name,s.items=e,s.paid_amount=i,s.base_paid_amount=i,s.amount_eligible_for_commission=i,s.creation_time=frappe.datetime.now_datetime(),s.payments=[{mode_of_payment:"Cash",amount:i}],s.is_pos=1,s.update_stock=1,s.docstatus=1,this.sellInvoices.set(s.name,s),this.db.savePosInvoice(s,a=>{console.log("sucess => ",a)},a=>{console.log("failure => ",a)}),this.customer_box.setNotSynced(),this.selectedItemMaps.delete(this.selectedTab.tabName);let n=Array.from(this.selectedItemMaps.keys());n.length>0?(this.selectedTab.tabName=n[0],this.selected_item_cart.refreshTabs(),this.selected_item_cart.refreshSelectedItem()):this.selected_item_cart.createNewTab(),this.onClose_payment_cart()}onSync(){if(this.POSOpeningEntry.name==""){this.checkForPOSEntry();return}let e=Array.from(this.sellInvoices.keys());if(e.length==0){frappe.msgprint({title:__("Sync Complete"),indicator:"green",message:__("All data is already synchronized.")});return}frappe.show_progress("Syncing Invoices...",0,e.length,"syncing");let t=0,i=0,s=0,n=[];e.forEach(a=>{let o=0,l=0;this.sellInvoices.get(a).items.forEach(r=>{l+=r.qty,o+=r.rate*r.qty}),frappe.db.insert(this.sellInvoices.get(a)).then(r=>{n.push({pos_invoice:r.name,customer:r.customer}),this.sellInvoices.delete(a),t+=1,frappe.show_progress("Syncing Invoices...",t,e.length,"syncing"),t==e.length&&(frappe.hide_progress(),this.customer_box.setSynced())}).catch(r=>{t+=1,i+=1})})}onClosePOS(){let e=Array.from(this.sellInvoices.keys());e.length>0&&frappe.throw(__(`you have ${e.length} invoice to sync first.`));let t=frappe.model.get_new_doc("POS Closing Entry");t.pos_opening_entry=this.POSOpeningEntry.name,t.pos_profile=this.POSOpeningEntry.pos_profile,t.company=this.POSOpeningEntry.company,t.user=frappe.session.user,t.posting_date=frappe.datetime.now_date(),t.posting_time=frappe.datetime.now_time(),frappe.set_route("Form","POS Closing Entry",t.name),this.POSOpeningEntry.name=""}setListeners(){window.addEventListener("offline",function(){frappe.msgprint("you lose the connection (offline mode)")}),window.addEventListener("online",function(){frappe.msgprint("the connection is back (online mode)")})}getItemPrice(e){let t=this.itemPrices.find(i=>i.item_code==e);return t?t.price_list_rate:0}checkServiceWorker(){"serviceWorker"in navigator&&(window.addEventListener("DOMContentLoaded",()=>{navigator.serviceWorker.register("./sw.js").then(e=>console.log("Service Worker registered successfully.")).catch(e=>console.log(`Service Worker registration failed: ${e}`))}),this.sw=new pos_ar.PointOfSale.Sw,document.readyState==="complete"&&(console.log("DOM was already loaded"),navigator.serviceWorker.register("../assets/pos_ar/public/js/sw.js").then(e=>console.log("Service Worker registered successfully.")).catch(e=>console.log(`Service Worker registration failed: ${e}`))))}addItemToPosInvoice(e){let t={};Object.assign(t,e),console.log("clicked item ::: ",e);let s=this.selectedItemMaps.get(this.selectedTab.tabName).items,n=!1;s.forEach(a=>{a.name==e.name&&(n=!0,a.qty+=1)}),n||(t.discount_amount=0,t.discount_percentage=0,t.qty=1,t.rate=this.getItemPrice(e.name),s.push(t))}editPosItemQty(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(s=>{s.name==e&&(s.qty=t)})}editPosItemRate(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(s=>{s.name==e&&(s.rate=t)})}editPosItemDiscountPercentage(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(s=>{s.name==e&&(s.discount_percentage=t)})}editPosItemDiscountAmount(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(s=>{s.name==e&&(s.discount_amount=t)})}getSalesTax(){let e=this.PosProfileList.taxes_and_charges,t=null;return this.sales_taxes_and_charges.forEach(i=>{i.parent==e&&(t=i)}),t}async fetchCustomers(){try{return await frappe.db.get_list("Customer",{fields:["name","customer_name"],filters:{},limit:1e5})}catch(e){return console.error("Error fetching customers:",e),[]}}async fetchItemGroups(){try{return await frappe.db.get_list("Item Group",{fields:["name","item_group_name","parent_item_group","is_group"],filters:{},limit:1e5})}catch(e){return console.error("Error fetching Item Group :",e),[]}}async fetchItems(){try{return await frappe.db.get_list("Item",{fields:["name","item_name","image","item_group","stock_uom"],filters:{disabled:0},limit:1e5})}catch(e){return console.error("Error fetching Item Group :",e),[]}}async fetchItemPrice(){try{return await frappe.db.get_list("Item Price",{fields:["name","item_code","item_name","price_list","price_list_rate"],filters:{price_list:"Standard Selling"},limit:1e5})}catch(e){return console.error("Error fetching Item Group :",e),[]}}async fetchPriceList(){try{return await frappe.db.get_list("Price List",{fields:["name","price_list_name","currency"],filters:{selling:1},limit:1e5})}catch(e){return console.error("Error fetching Item Group :",e),[]}}async fetchWarehouseList(){try{return await frappe.db.get_list("Warehouse",{fields:["name","warehouse_name"],filters:{},limit:1e5})}catch(e){return console.error("Error fetching Warehouse list : ",e),[]}}async fetchPosProfileList(){try{return await frappe.db.get_list("POS Profile",{fields:["name","warehouse","income_account","write_off_account","write_off_cost_center","taxes_and_charges","tax_category"],filters:{disabled:0},limit:1e5})}catch(e){return console.error("Error fetching Warehouse list : ",e),[]}}async fetchSalesTaxesAndChargesTemplate(){try{return await frappe.db.get_list("Sales Taxes and Charges Template",{fields:["name","title","is_default","company","tax_category","taxes"],filters:{disabled:0},limit:1e5})}catch(e){return console.error("Error fetching Warehouse list : ",e),[]}}async fetchSalesTaxesAndCharges(){try{return await frappe.db.get_list("Sales Taxes and Charges",{fields:["name","description","cost_center","rate","tax_amount","total","tax_amount_after_discount_amount","account_head"],filters:{parenttype:"Sales Taxes and Charges Template"},limit:1e5})}catch(e){return console.error("Error fetching Warehouse list : ",e),[]}}async fetchBinList(){try{return await frappe.db.get_list("Bin",{fields:["actual_qty","item_code","warehouse"],filters:{},limit:1})}catch(e){return console.error("Error fetching Bin list : ",e),[]}}};pos_ar.PointOfSale.pos_item_selector=class{constructor(e,t,i,s,n){this.wrapper=e,this.item_list=t,this.item_group_list=i,this.item_prices=s,this.on_item_click=n,this.start_item_selector()}start_item_selector(){this.prepare_select_box(),this.setItemGroupsInList(),this.setItemInFlow(this.getItemByItemGroup("")),this.setListeners()}prepare_select_box(){this.wrapper.append('<div id="SelectorBox" class="columnBox"></div>'),this.selectorBox=this.wrapper.find("#SelectorBox"),this.selectorBox.append('<div id="selectorBoxHeader" class="rowBox header"></div>'),this.header=this.selectorBox.find("#selectorBoxHeader"),this.header.append('<h4 class="CartTitle">Items</h4>'),this.header.append('<div id="inputsBox" class="rowBox align_center"></div>'),this.inputBox=this.header.find("#inputsBox"),this.inputBox.append('<input type="text" autocomplete="off"  maxlength="140" placeholder="Search by item code, serial number or barcode" id="ItemInput" name="item" placeHolder="Enter the customer">'),this.inputBox.append('<input list="ItemGroupList"  id="ItemGroupInput" name="ItemGroup" placeHolder="Item Group">'),this.inputBox.append('<datalist id="ItemGroupList"></datalist>'),this.itemGroupList=this.inputBox.find("#ItemGroupList"),this.itemGroupList.append("<option>fetching Item Groups ...</option>"),this.selectorBox.append('<div id="itemsContainer" class="rowBox row_wrap"></div>'),this.itemsContainer=this.selectorBox.find("#itemsContainer")}setItemGroupsInList(){let e=document.getElementById("ItemGroupList");e.innerHTML="",this.item_group_list.forEach(t=>{let i=document.createElement("option");i.value=t.name,i.textContent=t.customer_name,e.appendChild(i)})}setItemInFlow(e){let t=document.getElementById("itemsContainer");t.innerHTML="",e.forEach(i=>{let s=document.createElement("div");if(s.classList.add("itemBox"),s.classList.add("columnBox"),s.classList.add("C_A_Center"),s.addEventListener("click",o=>{this.on_item_click(i)}),i.image){let o=document.createElement("img");o.classList.add("itemImage"),o.src=i.image,s.appendChild(o)}else{let o=document.createElement("div");o.classList.add("itemImage"),o.classList.add("rowBox"),o.classList.add("centerItem");let l=document.createElement("h1");l.textContent=i.item_name[0],l.style.color="#707070",o.appendChild(l),s.appendChild(o)}let n=document.createElement("div");n.textContent=i.name,n.classList.add("itemTitle"),s.appendChild(n);let a=document.createElement("div");a.classList.add("itemPrice"),a.textContent=this.getItemPrice(i.name)+" DA",s.appendChild(a),t.appendChild(s)})}showCart(){this.selectorBox.css("display","flex")}hideCart(){this.selectorBox.css("display","none")}setListeners(){document.getElementById("ItemGroupInput").addEventListener("input",t=>{this.setItemInFlow(this.getItemByItemGroup(event.target.value))})}getItemByItemGroup(e){let t=[],i=a=>{t.push(a),this.item_group_list.forEach(o=>{o.parent_item_group==a&&(t.push(o.name),o.is_group&&i(o.name))})};i(e);let s=[],n=a=>{this.item_list.forEach(o=>{o.item_group==a&&s.push(o)})};return t.forEach(a=>{n(a)}),s}getItemPrice(e){let t=this.item_prices.find(i=>i.item_code==e);return t?t.price_list_rate:0}};pos_ar.PointOfSale.pos_customer_box=class{constructor(e,t,i,s,n,a){this.wrapper=e,this.customers_list=t,this.selected_customer=i,this.on_sync=s,this.on_close_pos=n,this.on_history_click=a,this.online=!0,this.show_menu=!1,this.start_work()}start_work(){this.prepare_customer_box(),this.setCustomersInList(),this.setListeners()}prepare_customer_box(){this.wrapper.append('<div id="ActionsContainerBox" class="rowBox align_center">'),this.actionContainer=this.wrapper.find("#ActionsContainerBox"),this.actionContainer.append('<div id="CustomerBox" class="rowBox align_center">'),this.actionContainer.append('<div id="MenuBox"     class="rowBox centerItem">'),this.actionContainer.append('<div id="HomeBox"     class="rowBox centerItem"  style="display:none;">'),this.home=this.actionContainer.find("#HomeBox"),this.home.append('<img src="/assets/pos_ar/images/home.png" alt="Home" id="homeBoxIcon" >'),this.menu=this.actionContainer.find("#MenuBox"),this.menu.append('<img src="/assets/pos_ar/images/menu.png" alt="Menu" id="MenuBtn" >'),this.menu.append('<div id="menuItemsContainer"     class="columnBox">'),this.menuItemsContainer=this.actionContainer.find("#menuItemsContainer"),this.menuItemsContainer.append('<div id="posInvoiceMenuItem" class="menuItem">Recent POS Invoices</div>'),this.menuItemsContainer.append('<div id="closePosMenuItem"   class="menuItem">Close the POS</div>'),this.menuItemsContainer.append('<div id="settingMenuItem"    class="menuItem">Setting</div>'),this.pos_invoices=this.menuItemsContainer.find("#posInvoiceMenuItem"),this.close_pos=this.menuItemsContainer.find("#closePosMenuItem"),this.setting=this.menuItemsContainer.find("#settingMenuItem"),this.customerBox=this.actionContainer.find("#CustomerBox"),this.customerBox.append('<select  id="CustomerInput" placeHolder="Enter the customer"></select>'),this.customer_selecte=this.customerBox.find("#CustomerInput"),this.customerBox.append('<div id="syncBtn" class="Synced">Sync</div>'),this.sync_btn=this.customerBox.find("#syncBtn")}setCustomersInList(){let e=document.getElementById("CustomerInput");e.innerHTML="",this.customers_list.forEach(t=>{let i=document.createElement("option");i.value=t.name,i.textContent=t.customer_name,e.appendChild(i)})}hideActionBar(){this.customerBox.css("display","none"),this.home.css("display","flex"),this.actionContainer.css("flex-direction","row-reverse")}showActionBar(){this.customerBox.css("display","flex"),this.home.css("display","none"),this.actionContainer.css("flex-direction","row")}setListeners(){this.customerBox.find("#syncBtn").on("click",e=>{this.on_sync()}),this.customerBox.find("#CustomerInput").on("input",e=>{let t=e.target.value;this.selected_customer=t,console.log("customer : ",t)}),this.close_pos.on("click",e=>{this.on_close_pos()}),this.pos_invoices.on("click",e=>{this.on_history_click()}),this.menu.on("click",e=>{this.show_menu?(this.show_menu=!this.show_menu,this.menuItemsContainer.css("visibility","hidden"),this.menuItemsContainer.css("opacity","0")):(this.show_menu=!this.show_menu,this.menuItemsContainer.css("visibility","visible"),this.menuItemsContainer.css("opacity","1"))}),this.home.on("click",e=>{console.log("we should go home!")})}setSynced(){this.sync_btn.addClass("Synced"),this.sync_btn.removeClass("NotSynced")}setNotSynced(){this.sync_btn.addClass("NotSynced"),this.sync_btn.removeClass("Synced")}};pos_ar.PointOfSale.pos_selected_item_cart=class{constructor(e,t,i,s,n,a,o,l,r){this.wrapper=e,this.selected_item_maps=t,this.selected_tab=i,this.selected_item=s,this.selected_field=n,this.on_key_pressed=l,this.on_checkout_click=r,this.on_selected_item_click=a,this.on_tab_click=o,this.counter=1,this.start_work()}start_work(){this.prepare_selected_item_cart(),this.setButtonsListeners(),this.setListener()}prepare_selected_item_cart(){this.wrapper.append('<div id="tabs"    class="rowBox"><div id="tabs_container" class="rowBox"></div></div>'),this.wrapper.append('<div id="CartBox" class="columnBox"></div>'),this.tabs_bar=this.wrapper.find("#tabs"),this.tabs_container=this.tabs_bar.find("#tabs_container"),this.cartBox=this.wrapper.find("#CartBox"),this.tabs_container.append('<div class="tab selected">C1</div>'),this.tabs_bar.append('<div id="addTabBtn" class="tab unselected">+</div>'),this.add_tab_button=this.tabs_bar.find("#addTabBtn"),this.cartBox.append('<div id="CartBoxTopBar" class=" rowBox align_center  row_sbtw"><div>'),this.cartBox.append('<div id="cartHeader" class="rowBox row_sbtw align_center"></div>'),this.cartBox.append('<div id="selectedItemsContainer" class="columnBox"></div>'),this.cartBox.append('<div id="cartFooter" class="columnBox"></div>'),this.cartTopBar=this.cartBox.find("#CartBoxTopBar"),this.cartTopBar.append('<h4 class="CartTitle">Item Cart</h4>'),this.cartTopBar.append('<div id="selectedItemsPriceListInput"></div>'),this.priceListInput=this.cartTopBar.find("#selectedItemsPriceListInput"),this.priceListInput.append('<input list="PriceList"  id="PriceListInput" name="PriceList" placeHolder="Choice a Price list">'),this.priceListInput.append(' <datalist id="PriceList"></datalist>'),this.cartHeader=this.cartBox.find("#cartHeader"),this.cartHeader.append("<div><h6>Item</h6></div>"),this.cartHeader.append('<div id="cartHeaderTitles" class="rowBox"></div>'),this.cartHeaderTitles=this.cartHeader.find("#cartHeaderTitles"),this.cartHeaderTitles.append('<div id="quantityTitle"><h6>Quantity</h6></div>'),this.cartHeaderTitles.append('<div id="amountTitle">  <h6>Amount  </h6></div>'),this.selectedItemContainer=this.cartBox.find("#selectedItemsContainer"),this.cartFooter=this.cartBox.find("#cartFooter"),this.cartFooter.append('<div id="cartDetails" class="columnBox"></div>'),this.cartFooter.append('<div id="editSelectedItemCart"></div>'),this.cartFooter.append('<button type="button" id="checkoutBtn"> Checkout </button>'),this.cartDetails=this.cartFooter.find("#cartDetails"),this.cartDetails.append('<div id="discount" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="totalQuantity" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="netTotal" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="grandTotal" class="rowBox align_center row_sbtw"></div>'),this.discount=this.cartDetails.find("#discount"),this.discount.append('<div id="addDiscountTitle">Add Discount</div>'),this.discount.append('<div id="addDiscountValue"></div>'),this.totalQuantity=this.cartDetails.find("#totalQuantity"),this.totalQuantity.append('<div id="totalQuantityTitle">Total Quantity</div>'),this.totalQuantity.append('<div id="totalQuantityValue">0</div>'),this.netTotal=this.cartDetails.find("#netTotal"),this.netTotal.append('<div id="netTotalTitle">Net Total</div>'),this.netTotal.append('<div id="netTotalValue">0.00</div>'),this.grandTotal=this.cartDetails.find("#grandTotal"),this.grandTotal.append('<div id="grandTotalTitle">Grand Total</div>'),this.grandTotal.append('<div id="grandTotalValue">0.00</div>'),this.editSelectedItem=this.cartFooter.find("#editSelectedItemCart"),this.editSelectedItem.append('<div class="grid-container">'),this.buttonsContainer=this.editSelectedItem.find(".grid-container"),this.buttonsContainer.append('<button id="key_1"        class="grid-item">1</button>'),this.buttonsContainer.append('<button id="key_2"        class="grid-item">2</button>'),this.buttonsContainer.append('<button id="key_3"        class="grid-item">3</button>'),this.buttonsContainer.append('<button id="key_quantity" class="grid-item">Quantity</button>'),this.buttonsContainer.append('<button id="key_4"        class="grid-item">4</button>'),this.buttonsContainer.append('<button id="key_5"        class="grid-item">5</button>'),this.buttonsContainer.append('<button id="key_6"        class="grid-item">6</button>'),this.buttonsContainer.append('<button id="key_rate"     class="grid-item">Rate</button>'),this.buttonsContainer.append('<button id="key_7"        class="grid-item">7</button>'),this.buttonsContainer.append('<button id="key_8"        class="grid-item">8</button>'),this.buttonsContainer.append('<button id="key_9"        class="grid-item">9</button>'),this.buttonsContainer.append('<button id="key_discount" class="grid-item">Discount</button>'),this.buttonsContainer.append('<button id="key_point"    class="grid-item">.</button>'),this.buttonsContainer.append('<button id="key_0"        class="grid-item">0</button>'),this.buttonsContainer.append('<button id="key_delete"   class="grid-item">Delete</button>'),this.buttonsContainer.append('<button id="key_remove"   class="grid-item" style="color:red;font-weight:700;">Remove</button>'),this.checkoutBtn=this.cartFooter.find("#checkoutBtn"),this.checkoutBtn.on("mousedown",e=>{this.on_checkout_click()})}refreshTabs(){this.tabs_container.empty();for(let e of this.selected_item_maps.keys())e==this.selected_tab.tabName?this.tabs_container.append(`<div class="tab selected">${e}</div>`):this.tabs_container.append(`<div class="tab">${e}</div>`);this.tabs_container.find(".tab").on("click",e=>{let t=$(e.target).text();this.selected_tab.tabName=t,this.refreshTabs(),this.refreshSelectedItem(),this.calculateNetTotal(),this.calculateQnatity(),this.calculateGrandTotal(),this.on_tab_click(t),console.log("clicked tab ==> ",t)})}refreshSelectedItem(){let e=document.getElementById("selectedItemsContainer");e.innerHTML="",this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(t=>{let i=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div"),a=document.createElement("h5"),o=document.createElement("div"),l=document.createElement("div");if(t.image){let r=document.createElement("img");r.src=t.image,r.classList.add("selectedItemImage"),s.appendChild(r)}else{let r=document.createElement("div"),c=document.createElement("div");r.classList.add("selectedItemImage","rowBox","centerItem"),c.textContent=t.name[0],r.appendChild(c),s.appendChild(r)}a.textContent=t.name,a.classList.add("selectedItemName"),s.appendChild(a),o.textContent=t.qty,o.classList.add("itemQuantity"),n.appendChild(o),l.textContent=t.rate-t.discount_amount+" DA",l.classList.add("itemPrice"),n.appendChild(l),s.classList.add("rowBox","align_center","leftGroup"),i.appendChild(s),n.classList.add("rowBox","align_center","rightGroup"),i.appendChild(n),i.classList.add("rowBox","align_center","row_sbtw","ItemElement","pointer"),t.name==this.selected_item.name&&i.classList.add("selected"),i.addEventListener("click",r=>{console.log("we are click"),this.makeItemHighlight(i),this.on_selected_item_click(t)}),e.appendChild(i)}),this.calculateNetTotal(),this.calculateQnatity(),this.calculateGrandTotal()}createNewTab(){this.counter+=1;let e=frappe.model.get_new_doc("POS Invoice");e.items=[],this.selected_item_maps.set(`C${this.counter}`,e),this.selected_tab.tabName=`C${this.counter}`,this.refreshTabs(),this.refreshSelectedItem()}showKeyboard(){this.editSelectedItem.css("display","flex")}hideKeyboard(){this.editSelectedItem.css("display","none")}setKeyboardOrientation(e){let t=this.cartDetails.find("#discount"),i=this.cartDetails.find("#totalQuantity"),s=this.cartDetails.find("#netTotal"),n=this.cartDetails.find("#grandTotal");e=="landscape"?(this.cartDetails.css("display","flex"),this.cartDetails.addClass("rowBox align_center"),this.cartDetails.removeClass("columnBox"),t.css("display","none"),i.css("font-size","smaller"),s.css("font-size","smaller"),n.css("font-size","small"),n.css("font-weight","500")):(this.cartDetails.addClass("columnBox"),this.cartDetails.removeClass("rowBox"),t.css("display","flex"),i.css("font-size","small"),s.css("font-size","small"),n.css("font-size","larger"),n.css("font-weight","700"))}makeSelectedButtonHighlighted(){let e=this.buttonsContainer.find("#key_quantity"),t=this.buttonsContainer.find("#key_rate"),i=this.buttonsContainer.find("#key_discount");this.selected_field.field_name=="quantity"?(e.addClass("selected"),t.removeClass("selected"),i.removeClass("selected")):this.selected_field.field_name=="rate"?(e.removeClass("selected"),t.addClass("selected"),i.removeClass("selected")):this.selected_field.field_name=="discount_percentage"?(e.removeClass("selected"),t.removeClass("selected"),i.addClass("selected")):(e.removeClass("selected"),t.removeClass("selected"),i.removeClass("selected"))}hideCart(){this.tabs_bar.css("display","none"),this.cartBox.css("display","none")}setButtonsListeners(){let e=this.buttonsContainer.find("#key_0"),t=this.buttonsContainer.find("#key_1"),i=this.buttonsContainer.find("#key_2"),s=this.buttonsContainer.find("#key_3"),n=this.buttonsContainer.find("#key_4"),a=this.buttonsContainer.find("#key_5"),o=this.buttonsContainer.find("#key_6"),l=this.buttonsContainer.find("#key_7"),r=this.buttonsContainer.find("#key_8"),c=this.buttonsContainer.find("#key_9"),d=this.buttonsContainer.find("#key_quantity"),f=this.buttonsContainer.find("#key_discount"),g=this.buttonsContainer.find("#key_rate"),y=this.buttonsContainer.find("#key_remove"),m=this.buttonsContainer.find("#key_delete"),u=this.buttonsContainer.find("#key_point");[e,t,i,s,n,a,o,l,r,c,d,f,g,y,m,u].forEach(_=>{_.on("mousedown",v=>{v.preventDefault();let p=_.text();isNaN(p)?p=="."?this.on_key_pressed("addToField",_.text()):p=="Quantity"?this.on_key_pressed("quantity",null):p=="Rate"?this.on_key_pressed("rate",null):p=="Discount"?this.on_key_pressed("discount",null):p=="Remove"?this.on_key_pressed("remove",null):p=="Delete"&&this.on_key_pressed("delete",null):this.on_key_pressed("addToField",_.text())})})}setListener(){this.add_tab_button.on("mousedown",e=>{this.createNewTab()})}calculateNetTotal(){let e=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(i=>{e+=i.rate*i.qty});let t=document.getElementById("netTotalValue");t.textContent=e}calculateQnatity(){let e=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(i=>{e+=i.qty});let t=document.getElementById("totalQuantityValue");t.textContent=e}calculateGrandTotal(){let e=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(i=>{e+=i.qty*i.rate});let t=document.getElementById("grandTotalValue");t.textContent=e}makeItemHighlight(e){document.getElementById("selectedItemsContainer").querySelectorAll(".selected").forEach(s=>{s.classList.remove("selected")}),e.classList.add("selected")}cleanHeighlight(){document.getElementById("selectedItemsContainer").querySelectorAll(".selected").forEach(i=>{i.classList.remove("selected")})}};pos_ar.PointOfSale.pos_item_details=class{constructor(e,t,i,s,n,a,o,l,r){console.log("hello from item_details 0"),this.wrapper=e,this.warehouse=t,this.price_lists=i,this.item_prices=s,this.selected_item=a,this.selected_field=o,this.on_input=l,this.on_close_cart=r,this.bin_list=n,console.log("start with : ",t),this.start_the_work()}start_the_work(){this.prepare_item_details_cart(),this.setDetailsFieldsListeners()}prepare_item_details_cart(){this.wrapper.append('<div id="itemDetailsCart" class="columnBox align_center"><div>'),this.item_details_cart=this.wrapper.find("#itemDetailsCart"),this.item_details_cart.append('<div id="itemDetailsCartHeader" class="rowBox header align_center row_sbtw"></div>'),this.cart_header=this.item_details_cart.find("#itemDetailsCartHeader"),this.cart_header.append('<h4 class="CartTitle">Item Details</h4>'),this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="itemDetailsCartXBtn" class="xBtn">'),this.close_btn=this.cart_header.find("#itemDetailsCartXBtn").on("click",e=>{this.on_close_cart()}),this.item_details_cart.append('<div id="itemDetailsHeader" class="rowBox"></div>'),this.header_details=this.item_details_cart.find("#itemDetailsHeader"),this.header_details.append('<div id="detailsItemImage" class="rowBox centerItem"></div>'),this.header_details.append('<div id="price_and_name" class="columnBox"></div>'),this.price_and_name_details=this.header_details.find("#price_and_name"),this.price_and_name_details.append('<div id="detailsItemName" class="rowBox align_center"></div>'),this.price_and_name_details.append('<div id="detailsItemGroupWarhouseContainer" class="rowBox align_center row_sa"></divr>'),this.item_group_warehouse_details=this.price_and_name_details.find("#detailsItemGroupWarhouseContainer"),this.item_group_warehouse_details.append('<div id="detailsItemGroup" class="rowBox align_center">Group : ...</div>'),this.item_group_warehouse_details.append('<div id="detailsItemWarehouse" class="rowBox align_center">Warehouse : ...</div>'),this.item_details_cart.append('<div id="itemDetailsAll"  class="rowBox"></div>'),this.details_all=this.item_details_cart.find("#itemDetailsAll"),this.details_all.append('<div id="itemDetails_C1" class="columnBox"></div>'),this.c1=this.details_all.find("#itemDetails_C1"),this.c1.append('<div class="columnBox"><label for="itemDetailsQuantityInput">Quantity</label><input type="float" id="itemDetailsQuantityInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsRateInput">Rate</label><input type="float" id="itemDetailsRateInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsDiscountInput">Discount (%)</label><input type="float" id="itemDetailsDiscountInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsAvailableInput">Available Qty at Warehouse</label><input type="float" id="itemDetailsAvailableInput" disabled></div>'),this.details_all.append('<div id="itemDetails_C2" class="columnBox"></div>'),this.c2=this.details_all.find("#itemDetails_C2"),this.c2.append('<div class="columnBox"><label for="itemDetailsUomInput">UOM *</label><input type="text" id="itemDetailsUomInput"  disabled></div>'),this.c2.append('<div class="columnBox"><label for="detailsRateWithDescount">Discounted Rate</label>  <input type="text" id="discountedRateInput" disabled>  </div>'),this.c2.append('<div class="columnBox hideMe"><label for="detailsPriceList">Price List *</label><input list="detailsPriceList" id="detailsItemPriceListInput" class ="rowBox align_center pointerCursor"><datalist id="detailsPriceList"><option>fetching Price Lists ...</option></datalist></div>'),this.c2.append('<div class="columnBox"><label for="itemDetailsDiscountMontantInput">Discount (montant)</label><input type="float" id="itemDetailsDiscountMontantInput" class="pointerCursor"></div>'),this.c2.append('<div class="columnBox"><label for="itemDetailsPriceListRateInput">Price List Rate</label><input type="text" id="itemDetailsPriceListRateInput" disabled></div>')}refreshDate(e){var m,u;let t=document.getElementById("detailsItemImage"),i=document.getElementById("detailsItemName"),s=document.getElementById("detailsItemWarehouse"),n=document.getElementById("detailsItemGroup"),a=document.getElementById("itemDetailsQuantityInput"),o=document.getElementById("itemDetailsRateInput"),l=document.getElementById("discountedRateInput"),r=document.getElementById("itemDetailsDiscountInput"),c=document.getElementById("itemDetailsDiscountMontantInput"),d=document.getElementById("itemDetailsAvailableInput"),f=document.getElementById("itemDetailsUomInput"),g=document.getElementById("detailsItemPriceListInput"),y=document.getElementById("itemDetailsPriceListRateInput");if(e.image){let h=document.createElement("img");h.src=e.image,t.innerHTML="",t.appendChild(h)}else{let h=document.createElement("div");h.textContent=e.item_name[0],h.style.fontSize="xx-large",h.style.fontWeight="700",t.innerHTML="",t.appendChild(h)}i.textContent=e.item_name,i.classList.add("rowBox","align_center"),a.value=e.qty,o.value=e.rate,l.value=e.rate-e.discount_amount,c.value=(m=e.discount_amount)!=null?m:0,r.value=(u=e.discount_percentage)!=null?u:0,d.value=this.getQtyInWarehouse(e.name,this.warehouse),f.value=e.stock_uom,g.value=this.price_lists[0].price_list_name,s.textContent="Warehouse : "+this.warehouse,n.textContent="Item Group : "+e.item_group,y.value=this.getItemPrice(e.name)+"DA",console.log("end ref"),this.makeSelectedFieldHighlighted()}show_cart(){this.item_details_cart.css("display","flex")}hide_cart(){this.item_details_cart.css("display","none")}makeSelectedFieldHighlighted(){this.selected_field.field_name=="quantity"?(this.c1.find("#itemDetailsQuantityInput").addClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected")):this.selected_field.field_name=="rate"?(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").addClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected")):this.selected_field.field_name=="discount_percentage"?(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").addClass("selected")):(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected"))}requestFocus(e){e=="quantity"?this.c1.find("#itemDetailsQuantityInput").focus():e=="rate"?this.c1.find("#itemDetailsRateInput").focus():e=="discount_percentage"?this.c1.find("#itemDetailsDiscountInput").focus():e=="discount_amount"&&this.c1.find("#itemDetailsDiscountMontantInput").focus()}addToField(e,t){console.log("field : ",e,"value : ",t),e=="quantity"?this.c1.find("#itemDetailsQuantityInput").val((i,s)=>t=="."&&s.includes(".")?s:s+t):e=="rate"?this.c1.find("#itemDetailsRateInput").val((i,s)=>t=="."&&s.includes(".")?s:s+t):e=="discount_percentage"?this.c1.find("#itemDetailsDiscountInput").val((i,s)=>t=="."&&s.includes(".")?s:s+t):e=="discount_amount"&&this.c1.find("#itemDetailsDiscountInput").val((i,s)=>t=="."&&s.includes(".")?s:s+t)}deleteCharacter(){let e=this.selected_field.field_name,t=0;if(e=="quantity"){let i=this.c1.find("#itemDetailsQuantityInput"),s=i[0].selectionStart;console.log(i.val()),i.val((n,a)=>(console.log("length : ",a," cursor : ",s),a.length<0||a.length==1?(t=0,0):s==0?(t=a,a):s==a.length?(t=a.slice(0,s-1),a.slice(0,s-1)):(t=a.slice(0,s-1)+a.slice(s),a.slice(0,s-1)+a.slice(s)))),setTimeout(()=>{i[0].setSelectionRange(s-1,s-1),i[0].focus()},0)}if(e=="rate"){let i=this.c1.find("#itemDetailsRateInput"),s=i[0].selectionStart;i.val((n,a)=>a.length<0||a.length==1?(t=0,0):s==0?(t=a,a):s==a.length?(t=a.slice(0,s-1),a.slice(0,s-1)):(t=a.slice(0,s-1)+a.slice(s),a.slice(0,s-1)+a.slice(s))),setTimeout(()=>{i[0].setSelectionRange(s-1,s-1),i[0].focus()},0)}if(e=="discount_percentage"){let i=this.c1.find("#itemDetailsDiscountInput"),s=i[0].selectionStart;i.val((n,a)=>a.length<0||a.length==1?(t=0,0):s==0?(t=a,a):s==a.length?(t=a.slice(0,s-1),a.slice(0,s-1)):(t=a.slice(0,s-1)+a.slice(s),a.slice(0,s-1)+a.slice(s))),setTimeout(()=>{i[0].setSelectionRange(s-1,s-1),i[0].focus()},0)}return console.log("we reach to here "),t}setDetailsFieldsListeners(){this.quantityInput=this.c1.find("#itemDetailsQuantityInput"),this.rateInput=this.c1.find("#itemDetailsRateInput"),this.discountInput=this.c1.find("#itemDetailsDiscountInput"),this.discountMontantInput=this.c2.find("#itemDetailsDiscountMontantInput"),this.quantityInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||t[t.length-1]==" "||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=parseFloat(this.quantityInput.val());if(isNaN(i)){console.warn("Invaide Quantity value =>",this.quantityInput.val());return}else i<=0&&(i=0);this.on_input("input","quantity",i)}),this.quantityInput.on("focus",e=>{this.on_input("focus","quantity",null)}),this.quantityInput.on("blur",e=>{this.on_input("blur","quantity",null)}),this.rateInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=parseFloat(this.rateInput.val());if(console.log("new rate : ",i),isNaN(i)){console.warn("Invalide Rate value");return}this.on_input("input","rate",i)}),this.rateInput.on("focus",e=>{this.on_input("focus","rate",null)}),this.rateInput.on("blur",e=>{this.on_input("blur","rate",null)}),this.discountInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=this.discountInput.val();if(console.log("the new value ",i),isNaN(i)){console.warn("Invalide discount value");return}i<100?this.on_input("input","discount_percentage",i):(e.target.value=100,this.on_input("input","discount_percentage",100))}),this.discountInput.on("focus",e=>{this.on_input("focus","discount_percentage",null)}),this.discountInput.on("blur",e=>{this.on_input("blur","discount_percentage",null)}),this.discountMontantInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=this.discountMontantInput.val();if(isNaN(i)){console.warn("Invalide discount value");return}this.on_input("input","discount_amount",i)}),this.discountMontantInput.on("focus",e=>{console.log("we are here"),this.on_input("focus","discount_amount",null)}),this.discountMontantInput.on("blur",e=>{this.on_input("blur","discount_amount",null)})}getItemPrice(e){let t=this.item_prices.find(i=>i.item_code==e);return t?t.price_list_rate:0}getQtyInWarehouse(e,t){let i=this.bin_list.find(s=>s.item_code==e&&s.warehouse==t);return i?i.actual_qty:0}};pos_ar.PointOfSale.pos_payment_cart=class{constructor(e,t,i,s,n,a,o,l){this.wrapper=e,this.selected_item_map=t,this.selected_tab=i,this.selected_payment_method=s,this.invoice_data=n,this.on_close_cart=a,this.on_complete=o,this.on_input=l,this.start_work()}start_work(){this.prepare_payment_cart(),this.calculateGrandTotal(),this.setListeners(),console.log("helloooooooooooooooooooooooooooo ")}prepare_payment_cart(){this.wrapper.append('<div id="paymentMethodCart" class="columnBox align_center"></div>'),this.cart=this.wrapper.find("#paymentMethodCart"),this.cart.append('<div id="paymentMethodCartHeader" class="rowBox header align_center row_sbtw"></div>'),this.cart.append('<div id="paymentMethodContent" class="columnBox align_center"></div>'),this.cart.append('<div id="paymentMethodCartFooter" class="columnBox align_center"></div>'),this.cart_header=this.cart.find("#paymentMethodCartHeader"),this.cart_content=this.cart.find("#paymentMethodContent"),this.cart_footer=this.cart.find("#paymentMethodCartFooter"),this.cart_header.append('<h4 class="CartTitle">Item Details</h4>'),this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="paymentMethodCartXBtn" class="xBtn">'),this.cart_header.find("#paymentMethodCartXBtn").on("click",e=>{this.on_close_cart()}),this.cart_content.append('<div id="paymentContentTopSection" class="rowBox"></div>'),this.cart_content.append('<div id="paymentContentBottomSection" class="columnBox"></div>'),this.cart_content_top_section=this.cart_content.find("#paymentContentTopSection"),this.cart_content_bottom_section=this.cart_content.find("#paymentContentBottomSection"),this.cart_content_top_section.append('<div id="cashBox" class="paymentMethodBox"><div id="cashBoxTitle" class="title">Cash</div><input type="float" id="cachInput" value="0"  ></div>'),this.cart_content_top_section.append('<div id="paymentOnTimeBox" class="paymentMethodBox"><div id="paymentOnTimeBoxTitle" class="title">On Time</div><input type="float" id="paymentOnTimeInput" value="0" ></div>'),this.cart_content_top_section.append('<div id="redeemLoyaltyPoints" class="paymentMethodBox"><div id="redeemLoyaltyPointsTitle" class="title">Redeem Loyalty Points</div><input type="float" id="RedeemLayoutPointsInput" value="0" disabled></div>'),this.cashBox=this.cart_content_top_section.find("#cashBox"),this.onTimeBox=this.cart_content_top_section.find("#paymentOnTimeBox"),this.redeemLoyaltyBox=this.cart_content_top_section.find("#redeemLoyaltyPoints"),this.cart_content_bottom_section.append("<h4>Additional Information</h4>"),this.cart_footer.append('<div id="paymentDetailsContainer" class="rowBox align_center"></div>'),this.cart_footer.append('<button type="button" id="completeOrderBtn">Complete Order</button>'),this.payment_details=this.cart_footer.find("#paymentDetailsContainer"),this.payment_details.append('<div class="columnBox"><div id="paymentGrandTotalTitle" class="rowBox centerItem">Grand Total</div><div id="paymentGrandTotalValue" class="rowBox centerItem"></div></div>'),this.payment_details.append("<hr>"),this.payment_details.append('<div id="paymentPaidAmount" class="columnBox"><div id="paymentPaidAmountTitle" class="rowBox centerItem">Paid Amount</div><div id="paimentPaidAmountValue"  class="rowBox centerItem"> 0 DA </div></div>'),this.payment_details.append("<hr>"),this.payment_details.append(`<div id="paymentToChange" class="columnBox"><div id="paimentToChangeTitle" class="rowBox centerItem">To Change</div><div id="paimentToChangeValue"  class="rowBox centerItem"> ${this.toChange}DA </div></div>`)}showCart(){this.cart.css("display","flex"),this.clearData()}hideCart(){this.cart.css("display","none")}clearData(){this.invoice_data.grandTotal=0,this.invoice_data.paidAmount=0,this.invoice_data.toChange=0,this.cashBox.find("#cachInput").val(0),this.calculateGrandTotal(),this.calculateToChange(),this.refreshPaidAmount()}refreshData(){console.log("refreshing data"),this.cashBox.find("#cachInput").val(this.invoice_data.paidAmount),this.calculateGrandTotal(),this.calculateToChange(),this.refreshPaidAmount()}setListeners(){this.cashBox.on("click",e=>{this.selected_payment_method.methodName="cash",this.cashBox.addClass("selected"),this.onTimeBox.removeClass("selected"),this.redeemLoyaltyBox.removeClass("selected"),this.invoice_data.paidAmount=this.cashBox.find("#cachInput").val(),this.refreshPaidAmount()}),this.onTimeBox.on("click",e=>{this.selected_payment_method.methodName="onTime",this.cashBox.removeClass("selected"),this.onTimeBox.addClass("selected"),this.redeemLoyaltyBox.removeClass("selected"),this.invoice_data.paidAmount=this.onTimeBox.find("#paymentOnTimeInput").val(),this.refreshPaidAmount()}),this.redeemLoyaltyBox.on("click",e=>{this.selected_payment_method.methodName="redeemLoyalty",this.cashBox.removeClass("selected"),this.onTimeBox.removeClass("selected"),this.redeemLoyaltyBox.addClass("selected"),this.invoice_data.paidAmount=0,this.refreshPaidAmount()}),this.cashBox.find("#cachInput").on("input",e=>{console.log("we are here 1:)");let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||t[t.length-1]==" "||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t,this.invoice_data.paidAmount=e.target.value,this.refreshPaidAmount(),this.calculateToChange(),console.log("input",e.target.value)}),this.cashBox.find("#cachInput").on("focus",e=>{this.on_input("focus","cash",null)}),this.onTimeBox.find("#paymentOnTimeInput").on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||t[t.length-1]==" "||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t,this.invoice_data.paidAmount=e.target.value,this.refreshPaidAmount(),this.calculateToChange(),console.log("input",e.target.value)}),this.redeemLoyaltyBox.find("#RedeemLayoutPointsInput").on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||t[t.length-1]==" "?e.target.value=t.slice(0,-1):isNaN(t[t.length-1])?(console.log("===}> ",t[t.length-1]),e.target.value=t.slice(0,-1)):e.target.value=t,console.log("input",e.target.value)}),this.cart_footer.find("#completeOrderBtn").on("click",e=>{if(console.log("grand total ==> ",this.invoice_data.grandTotal,"the paid amount ==> ",this.invoice_data.paidAmount),this.invoice_data.grandTotal>this.invoice_data.paidAmount){console.log("here we go 1"),frappe.warn("Paid amount is less than the Total!","Please set the correct paid amount value",()=>{},"Done",!1);return}else if(this.invoice_data.grandTotal==0){console.log("here we go 2"),frappe.warn("No item","Please select some items.",()=>{},"Done",!1);return}frappe.confirm("Submit the invoice ?",()=>{this.on_complete()},()=>{})})}handleInput(e){this.cashBox.find("#cachInput").val().includes(".")&&e=="."||(this.invoice_data.paidAmount+=e,this.refreshData())}calculateGrandTotal(){console.log("invoice data : ",this.invoice_data),this.invoice_data.grandTotal=0,this.selected_item_map.get(this.selected_tab.tabName).items.forEach(e=>{this.invoice_data.grandTotal+=e.qty*e.rate}),this.payment_details.find("#paymentGrandTotalValue").text(`${this.invoice_data.grandTotal} DA`),this.generateProposedPaidAmount(this.invoice_data.grandTotal)}calculateToChange(){this.invoice_data.toChange=this.invoice_data.paidAmount-this.invoice_data.grandTotal,this.payment_details.find("#paimentToChangeValue").text(`${this.invoice_data.toChange} DA`)}refreshPaidAmount(){this.payment_details.find("#paimentPaidAmountValue").text(`${this.invoice_data.paidAmount} DA`)}generateProposedPaidAmount(e){let t=[10,20,50,100,200,500,1e3,2e3],i=0,s=7;for(;i<e;)i+=t[s];console.log("counter : ",i)}};pos_ar.PointOfSale.pos_history=class{constructor(e,t){this.wrapper=e,this.db=t,this.localPosInvoice={lastTime:null,pos_invoices:[]},this.filter="",this.filtered_pos_list=[],this.selected_pos={},this.start_work()}start_work(){this.prepare_history_cart(),this.db.getAllPosInvoice(e=>{console.log("the result ::::",e),this.localPosInvoice.pos_invoices=e,this.filtered_pos_list=e,this.filtered_pos_list.length==0?this.selected_pos=null:this.selected_pos=structuredClone(this.filtered_pos_list[0]),console.log("selected pos ==> ",this.selected_pos),this.refreshData()},e=>{console.log(e)}),this.setListener()}prepare_history_cart(){this.wrapper.find("#LeftSection").append('<div id="historyLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="historyRightContainer" class="columnBox"></div>'),this.left_container=this.wrapper.find("#historyLeftContainer"),this.right_container=this.wrapper.find("#historyRightContainer"),this.left_container.append('<div id="PosContentHeader" class="rowBox" ><div class="c1 columnBox"><div id="posCustomer">Customer</div><div id="posSoldBy">Sold by : User</div></div><div class="c2 columnBox"><div id="posCost">0,0000 DA</div><div id="posId">ACC-PSINV-2024-ID</div><div id="posStatus">POS Status</div></div></div>'),this.pos_header=this.left_container.find("#PosContentHeader"),this.left_container.append('<div id="posContent"></div>'),this.pos_content=this.left_container.find("#posContent"),this.pos_content.append('<div id="posItemContainer"><div class="posSectionTitle">Items</div><div id="posItemList"></div></div>'),this.itemContainer=this.pos_content.find("#posItemContainer"),this.itemList=this.itemContainer.find("#posItemList"),this.pos_content.append('<div id="posTotalsContainer"><div class="posSectionTitle">Totals</div><div id="posTotalList"></div></div>'),this.totalsContainer=this.pos_content.find("#posTotalsContainer"),this.totalList=this.itemContainer.find("#posTotalList"),this.pos_content.append('<div id="posPaymentsContainer"><div class="posSectionTitle">Payments</div><div id="posMethodList"></div></div>'),this.paymentsContainer=this.pos_content.find("#posPaymentsContainer"),this.methodList=this.itemContainer.find("#posMethodList"),this.left_container.append('<div id="posActionsContainer" class="rowBox align_content"> <div id="posPrintBtn" class="actionBtn rowBox centerItem"> Print Receipt </div>  <div id="posEmailBtn" class="actionBtn rowBox centerItem"> Email Receipt </div>   <div id="posReturnBtn" class="actionBtn rowBox centerItem"> Return </div>  </div>'),this.actionButtonsContainer=this.pos_content.find("#posActionsContainer"),this.printBtn=this.actionButtonsContainer.find("#posPrintBtn"),this.emailBtn=this.actionButtonsContainer.find("#posEmailBtn"),this.returnBtn=this.actionButtonsContainer.find("#posReturnBtn"),this.right_container.append('<div id="historyRightContainerHeader" class="rowBox align_center" ><h4 class="CartTitle">Recent Orders</h4></div>'),this.right_container.append('<div id="historyRightSearchContainer" class="rowBox align_center" ></div>'),this.search_container=this.right_container.find("#historyRightSearchContainer"),this.search_container.append('<input list="PosInvoiceTypeList" id="PosInvoiceTypeInput" placeholder="POS Invoice Type">'),this.search_container.append('<datalist id="PosInvoiceTypeList"><option value="Draft"><option value="Paid"><option value="Consolidated"></datalist>'),this.filter_input=this.search_container.find("#PosInvoiceTypeInput"),this.search_container.append('<input type="text" id="historyInput" placeholder="Search by invoice id or custumer name">'),this.right_container.append('<div id="historyRecentInvoicesContainer" ></div>'),this.right_data_container=this.right_container.find("#historyRecentInvoicesContainer")}refreshData(){this.right_data_container.html(""),console.log("refresh with : ",this.localPosInvoice.pos_invoices),this.filtered_pos_list.forEach(e=>{var d;console.log("record : ",e);let t=document.createElement("div");t.classList.add("posInvoiceContainer"),t.classList.add("columnBox"),t.classList.add("align_content");let i=document.createElement("div");i.classList.add("l1"),i.classList.add("rowBox"),i.classList.add("align_content");let s=document.createElement("div");s.classList.add("posName"),s.textContent=e.name;let n=document.createElement("div");n.classList.add("posCost"),n.textContent=(d=e.paid_amount)!=null?d:0+" DA",i.appendChild(s),i.appendChild(n);let a=document.createElement("div");a.classList.add("l2"),a.classList.add("rowBox"),a.classList.add("align_content");let o=document.createElement("div");o.classList.add("customer"),o.classList.add("rowBox"),o.classList.add("align_content");let l=document.createElement("img");l.src="/assets/pos_ar/images/customer.png",l.width=16,l.height=16,l.classList.add("customerLogo");let r=document.createElement("div");r.textContent=e.customer,r.classList.add("customerName"),o.appendChild(l),o.appendChild(r),a.appendChild(o);let c=document.createElement("div");c.textContent=e.creation_time,a.appendChild(c),t.appendChild(i),t.appendChild(a),t.addEventListener("click",()=>{this.selected_pos=e,this.refreshPosDetailsData()}),this.right_data_container.append(t)}),this.refreshPosDetailsData()}refreshPosDetailsData(){var t;console.log(" refreshing details data ",this.selected_pos),this.pos_header.find("#posCustomer").text(this.selected_pos.customer),this.pos_header.find("#posCost").text((t=this.selected_pos.paid_amount)!=null?t:0+"DA"),this.pos_header.find("#posId").text(this.selected_pos.name);let e="";this.selected_pos.docStatus==0?e="Paid":e="Consolidated",console.log("pos status : ",e),this.pos_header.find("#posStatus").text(e),this.itemList.html(""),this.selected_pos.items.forEach(i=>{this.itemList.append(`<div class="rowBox align_item">    <div class="itemName rowBox align_center">${i.item_name}</div>   <div class="itemQuantity rowBox align_center">${i.qty}</div>   <div class="itemCost rowBox align_center">${i.qty*i.rate} DA</div>  </div>`)})}show_cart(){this.left_container.css("display","flex"),this.right_container.css("display","flex")}hide_cart(){this.left_container.css("display","none"),this.right_container.css("display","none")}setListener(){this.filter_input.on("input",e=>{console.log(e.target.value);let t=e.target.value;this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(i=>t==""?!0:t=="Paid"?i.docstatus==0:t=="Consolidated"?i.docstatus==1:!1),console.log("we should refresh the data ::: ",this.filtered_pos_list),this.refreshData()})}};pos_ar.PointOfSale.pos_db=class{constructor(){this.dbName="PosDb",this.dbVersion=14,this.db=null,this.openDatabase()}openDatabase(){let t=window.indexedDB.open(this.dbName,this.dbVersion);t.onerror=i=>{console.log(" there is an error : ",t.error)},t.onsuccess=i=>{this.db=i.target.result,this.setupDatabase(),console.log(" the db is opend successefully : ",i.target.result)},t.onupgradeneeded=i=>{let s=i.target.result;s.objectStoreNames.contains("Customer")||s.createObjectStore("Customer",{keyPath:"name"}),s.objectStoreNames.contains("Item Group")||s.createObjectStore("Item Group",{keyPath:"name"}),s.objectStoreNames.contains("Item")||s.createObjectStore("Item",{keyPath:"name"}),s.objectStoreNames.contains("Item Price")||s.createObjectStore("Item Price",{keyPath:"name"}),s.objectStoreNames.contains("Price List")||s.createObjectStore("Price List",{keyPath:"name"}),s.objectStoreNames.contains("Warehouse")||s.createObjectStore("Warehouse",{keyPath:"name"}),s.objectStoreNames.contains("POS Profile")||s.createObjectStore("POS Profile",{keyPath:"name"}),s.objectStoreNames.contains("Bin")||s.createObjectStore("Bin",{keyPath:"name"}),s.objectStoreNames.contains("POS Invoice")||s.createObjectStore("POS Invoice",{autoIncrement:!0})}}setupDatabase(){this.db.onerror=t=>{var i;console.error(`Database error: ${(i=t.target.error)==null?void 0:i.message}`)}}savePosInvoice(t,i,s){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").add(t);o.onsuccess=l=>{i(l)},o.onerror=l=>{s(l)}}savePosInvoice(t,i,s){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").add(t);o.onsuccess=l=>{i(l)},o.onerror=l=>{s(l)}}getAllPosInvoice(t,i){let n=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice"),a=n.getAll().onsuccess=o=>{let l=o.target.result;t(l)}}};})();
//# sourceMappingURL=pos.bundle.STXO2ASZ.js.map
