(()=>{var k=Object.defineProperty;var b=Object.getOwnPropertySymbols;var x=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var C=(e,t,i)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,I=(e,t)=>{for(var i in t||(t={}))x.call(t,i)&&C(e,i,t[i]);if(b)for(var i of b(t))B.call(t,i)&&C(e,i,t[i]);return e};pos_ar.PointOfSale.Controller=class{constructor(e){this.wrapper=$(e).find(".layout-main-section"),this.page=e.page,this.selectedItemMaps=new Map,this.selectedItem={name:""},this.selectedField={field_name:""},this.selectedTab={tabName:""},this.selectedPaymentMethod={methodName:""},this.defaultCustomer={name:"",customer_name:""},this.defaultPriceList={name:""},this.taxes_and_charges_template=null,this.taxes_and_charges=[],this.payment_methods=[],this.POSOpeningEntry={},this.invoiceData={netTotal:0,grandTotal:0,paidAmount:0,toChange:0,discount:0},this.db=null,this.syncInput=!1,this.start_app()}async start_app(){try{this.db=await pos_ar.PointOfSale.pos_db.openDatabase(),this.settings_data=new pos_ar.PointOfSale.posSettingsData(this.db),this.dataHandler=new pos_ar.PointOfSale.FetchHandler,this.appData=new pos_ar.PointOfSale.posAppData(this.db,this.dataHandler),await this.appData.getAllData(),this.toggleKeyboardMode(!this.settings_data.settings.showItemDetails),console.log("see app data : ",this.appData.appData),this.prepare_container(),await this.prepare_app_data(),await this.checkForPOSEntry(),await this.prepare_components(),this.checkUnSyncedPos(),this.setListeners()}catch(e){console.error("halfware POS Err ==> ",e)}}async prepare_app_data(){try{await this.handleAppData();let e=frappe.model.get_new_doc("POS Invoice");e.customer=this.defaultCustomer.name,e.pos_profile=this.appData.appData.pos_profile.name,e.items=[],e.taxes_and_charges=this.appData.appData.pos_profile.taxes_and_charges,e.additional_discount_percentage=0,e.paid_amount=0,e.base_paid_amount=0,e.creation_time=frappe.datetime.now_datetime(),e.payments=this.getPaymentMethods(),e.is_pos=1,e.update_stock=1,e.docstatus=0,e.status="Draft",e.priceList=this.defaultPriceList.name;let t=new Date,[i,a,r]=t.toISOString().split("T")[0].split("-"),n=t.getHours(),o=t.getMinutes(),c=t.getMilliseconds();e.refNum=this.appData.appData.pos_profile.name+"-"+i+"-"+a+"-"+r+"-"+n+o+c,this.selectedItemMaps.set("C1",e),this.selectedTab.tabName="C1"}catch(e){throw console.error("Hlafware POS Error ==> ",e),e}}async handleAppData(){if(this.appData.appData.pos_profile==null)throw frappe.set_route("Form","POS Profile"),new Error("there is no pos profile");if(this.appData.appData.pos_profile.taxes_and_charges!=null&&this.appData.appData.pos_profile.taxes_and_charges!=""&&(this.taxes_and_charges_template=await this.dataHandler.fetchSalesTaxesAndChargesTemplate(this.appData.appData.pos_profile.taxes_and_charges),this.taxes_and_charges=this.taxes_and_charges_template.taxes),this.appData.appData.pos_profile.company!=null&&this.appData.appData.pos_profile.company!=""&&(this.company=await this.dataHandler.fetchCompany(this.appData.appData.pos_profile.company)),this.appData.appData.customers.length>0)this.defaultCustomer=structuredClone(this.appData.appData.customers[0]);else throw frappe.warn("You dont have a customer","please create a customer to continue",()=>{frappe.set_route("Form","Customer")},"Create",!1),new Error("there is no customer");if(this.appData.appData.price_lists.length>0)this.defaultPriceList.name=this.appData.appData.pos_profile.selling_price_list;else throw frappe.warn("You dont have a single price list","please create a priceList to continue",()=>{frappe.set_route("Form","Price List")},"Create",!1),new Error("there is no price list")}prepare_container(){this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/selectorBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/checkInOutCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/itemDetailsCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/paymentMethodCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/customerBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/cartBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/historyCarts.css">'),this.wrapper.append('<div id="MainContainer" class="rowBoxReverse"></div>'),this.$components_wrapper=this.wrapper.find("#MainContainer")}prepare_components(){this.set_right_and_left_sections(),this.init_item_selector(),this.init_customer_box(),this.init_selected_item(),this.init_item_details(),this.init_paymentCart(),this.init_historyCart(),this.init_checkInOutCart(),this.init_debtCart(),this.init_settingsCart()}async checkForPOSEntry(){let e=frappe.session.user,t=this.appData.appData.pos_profile.name;try{let a=(await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.check_opening_entry",args:{user:e,posProfile:t}})).message;return console.log("debuging is here"),a.length===0?(this.create_opening_voucher(),!1):(Object.assign(this.POSOpeningEntry,a[0]),!0)}catch(i){return console.error("error occured : ",i),frappe.throw("Error checking for POS Opening Entry."),!1}}create_opening_voucher(){let e=this,t=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",options:"company:company_currency",change:function(){a.fields_dict.balance_details.df.data.some(n=>{if(n.idx==this.doc.idx)return n.opening_amount=this.value,a.fields_dict.balance_details.grid.refresh(),!0})}}],i=()=>{let n=a.fields_dict.pos_profile.get_value();console.log("pos debuging ===> ",n),n&&frappe.db.get_doc("POS Profile",n).then(({payments:o})=>{a.fields_dict.balance_details.df.data=[],this.payment_methods=o,o.forEach(c=>{let{mode_of_payment:l}=c;a.fields_dict.balance_details.df.data.push({mode_of_payment:l,opening_amount:"0"})}),a.fields_dict.balance_details.grid.refresh()})},a=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>r(),onchange:()=>i()},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:t}],primary_action:async function({company:n,pos_profile:o,balance_details:c}){if(!c.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");c=c.filter(h=>h.mode_of_payment);let l="erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher",d=await frappe.call({method:l,args:{pos_profile:o,company:n,balance_details:c},freeze:!0});!d.exc&&e.prepare_app_data(d.message),Object.assign(e.POSOpeningEntry,{name:d.message.name,pos_profile:d.message.pos_profile,period_start_date:d.message.period_start_date,company:d.message.company}),a.hide()},primary_action_label:__("Submit")});a.show();let r=()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:a.fields_dict.company.get_value()}})}set_right_and_left_sections(){this.$components_wrapper.append('<div id="LeftSection" class="columnBoxReverse"></div>'),this.$components_wrapper.append('<div id="RightSection" class="columnBox"></div>'),this.$rightSection=this.$components_wrapper.find("#RightSection"),this.$leftSection=this.$components_wrapper.find("#LeftSection")}init_customer_box(){this.customer_box=new pos_ar.PointOfSale.pos_customer_box(this.$leftSection,this.appData.appData.customers,this.defaultCustomer,this.backHome.bind(this),this.onSync.bind(this),this.saveCheckInOut.bind(this),this.onMenuClick.bind(this),this.onDebtClick.bind(this))}init_item_selector(){this.item_selector=new pos_ar.PointOfSale.pos_item_selector(this.$leftSection,this.appData.appData.items,this.appData.appData.item_barcodes,this.appData.appData.item_groups,this.appData.appData.item_prices,this.settings_data.settings,this.defaultPriceList,this.getItemPrice.bind(this),this.auto_select.bind(this),e=>{this.itemClick_selector(e)})}init_selected_item(){this.selected_item_cart=new pos_ar.PointOfSale.pos_selected_item_cart(this.$rightSection,this.settings_data,this.selectedItemMaps,this.appData.appData.price_lists,this.appData.appData.customers,this.appData.brands,this.taxes_and_charges,this.invoiceData,this.selectedTab,this.selectedItem,this.selectedField,this.getItemPrice.bind(this),e=>{this.onSelectedItemClick(e)},e=>{this.onClose_details()},(e,t)=>{this.onKeyPressed(e,t)},this.createNewTab.bind(this),this.onCheckout.bind(this),this.savePosInvoice.bind(this))}init_item_details(){this.item_details=new pos_ar.PointOfSale.pos_item_details(this.$leftSection,this.appData.appData.pos_profile.warehouse,this.appData.appData.price_lists,this.appData.appData.item_prices,this.appData.appData.bins,this.selectedItem,this.selectedField,(e,t,i)=>{this.onInput(e,t,i)},this.onClose_details.bind(this))}init_paymentCart(){this.payment_cart=new pos_ar.PointOfSale.pos_payment_cart(this.$leftSection,this.selectedItemMaps,this.selectedTab,this.appData.appData,this.appData.appData.pos_profile.payments,this.selectedPaymentMethod,this.invoiceData,this.onClose_payment_cart.bind(this),this.onCompleteOrder.bind(this),(e,t,i)=>{this.onInput(e,t,i)})}init_historyCart(){this.history_cart=new pos_ar.PointOfSale.pos_history(this.wrapper,this.db,this.appData.appData.pos_profile,this.company,this.taxes_and_charges,this.historyCartClick.bind(this))}init_checkInOutCart(){this.check_in_out_cart=new pos_ar.PointOfSale.pos_check_in_out(this.wrapper,this.db)}init_debtCart(){this.debt_cart=new pos_ar.PointOfSale.pos_debt_cart(this.wrapper)}init_settingsCart(){this.settings_cart=new pos_ar.PointOfSale.pos_settings(this.wrapper,this.settings_data,this.appData.appData.pos_profile,this.onSettingsChange.bind(this))}itemClick_selector(e,t){this.syncInput=!1;let i=structuredClone(e);i.discount_amount=0,i.discount_percentage=0,Object.assign(this.selectedItem,i),this.addItemToPosInvoice(i),this.selected_item_cart.calculateNetTotal(),this.selected_item_cart.calculateVAT(),this.selected_item_cart.calculateQnatity(),this.selected_item_cart.calculateGrandTotal(),this.selected_item_cart.refreshSelectedItem(),t&&this.item_selector.refreshItemSelector(),this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted(),this.selected_item_cart.scrollToBottom(),this.savePosInvoice(!0)}onSelectedItemClick(e){this.syncInput=!1;let t=structuredClone(e);Object.assign(this.selectedItem,t),this.settings_data.settings.showItemDetails&&(this.item_details.show_cart(),this.item_selector.hideCart(),this.selected_item_cart.showKeyboard(),this.payment_cart.hideCart(),this.settings_cart.hideCart(),this.selected_item_cart.setKeyboardOrientation("landscape")),this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted(),this.item_details.refreshDate(e)}saveCheckInOut(e){this.appData.saveCheckInOut(e,t=>{this.check_in_out_cart.getAllCheckInOut()},t=>{console.log("err to save checkInOut : ",t)})}onSettingsChange(e){e=="itemPriceBasedOn"&&(this.item_selector.refreshItemSelector(),this.selected_item_cart.resetItemRateBaseOnPriceList(),this.selected_item_cart.refreshSelectedItem())}onDebtClick(){this.debt_cart.showCart()}savePosInvoice(e){if(console.log("saving..."),this.checkIfRateZero(this.selectedItemMaps.get(this.selectedTab.tabName))&&!e){frappe.throw("Item with rate equal 0");return}this.selectedItemMaps.get(this.selectedTab.tabName).synced=!1,this.appData.savePosInvoice(this.selectedItemMaps.get(this.selectedTab.tabName))}onCheckout(){this.savePosInvoice(!0),this.payment_cart.showCart(),this.item_selector.hideCart(),this.item_details.hide_cart(),this.settings_cart.hideCart(),this.payment_cart.calculateGrandTotal(),this.selected_item_cart.setKeyboardOrientation("landscape"),this.selected_item_cart.cleanHeighlight(),this.selected_item_cart.showKeyboard()}onClose_details(){this.item_selector.showCart(),this.payment_cart.hideCart(),this.item_details.hide_cart(),this.settings_data.settings.showItemDetails&&this.selected_item_cart.hideKeyboard(),this.settings_cart.hideCart(),this.selected_item_cart.setKeyboardOrientation("portrait"),this.selected_item_cart.cleanHeighlight()}auto_select(e){this.itemClick_selector(e),this.item_selector.refresh()}onClose_payment_cart(){this.item_selector.showCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.settings_data.settings.showItemDetails&&this.selected_item_cart.hideKeyboard(),this.settings_cart.hideCart(),this.selected_item_cart.setKeyboardOrientation("portrait"),this.selected_item_cart.cleanHeighlight()}onMenuClick(e){e=="recent_pos"?(this.history_cart.show_cart(),this.customer_box.showHomeBar(),this.payment_cart.hideCart(),this.item_details.hide_cart(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.customer_box.hideSyncBar(),this.settings_cart.hideCart(),this.check_in_out_cart.hideCart()):e=="close_pos"?this.onClosePOS():e=="settings"?(this.settings_cart.showCart(),this.customer_box.showHomeBar(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.history_cart.hide_cart(),this.check_in_out_cart.hideCart(),this.customer_box.hideSyncBar()):e=="checkInOut"&&(this.check_in_out_cart.showCart(),this.customer_box.showHomeBar(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.history_cart.hide_cart(),this.settings_cart.hideCart(),this.customer_box.hideSyncBar())}backHome(){this.item_selector.showCart(),this.customer_box.showSyncBar(),this.selected_item_cart.showCart(),this.payment_cart.hideCart(),this.customer_box.hideHomeBar(),this.item_details.hide_cart(),this.history_cart.hide_cart(),this.settings_cart.hideCart(),this.check_in_out_cart.hideCart()}getDefaultPaymentMethod(){let e=null;return this.appData.appData.pos_profile.payments.forEach(t=>{t.default&&(e=t)}),e}getPaymentMethods(){let e=[];return this.appData.appData.pos_profile.payments.forEach(t=>{e.push({mode_of_payment:t.mode_of_payment,default:t.default,amount:0})}),e}createNewTab(e){let t=frappe.model.get_new_doc("POS Invoice");t.customer=this.defaultCustomer.name,t.pos_profile=this.appData.appData.pos_profile.name,t.items=[],t.taxes_and_charges=this.appData.appData.pos_profile.taxes_and_charges,t.additional_discount_percentage=0,t.paid_amount=0,t.base_paid_amount=0,t.creation_time=frappe.datetime.now_datetime(),t.payments=this.getPaymentMethods(),t.is_pos=1,t.update_stock=1,t.docstatus=0,t.synced=!1,t.status="Draft",t.priceList=this.defaultPriceList.name;let i=new Date,[a,r,n]=i.toISOString().split("T")[0].split("-"),o=i.getHours(),c=i.getMinutes(),l=i.getMilliseconds();t.refNum=this.appData.appData.pos_profile.name+"-"+a+"-"+r+"-"+n+"-"+o+c+l,this.selectedItemMaps.set(`C${e}`,t),this.selectedTab.tabName=`C${e}`,this.item_details.hide_cart()}historyCartClick(e,t){if(e=="edit"){let i=this.selected_item_cart.createTabForEditPOS();this.selectedItemMaps.set(`C${i}`,t),this.selectedTab.tabName=`C${i}`,this.item_selector.showCart(),this.customer_box.showHomeBar(),this.selected_item_cart.showCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.history_cart.hide_cart(),this.settings_cart.hideCart(),this.selected_item_cart.refreshTabs(),this.selected_item_cart.refreshSelectedItem()}else e=="return"&&this.backHome()}onInput(e,t,i){if(e=="focus"||e=="blur"){e=="focus"&&Object.assign(this.selectedField,{field_name:t}),e=="blur"&&Object.assign(this.selectedField,{field_name:null}),this.item_details.makeSelectedFieldHighlighted(),this.selected_item_cart.makeSelectedButtonHighlighted();return}if(t=="quantity")this.selectedItem.qty=parseFloat(i),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem();else if(t=="rate"){this.selectedItem.rate=parseFloat(i);let a=this.selectedItem.rate,r=this.selectedItem.discount_percentage,n=a*(r/100);this.selectedItem.discount_percentage=r,this.selectedItem.discount_amount=n,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(t=="discount_percentage"){let r=this.selectedItem.rate*(parseFloat(i)/100);this.selectedItem.discount_percentage=parseFloat(i),this.selectedItem.discount_amount=r,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemDiscountPercentage(this.selectedItem.name,this.selectedItem.discount_percentage),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(t=="discount_amount"){let a=this.selectedItem.rate,r=(parseFloat(i)*100/a).toFixed(2),n=parseFloat(i);r>100&&(r=100),parseFloat(i)>a&&(n=a),this.selectedItem.discount_percentage=parseFloat(r),this.selectedItem.discount_amount=n,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemDiscountPercentage(this.selectedItem.name,this.selectedItem.discount_percentage),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}this.savePosInvoice(!0)}onKeyPressed(e,t){var i;if(e=="quantity")this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted();else if(e=="rate")this.selectedField.field_name="rate",this.selected_item_cart.makeSelectedButtonHighlighted();else if(e!="discount"){if(e=="print")this.history_cart.print_receipt(this.selectedItemMaps.get(this.selectedTab.tabName));else if(e=="remove")this.deleteItemFromPOsInvoice(this.selectedItem.name),this.selected_item_cart.refreshSelectedItem(),this.onClose_details();else if(e=="delete"){if(!this.settings_data.settings.showItemDetails){if(this.selectedField.field_name=="quantity"){let n=`${parseFloat(this.selectedItem.qty)}`.slice(0,-1);this.selectedItem.qty=parseFloat(n)||0}else if(this.selectedField.field_name=="rate"){let n=`${parseFloat(this.selectedItem.rate)}`.slice(0,-1);this.selectedItem.rate=parseFloat(n)||0;let o=this.selectedItem.rate,c=this.selectedItem.discount_percentage,l=o*(c/100);this.selectedItem.discount_amount=l}this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem),this.savePosInvoice(!0);return}let a=parseFloat(this.item_details.deleteCharacter());if(this.selectedField.field_name=="quantity")this.selectedItem.qty=a;else if(this.selectedField.field_name=="rate"){this.selectedItem.rate=a;let r=this.selectedItem.rate,n=this.selectedItem.discount_percentage,o=r*(n/100);this.selectedItem.discount_amount=o}else if(this.selectedField.field_name=="discount_percentage"){let n=this.selectedItem.rate*(a/100);this.selectedItem.discount_percentage=a,this.selectedItem.discount_amount=n}else if(this.selectedField.field_name=="discount_percentage"){let n=this.selectedItem.rate*(a/100);this.selectedItem.discount_percentage=a,this.selectedItem.discount_rate=n}else this.selectedField.field_name=="cash"&&this.payment_cart.deleteKeyPress()}else if(e=="addToField"){if(this.selectedField.field_name=="cash")this.payment_cart.handleInput(t);else if(this.selectedField.field_name=="quantity"){let a=0;this.syncInput?a=parseFloat(this.selectedItem.qty):(a=0,this.syncInput=!0);let r=`${a}`+t;this.selectedItem.qty=parseFloat(r)}else if(this.selectedField.field_name=="rate"){let a=0;this.syncInput?a=parseFloat(this.selectedItem.rate):(a=0,this.syncInput=!0);let r=`${a}`+t;this.selectedItem.rate=parseFloat(r);let n=this.selectedItem.rate,o=this.selectedItem.discount_percentage,c=n*(o/100);this.selectedItem.discount_percentage=o,this.selectedItem.discount_amount=c,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate)}else if(this.selectedField.field_name=="discount_percentage"){let a=this.selectedItem.rate,n=`${(i=this.selectedItem.discount_percentage)!=null?i:0}`+t,o=parseFloat(n);o>100&&(o=100);let c=a*(o/100),l=a-c;this.selectedItem.discount_percentage=o,this.selectedItem.discount_amount=c}}}this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem),this.savePosInvoice(!0)}onCompleteOrder(){if(this.savePosInvoice(!0),this.defaultCustomer.name==""){frappe.warn("Customer didnt selected!","you have to select a customer",()=>{},"Done",!1);return}let e=[];if(this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(r=>{let n={item_name:r.item_name,item_code:r.name,rate:r.rate,qty:r.qty,description:r.name,image:r.image,use_serial_batch_fields:1,cost_center:this.appData.appData.pos_profile.cost_center,discount_percentage:r.discount_percentage,discount_amount:r.discount_amount,warehouse:this.appData.appData.pos_profile.warehouse,income_account:this.appData.appData.pos_profile.income_account};e.push(n)}),this.selectedItemMaps.get(this.selectedTab.tabName).items=e,e.length==0)return;this.selectedItemMaps.get(this.selectedTab.tabName).paid_amount=this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName)),this.selectedItemMaps.get(this.selectedTab.tabName).base_paid_amount=this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName)),this.selectedItemMaps.get(this.selectedTab.tabName).outstanding_amount=this.invoiceData.grandTotal-this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName)),this.selectedItemMaps.get(this.selectedTab.tabName).docstatus=1;let t=this.checkIfPaid(this.selectedItemMaps.get(this.selectedTab.tabName));this.selectedItemMaps.get(this.selectedTab.tabName).status=t;let i=structuredClone(this.selectedItemMaps.get(this.selectedTab.tabName));t=="Unpaid"?(i.synced=!0,frappe.db.insert(i).then(r=>{this.appData.updatePosInvoice(i)}).catch(r=>{console.log("cant push pos invoice : ",r)})):(i.synced=!1,this.appData.updatePosInvoice(i),this.unsyncedPos+=1,this.customer_box.setNotSynced(this.unsyncedPos)),this.history_cart.print_receipt(i),this.selectedItemMaps.delete(this.selectedTab.tabName);let a=Array.from(this.selectedItemMaps.keys());a.length>0?(this.selectedTab.tabName=a[0],this.selected_item_cart.refreshTabs(),this.selected_item_cart.refreshSelectedItem()):this.selected_item_cart.createNewTab(),this.onClose_payment_cart()}onSync(){if(this.POSOpeningEntry.name==""){this.checkForPOSEntry();return}if(this.unsyncedPos==0){frappe.msgprint({title:__("Sync Complete"),indicator:"green",message:__("All data is already synchronized.")});return}let e=0,t=0,i=0;this.appData.getNotSyncedPos(a=>{frappe.show_progress("Syncing Invoices...",0,a.length,"syncing"),a.forEach(r=>{frappe.db.insert(r).then(n=>{let o=structuredClone(r);o.synced=!0,this.appData.updatePosInvoice(o),e+=1,frappe.show_progress("Syncing Invoices...",e,a.length,"syncing"),e==a.length&&(frappe.hide_progress(),this.customer_box.setSynced(),this.unsyncedPos=0)}).catch(n=>{e+=1,t+=1})})},a=>{console.log("cant get the unseced POS from local")})}checkIfPaid(e){let t=0,i=0,a=0,r=0;return e.items.forEach(n=>{t+=n.qty*n.rate}),this.taxes_and_charges.forEach(n=>{a+=n.rate/100*t}),r=e.additional_discount_percentage/100*t,i=t+a-r,e.paid_amount==0||e.paid_amount<i?"Unpaid":"Paid"}checkIfRateZero(e){return e.items.some(t=>t.rate==0)}onClosePOS(){this.unsyncedPos>0&&frappe.throw(__(`you have ${all_tabs.length} invoice to sync first.`));let e=frappe.model.get_new_doc("POS Closing Entry");e.pos_opening_entry=this.POSOpeningEntry.name,e.pos_profile=this.POSOpeningEntry.pos_profile,e.company=this.POSOpeningEntry.company,e.user=frappe.session.user,e.posting_date=frappe.datetime.now_date(),e.posting_time=frappe.datetime.now_time(),this.check_in_out_cart.checkList.forEach(t=>{let i=frappe.model.add_child(e,"check_in_out","custom_check_in_out");i.check_type=t.check_type,i.creation_time=t.creation_time,i.amount=t.amount,i.reason=t.reason,i.user=t.owner}),frappe.set_route("Form","POS Closing Entry",e.name),this.POSOpeningEntry.name=""}setListeners(){window.addEventListener("offline",function(){frappe.msgprint("you lose the connection (offline mode)")}),window.addEventListener("online",function(){frappe.msgprint("the connection is back (online mode)")})}toggleKeyboardMode(e){e?document.addEventListener("keydown",t=>{console.log(t.key);let i=document.activeElement;if(!(i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.isContentEditable)){if(t.key=="q")this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted();else if(t.key=="p")this.selectedField.field_name="rate",this.selected_item_cart.makeSelectedButtonHighlighted();else if(t.key=="Backspace"){if(this.selectedField.field_name=="quantity"){let r=parseFloat(this.selectedItem.qty),n=0;n=parseFloat(`${r}`.slice(0,-1))||0,this.selectedItem.qty=parseFloat(n),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem()}else if(this.selectedField.field_name=="rate"){let r=parseFloat(this.selectedItem.rate),n=parseFloat(`${r}`.slice(0,-1))||0;this.selectedItem.rate=parseFloat(n);let o=this.selectedItem.rate,c=this.selectedItem.discount_percentage,l=o*(c/100);this.selectedItem.discount_percentage=c,this.selectedItem.discount_amount=l,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}}else if(this.selectedField.field_name=="quantity"){if(parseFloat(t.key)||t.key=="0"){let r=0;this.syncInput?r=parseFloat(this.selectedItem.qty):(r=0,this.syncInput=!0);let n=`${r}`+t.key;this.selectedItem.qty=parseFloat(n),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem()}}else if(this.selectedField.field_name=="rate"&&(parseFloat(t.key)||t.key=="0")){let r=0;this.syncInput?r=parseFloat(this.selectedItem.rate):(r=0,this.syncInput=!0);let n=`${r}`+t.key;this.selectedItem.rate=parseFloat(n);let o=this.selectedItem.rate,c=this.selectedItem.discount_percentage,l=o*(c/100);this.selectedItem.discount_percentage=c,this.selectedItem.discount_amount=l,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}}}):document.removeEventListener("keydown",t=>{})}getItemPrice(e,t){let i=this.settings_data.settings.itemPriceBasedOn;if(i=="brand"){if(e.brand==null)return 0;let a=this.appData.appData.item_prices.find(r=>r.brand==e.brand&&r.price_list==t);return a?a.price_list_rate:0}else if(i=="priceList"){let a=this.appData.appData.item_prices.find(r=>r.item_code==e.item_name&&r.price_list==t);return a?a.price_list_rate:0}}checkServiceWorker(){"serviceWorker"in navigator&&(window.addEventListener("DOMContentLoaded",()=>{navigator.serviceWorker.register("./sw.js").then(e=>console.log("Service Worker registered successfully.")).catch(e=>console.log(`Service Worker registration failed: ${e}`))}),this.sw=new pos_ar.PointOfSale.Sw,document.readyState==="complete"&&navigator.serviceWorker.register("../assets/pos_ar/public/js/sw.js").then(e=>console.log("Service Worker registered successfully.")).catch(e=>console.log(`Service Worker registration failed: ${e}`)))}checkUnSyncedPos(){this.appData.getNotSyncedPosNumber(e=>{this.unsyncedPos=e,this.unsyncedPos==0?this.customer_box.setSynced(e):this.customer_box.setNotSynced(e)},e=>{console.log(`error occured when check unSynced POS : ${e} `)})}addItemToPosInvoice(e){let t=structuredClone(e),a=this.selectedItemMaps.get(this.selectedTab.tabName).items,r=!1;if(a.forEach(n=>{if(n.name==e.name){r=!0,n.qty+=1;let o=structuredClone(n);Object.assign(this.selectedItem,o)}}),!r){t.discount_amount=0,t.discount_percentage=0,t.qty=1,t.rate=this.getItemPrice(e,this.selectedItemMaps.get(this.selectedTab.tabName).priceList),a.push(t);let n=structuredClone(t);Object.assign(this.selectedItem,n)}}deleteItemFromPOsInvoice(e){let t=this.selectedItemMaps.get(this.selectedTab.tabName),i=t.items;t.items=i.filter(a=>a.name!=e),this.selectedItem=structuredClone({name:""})}editPosItemQty(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{a.name==e&&(a.qty=t)})}editPosItemRate(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{a.name==e&&(a.rate=t)})}editPosItemDiscountPercentage(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{a.name==e&&(a.discount_percentage=t)})}editPosItemDiscountAmount(e,t){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{a.name==e&&(a.discount_amount=t)})}calculatePaidAmount(e){let t=0;return e.payments.forEach(i=>{t+=i.amount}),t}};pos_ar.PointOfSale.pos_item_selector=class{constructor(e,t,i,a,r,n,o,c,l,d){this.wrapper=e,this.item_list=t,this.item_barcodes=i,this.item_group_list=a,this.item_prices=r,this.settings_data=n,this.selected_price_list=o,this.get_item_price=c,this.auto_select=l,this.on_item_click=d,this.start_item_selector()}start_item_selector(){this.prepare_select_box(),this.setItemGroupsInList(),this.setItemInFlow(this.getItemByItemGroup("")),this.setListeners()}refresh(){this.setItemInFlow(this.getItemByItemGroup(""))}prepare_select_box(){this.wrapper.append('<div id="SelectorBox" class="columnBox" ></div>'),this.selectorBox=this.wrapper.find("#SelectorBox"),this.selectorBox.append('<div id="selectorBoxHeader" class="rowBox header"></div>'),this.header=this.selectorBox.find("#selectorBoxHeader"),this.header.append('<h4 class="CartTitle">Items</h4>'),this.header.append('<div id="inputsBox" class="rowBox align_center"></div>'),this.inputBox=this.header.find("#inputsBox"),this.inputBox.append('<input type="text" autocomplete="off"  maxlength="140" placeholder="Search by item code, item name or barcode" id="ItemInput" name="item" placeHolder="Enter the customer">'),this.inputBox.append('<input list="ItemGroupList"  id="ItemGroupInput" name="ItemGroup" placeHolder="Item Group">'),this.inputBox.append('<datalist id="ItemGroupList"></datalist>'),this.itemGroupList=this.inputBox.find("#ItemGroupList"),this.itemGroupList.append("<option>fetching Item Groups ...</option>"),this.settings_data.search_by_group||(console.log(" see settings ",this.settings_data),this.inputBox.find("#ItemGroupInput").hide()),this.selectorBox.append('<div id="itemsContainer" class="rowBox row_wrap"></div>'),this.itemsContainer=this.selectorBox.find("#itemsContainer")}setItemGroupsInList(){let e=document.getElementById("ItemGroupList");e.innerHTML="",this.item_group_list.forEach(t=>{let i=document.createElement("option");i.value=t.name,i.textContent=t.customer_name,e.appendChild(i)})}refreshItemSelector(){let e=document.getElementById("ItemInput");e.value="";let t=document.getElementById("ItemGroupInput");this.setItemInFlow(this.getItemByItemGroup(t.value)),s}setItemInFlow(e){let t=document.getElementById("itemsContainer");t.innerHTML="";let i=document.getElementById("ItemInput");for(let a=0;a<e.length&&a<700;a++){let r=e[a],n=document.createElement("div");if(n.classList.add("itemBox"),n.classList.add("columnBox"),n.classList.add("C_A_Center"),n.addEventListener("click",l=>{let d=i.value.length>0;this.on_item_click(r,d)}),r.image){let l=document.createElement("img");l.classList.add("itemImage"),l.src=r.image,n.appendChild(l)}else{let l=document.createElement("div");l.classList.add("itemImage"),l.classList.add("rowBox"),l.classList.add("centerItem");let d=document.createElement("h1");d.textContent=r.item_name[0],d.style.color="#707070",l.appendChild(d),n.appendChild(l)}let o=document.createElement("div");o.textContent=r.item_name,o.classList.add("itemTitle"),n.appendChild(o);let c=document.createElement("div");c.classList.add("itemPrice"),c.textContent=this.get_item_price(r,this.selected_price_list.name)+" DA",n.appendChild(c),t.appendChild(n)}}showCart(){this.selectorBox.css("display","flex")}hideCart(){this.selectorBox.css("display","none")}setListeners(){document.getElementById("ItemGroupInput").addEventListener("input",i=>{this.setItemInFlow(this.getItemByItemGroup(event.target.value))}),document.getElementById("ItemInput").addEventListener("input",i=>{this.setItemInFlow(this.filterListByItemData(i.target.value))})}filterListByItemData(e){let i=this.item_barcodes.filter(a=>a.barcode==e).map(a=>a.parent);if(i.length==1){this.auto_select(this.item_list.find(r=>r.name==i[0]));let a=document.getElementById("ItemInput");return a.value="",this.item_list}return this.item_list.filter(a=>i.includes(a.name)||a.item_name.toLowerCase().includes(e.toLowerCase()))}getItemByItemGroup(e){let t=[],i=n=>{t.push(n),this.item_group_list.forEach(o=>{o.parent_item_group==n&&(t.push(o.name),o.is_group&&i(o.name))})};i(e);let a=[],r=n=>{this.item_list.forEach(o=>{o.item_group==n&&a.push(o)})};return t.forEach(n=>{r(n)}),a}};pos_ar.PointOfSale.pos_customer_box=class{constructor(e,t,i,a,r,n,o,c){this.wrapper=e,this.customers_list=t,this.selected_customer=i,this.back_home=a,this.on_sync=r,this.on_menu_click=o,this.save_check_in_out=n,this.on_debt_click=c,this.online=!0,this.show_menu=!1,this.start_work()}start_work(){this.prepare_customer_box(),this.checkForSync(),this.setListeners()}prepare_customer_box(){this.wrapper.append('<div id="ActionsContainerBox" class="rowBox align_center" style="order:1;">'),this.actionContainer=this.wrapper.find("#ActionsContainerBox"),this.actionContainer.append('<div id="SyncBox"     class="rowBox centerItem" >'),this.actionContainer.append('<div id="HomeBox"     class="rowBox centerItem"  style="display:none;">'),this.actionContainer.append('<div id="DebtBox"     class="rowBox centerItem" >'),this.actionContainer.append('<div id="exchangeBtn" class="rowBox centerItem" style="margin-right:16px;" >  <img src="/assets/pos_ar/images/exchange.png">  </div>'),this.actionContainer.append('<div id="MenuBox"     class="rowBox centerItem" >'),this.sync_btn=this.actionContainer.find("#SyncBox"),this.sync_btn.append('<div id="syncBoxContent"> Sync </div>'),this.sync_btn_content=this.sync_btn.find("#syncBoxContent"),this.exchange_btn=this.actionContainer.find("#exchangeBtn"),this.home=this.actionContainer.find("#HomeBox"),this.home.append('<img src="/assets/pos_ar/images/home.png" alt="Home" id="homeBoxIcon">'),this.debt=this.actionContainer.find("#DebtBox"),this.debt.append('<img src="/assets/pos_ar/images/debt.png" alt="Debt" id="debtBoxIcon">'),this.menu=this.actionContainer.find("#MenuBox"),this.menu.append('<img src="/assets/pos_ar/images/menu.png" alt="Menu" id="MenuBtn" >'),this.menu.append('<div id="menuItemsContainer"     class="columnBox">'),this.menuItemsContainer=this.actionContainer.find("#menuItemsContainer"),this.menuItemsContainer.append('<div id="posInvoiceMenuItem" class="menuItem">Recent POS Invoices</div>'),this.menuItemsContainer.append('<div id="checkInOutMenuItem" class="menuItem">Check In/Out</div>'),this.menuItemsContainer.append('<div id="closePosMenuItem"   class="menuItem">Close the POS</div>'),this.menuItemsContainer.append('<div id="settingMenuItem"    class="menuItem">About</div>'),this.pos_invoices=this.menuItemsContainer.find("#posInvoiceMenuItem"),this.check_in_out=this.menuItemsContainer.find("#checkInOutMenuItem"),this.close_pos=this.menuItemsContainer.find("#closePosMenuItem"),this.setting=this.menuItemsContainer.find("#settingMenuItem"),this.wrapper.append('<div id="darkFloatingBackground"></div>'),this.dark_floating_background=this.wrapper.find("#darkFloatingBackground"),this.wrapper.append('<div id="checkInOutDialog"></div>'),this.check_in_out_dialog=this.wrapper.find("#checkInOutDialog"),this.check_in_out_dialog.css("flex-direction","column"),this.check_in_out_dialog.append('<div id="checkTypeContainer"></div>'),this.check_type_container=this.check_in_out_dialog.find("#checkTypeContainer"),this.check_type_container.append('<div id="checkInType"  class="rowBox centerItem checkType selected "><div>Check In</div>  <img src=""></div>'),this.check_type_container.append('<div id="checkOutType" class="rowBox centerItem checkType">  <div>Check Out</div>  <img src="">  </div>'),this.check_in_box=this.check_type_container.find("#checkInType"),this.check_out_box=this.check_type_container.find("#checkOutType"),this.check_in_out_type="In",this.check_in_out_dialog.append('<div class="inputGroup">  <input autocomplete="off" required="" type="number" id="check_in_out_input"><label for="name">Amount</label>   </div>'),this.check_in_out_dialog.append('<div class="inputGroup">  <textarea type="text" id="check_in_out_note_textarea"></textarea><label for="name">Reason</label>   </div>'),this.check_in_out_input=this.check_in_out_dialog.find("#check_in_out_input"),this.check_in_out_note=this.check_in_out_dialog.find("#check_in_out_note_textarea"),this.check_in_out_dialog.append('<div id="btnsContainers" class="rowBox"> <div id="cancelBtn" class="dialogBtn rowBox centerItem">Cancel</div><div id="confirmBtn" class="dialogBtn rowBox centerItem">Done</div> </div>'),this.cancel_dialog_btn=this.check_in_out_dialog.find("#cancelBtn"),this.confirm_dialog_btn=this.check_in_out_dialog.find("#confirmBtn")}showHomeBar(){this.home.css("display","flex")}hideHomeBar(){this.home.css("display","none")}showSyncBar(){this.sync_btn.css("display","flex")}hideSyncBar(){this.sync_btn.css("display","none")}showCheckInOutDialog(){this.check_in_out_dialog.css("display","flex"),this.dark_floating_background.css("display","flex")}hideCheckInOutDialog(){this.checkAmount=0,this.check_in_out_dialog.css("display","none"),this.dark_floating_background.css("display","none"),this.check_in_out_input.val(0)}checkForSync(){this.sync_btn.addClass("Synced")}setListeners(){this.sync_btn.on("click",e=>{frappe.confirm("Are you sure you want to sync",()=>{this.on_sync()},()=>{})}),this.close_pos.on("click",e=>{this.on_menu_click("close_pos")}),this.pos_invoices.on("click",e=>{this.on_menu_click("recent_pos")}),this.setting.on("click",e=>{this.on_menu_click("settings")}),this.check_in_out.on("click",e=>{this.on_menu_click("checkInOut")}),this.menu.on("click",e=>{this.show_menu?(this.show_menu=!this.show_menu,this.menuItemsContainer.css("visibility","hidden"),this.menuItemsContainer.css("opacity","0")):(this.show_menu=!this.show_menu,this.menuItemsContainer.css("visibility","visible"),this.menuItemsContainer.css("opacity","1"))}),this.home.on("click",e=>{this.back_home()}),this.debt.on("click",e=>{this.on_debt_click()}),this.exchange_btn.on("click",e=>{this.showCheckInOutDialog()}),this.dark_floating_background.on("click",e=>{this.hideCheckInOutDialog()}),this.check_in_box.on("click",e=>{this.check_in_out_type="In",this.check_in_box.css("border","3px solid #9B5788"),this.check_in_box.css("background","#ffffff"),this.check_out_box.css("border","2px solid #e0e0e0"),this.check_out_box.css("background","#fafafa")}),this.check_out_box.on("click",e=>{this.check_in_out_type="Out",this.check_out_box.css("border","3px solid #9B5788"),this.check_out_box.css("background","#ffffff"),this.check_in_box.css("border","2px solid #e0e0e0"),this.check_in_box.css("background","#fafafa")}),this.check_in_out_input.on("input",e=>{}),this.cancel_dialog_btn.on("click",e=>{console.log("cancel"),this.hideCheckInOutDialog()}),this.confirm_dialog_btn.on("click",e=>{let t=frappe.model.get_new_doc("check_in_out");if(t.creation_time=frappe.datetime.now_datetime(),t.user=frappe.session.user,t.check_type=this.check_in_out_type,t.amount=parseFloat(this.check_in_out_input.val()),t.reason=this.check_in_out_note.val(),parseFloat(this.check_in_out_input.val())<=0||this.check_in_out_note.val()==""){frappe.msgprint("you should fulfilled fileds.");return}this.save_check_in_out(t),this.hideCheckInOutDialog(),console.log("checkInOut : ",t)})}setSynced(){this.sync_btn.addClass("Synced"),this.sync_btn.removeClass("NotSynced"),this.sync_btn_content.html("Synced")}setNotSynced(e){this.sync_btn.addClass("NotSynced"),this.sync_btn.removeClass("Synced"),this.sync_btn_content.html(`Sync (${e})`)}};pos_ar.PointOfSale.pos_selected_item_cart=class{constructor(e,t,i,a,r,n,o,c,l,d,h,f,g,y,_,u,p,v){this.wrapper=e,this.settings_data=t,this.selected_item_maps=i,this.price_lists=a,this.customer_list=r,this.brand_list=n,this.sales_taxes=o,this.invoice_data=c,this.selected_tab=l,this.selected_item=d,this.selected_field=h,this.get_item_price=f,this.on_key_pressed=_,this.on_checkout_click=p,this.on_selected_item_click=g,this.on_tab_click=y,this.create_new_tab=u,this.save_pos_invoice=v,this.taxes_map=new Map,this.total_tax_amout=0,this.counter=1,this.show_discount=!1,this.start_work()}start_work(){this.prepare_selected_item_cart(),this.fulfillingSelects(),this.setButtonsListeners(),this.setListener()}prepare_selected_item_cart(){let e="",t="",i="",a="";this.settings_data.settings.keyboardStyle==this.settings_data.keyboard_styles[0]?(e="margin:0px 16px;padding:0px 0px 16px 0px;",t="width:100%;display:grid;grid-template-columns:auto auto auto auto;",i="height:45px;padding:4px;margin:6px;background:#f5f5f5;border:2px solid #e0e0e0;border-radius:12px;color:black;font-size:small;text-align:center;display:flex;justify-content:center;align-items:center;",a="width:calc(100% - 32px);margin:0px 16px 16px 16px;padding : 8px 0px ;color:#FFFFFF;font-size:larger;font-weight:600;background:#9B5788;border:3px solid #663959;border-radius:8px;outline:none;"):(e="width:100%;",t="width:100%;border-top:1px solid #a0a0a0;border-bottom:1px solid #a0a0a0;display:grid;grid-template-columns:auto auto auto auto;",i="height:45px;padding:4px;background:#f5f5f5;border:1px solid #a0a0a0;color:black;font-size:small;text-align:center;display:flex;justify-content:center;align-items:center;",a="width:100%;height:55px;color:#FFFFFF;font-size:19px;font-weight:600;background:#9B5788;border:none;border-top:4px solid #663959;border-radius:0px;outline:none;"),this.wrapper.append('<div id="tabs"    class="rowBox"><div id="tabs_container" class="rowBox" style="overflow-x:auto;overflow-y:hidden;" ></div></div>'),this.wrapper.append('<div id="CartBox" class="columnBox"></div>'),this.tabs_bar=this.wrapper.find("#tabs"),this.tabs_container=this.tabs_bar.find("#tabs_container"),this.cartBox=this.wrapper.find("#CartBox"),this.tabs_container.append('<div class="tab selected rowBox align_center"><div class="tabName">C1</div><img src="/assets/pos_ar/images/cancel.png" width="10px" height="10px" class="tabDeleteBtn"></div>'),this.tabs_bar.append('<div id="addTabBtn" class="tab unselected">+</div>'),this.add_tab_button=this.tabs_bar.find("#addTabBtn"),this.cartBox.append('<div id="CartBoxTopBar" class=" rowBox align_center  row_sbtw"><div>'),this.cartBox.append('<div id="cartHeader" class="rowBox row_sbtw align_center"></div>'),this.cartBox.append('<div id="selectedItemsContainer" class="columnBox"></div>'),this.cartBox.append('<div id="cartFooter" class="columnBox"></div>'),this.cartTopBar=this.cartBox.find("#CartBoxTopBar"),this.cartTopBar.append('<div id="selectedCustomerInput"></div>'),this.cartTopBar.append('<div id="selectedBrandInput"></div>'),this.cartTopBar.append('<div id="selectedItemsPriceListInput"></div>'),this.customerInputContainer=this.cartTopBar.find("#selectedCustomerInput"),this.customerInputContainer.append('<select  id="customerInput"  placeHolder="Choice a customer">'),this.customerInput=this.customerInputContainer.find("#customerInput"),this.priceListInputContainer=this.cartTopBar.find("#selectedItemsPriceListInput"),this.priceListInputContainer.append('<select  id="PriceListInput" name="PriceList" placeHolder="Choice a Price list">'),this.priceListInput=this.priceListInputContainer.find("#PriceListInput"),this.cartHeader=this.cartBox.find("#cartHeader"),this.cartHeader.append('<div style="font-size:16px;font-weight:600;"><p>Item</p></div>'),this.cartHeader.append('<div id="cartHeaderTitles" class="rowBox"></div>'),this.cartHeaderTitles=this.cartHeader.find("#cartHeaderTitles"),this.cartHeaderTitles.append('<div id="quantityTitle" style="font-size:16px;font-weight:600;" >  <p>Quantity</p></div>'),this.cartHeaderTitles.append('<div id="amountTitle"   style="font-size:16px;font-weight:600;" >  <p>Amount  </p></div>'),this.selectedItemContainer=this.cartBox.find("#selectedItemsContainer"),this.cartFooter=this.cartBox.find("#cartFooter"),this.cartFooter.append('<div id="cartDetails" class="columnBox"></div>'),this.cartFooter.append(`<div id="editSelectedItemCart" style="${e}"></div>`),this.cartFooter.append(`<div id="mainBtnContainer" class="rowBox centerItem"  style="${a}">  </div>`),this.cartDetails=this.cartFooter.find("#cartDetails"),this.cartDetails.append('<div id="discount" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="totalQuantity" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="netTotal" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="VAT" class="columnBox"></div>'),this.cartDetails.append('<div id="grandTotal" class="rowBox align_center row_sbtw"></div>'),this.discount=this.cartDetails.find("#discount"),this.discount.append('<div id="addDiscountTitle">Add Discount % </div>'),this.discount.append('<input type="number" id="addGlobalDiscountInput" value="0" step="1" min="0" max="100" >'),this.discountInput=this.discount.find("#addGlobalDiscountInput"),this.discountTitle=this.discount.find("#addDiscountTitle"),this.totalQuantity=this.cartDetails.find("#totalQuantity"),this.totalQuantity.append('<div id="totalQuantityTitle">Total Quantity</div>'),this.totalQuantity.append('<div id="totalQuantityValue">0</div>'),this.netTotal=this.cartDetails.find("#netTotal"),this.netTotal.append('<div id="netTotalTitle">Net Total</div>'),this.netTotal.append('<div id="netTotalValue">0.00</div>'),this.vat=this.cartDetails.find("#VAT"),this.sales_taxes.forEach(r=>{this.vat.append(`<div id="taxConatiner_${r.name}" class="rowBox align_center row_sbtw"></div>`);let n=this.vat.find(`#taxConatiner_${r.name}`);n.append(`<div id="tax_${r.name}_Title">${r.description}</div>`),n.append(`<div id="tax_${r.name}_Value">0.00</div>`)}),this.grandTotal=this.cartDetails.find("#grandTotal"),this.grandTotal.append('<div id="grandTotalTitle">Grand Total</div>'),this.grandTotal.append('<div id="grandTotalValue">0.00</div>'),this.settings_data.settings.showDiscountField||(this.setKeyboardOrientation("landscape"),this.discount.css("display","none")),this.editSelectedItem=this.cartFooter.find("#editSelectedItemCart"),this.editSelectedItem.css("display","flex"),this.editSelectedItem.append(`<div class="grid-container"  style="${t}">`),this.buttonsContainer=this.editSelectedItem.find(".grid-container"),this.buttonsContainer.append(`<button id="key_1"        class="grid-item"  style="${i}" data-action="1"        > 1         </button>`),this.buttonsContainer.append(`<button id="key_2"        class="grid-item"  style="${i}" data-action="2"        > 2         </button>`),this.buttonsContainer.append(`<button id="key_3"        class="grid-item"  style="${i}" data-action="3"        > 3         </button>`),this.buttonsContainer.append(`<button id="key_quantity" class="grid-item"  style="${i}" data-action="Quantity" > Quantit\xE9  </button>`),this.buttonsContainer.append(`<button id="key_4"        class="grid-item"  style="${i}" data-action="4"        > 4         </button>`),this.buttonsContainer.append(`<button id="key_5"        class="grid-item"  style="${i}" data-action="5"        > 5         </button>`),this.buttonsContainer.append(`<button id="key_6"        class="grid-item"  style="${i}" data-action="6"        > 6         </button>`),this.buttonsContainer.append(`<button id="key_rate"     class="grid-item"  style="${i}" data-action="Rate"     > Prix      </button>`),this.buttonsContainer.append(`<button id="key_7"        class="grid-item"  style="${i}" data-action="7"        > 7         </button>`),this.buttonsContainer.append(`<button id="key_8"        class="grid-item"  style="${i}" data-action="8"        > 8         </button>`),this.buttonsContainer.append(`<button id="key_9"        class="grid-item"  style="${i}" data-action="9"        > 9         </button>`),this.buttonsContainer.append(`<button id="key_discount" class="grid-item"  style="${i}" data-action="Discount" > Remise    </button>`),this.buttonsContainer.append(`<button id="key_point"    class="grid-item"  style="${i}" data-action="."        > .         </button>`),this.buttonsContainer.append(`<button id="key_0"        class="grid-item"  style="${i}" data-action="0"        > 0         </button>`),this.buttonsContainer.append(`<button id="key_delete"   class="grid-item"  style="${i}" data-action="Delete"   > Supprimer </button>`),this.buttonsContainer.append(`<button id="key_remove"   class="grid-item"  style="${i}color:red;font-weight:700;" data-action="Remove">Retirer</button>`),this.mainBtnContainer=this.cartFooter.find("#mainBtnContainer"),this.mainBtnContainer.append('<button type="button" id="checkoutBtn" style="width:50%;background:none;border:none;color:white;"> Payment </button>'),this.mainBtnContainer.append('<button type="button" id="printBtn"    style="width:50%;background:none;border:none;color:white;"> Print </button>'),this.mainBtnContainer.find("#checkoutBtn").on("mousedown",r=>{this.on_checkout_click()}),this.mainBtnContainer.find("#printBtn").on("mousedown",r=>{this.on_key_pressed("print",null)})}fulfillingSelects(){this.price_lists.forEach(e=>{this.priceListInput.append(`<option value="${e.name}">${e.price_list_name}</option>`)}),this.customer_list.forEach(e=>{this.customerInput.append(`<option value="${e.name}">${e.customer_name}</option>`)})}refreshTabs(){this.tabs_container.empty();for(let e of this.selected_item_maps.keys())e==this.selected_tab.tabName?this.tabs_container.append(`<div class="tab selected rowBox align_center"><div class="tabName">${e}</div>  <img src="/assets/pos_ar/images/cancel.png" width="10px" height="10px"  class="tabDeleteBtn"  >  </div>`):this.tabs_container.append(`<div class="tab">  <div class="tabName">${e}</div>  </div>`);this.tabs_container.find(".tab").on("click",e=>{let t=$(e.target).closest(".tab").find(".tabName").text();this.selected_tab.tabName=t,this.refreshTabs(),this.refreshSelectedItem(),this.on_tab_click(t)}),this.tabs_container.find(".tabDeleteBtn").on("click",e=>{e.stopPropagation();let t=$(e.target).closest(".tab").find(".tabName").text(),i=this.selected_item_maps.get(t).items;i&&i.length>0?frappe.confirm("Are you sure you want to proceed?",()=>{this.selected_item_maps.delete(t),this.selected_item_maps.size>0?(this.selected_tab.tabName=Array.from(this.selected_item_maps.keys())[0],console.log("this.selected_tab.tabName : ",this.selected_tab)):this.createNewTab(),this.refreshTabs(),this.refreshSelectedItem()},()=>{}):(console.log("debug : ",i," && ",i.length),this.selected_item_maps.delete(t),this.selected_item_maps.size>0?(this.selected_tab.tabName=Array.from(this.selected_item_maps.keys())[0],console.log("this.selected_tab.tabName : ",this.selected_tab)):this.createNewTab(),this.refreshTabs(),this.refreshSelectedItem())})}refreshSelectedItem(){this.priceListInput.val(this.selected_item_maps.get(this.selected_tab.tabName).priceList),this.customerInput.val(this.selected_item_maps.get(this.selected_tab.tabName).customer);let e=document.getElementById("selectedItemsContainer");e.innerHTML="",this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(t=>{let i=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),n=document.createElement("h5"),o=document.createElement("div"),c=document.createElement("div");if(this.settings_data.settings.showItemImage)if(t.image){let l=document.createElement("img");l.src=t.image,l.classList.add("selectedItemImage"),a.appendChild(l)}else{let l=document.createElement("div"),d=document.createElement("div");l.classList.add("selectedItemImage","rowBox","centerItem"),d.textContent=t.name[0],l.appendChild(d),a.appendChild(l)}n.textContent=t.item_name,n.classList.add("selectedItemName"),a.appendChild(n),o.textContent=t.qty,o.classList.add("itemQuantity"),o.style.fontSize="18px",o.style.fontWeight="600",r.appendChild(o),c.textContent=t.rate-t.discount_amount+" DA",c.classList.add("itemPrice"),c.style.fontSize="18px",c.style.fontWeight="600",c.style.width="90px",c.style.display="flex",c.style.flexDirection="row-reverse",r.appendChild(c),a.classList.add("rowBox","align_center","leftGroup"),i.appendChild(a),r.classList.add("rowBox","align_center","rightGroup"),i.appendChild(r),i.classList.add("rowBox","align_center","row_sbtw","ItemElement","pointer"),t.name==this.selected_item.name&&i.classList.add("selected"),i.addEventListener("click",l=>{this.makeItemHighlight(i),this.on_selected_item_click(t)}),e.appendChild(i)}),this.calculateNetTotal(),this.calculateVAT(),this.calculateQnatity(),this.calculateGrandTotal()}scrollToBottom(){console.log("scrolling"),this.selectedItemContainer.scrollTop(this.selectedItemContainer[0].scrollHeight)}createNewTab(){this.counter+=1,this.create_new_tab(this.counter),this.refreshTabs(),this.refreshSelectedItem()}createTabForEditPOS(){return this.counter+=1,this.counter}showKeyboard(){this.editSelectedItem.css("display","flex")}hideKeyboard(){this.editSelectedItem.css("display","none")}setKeyboardOrientation(e){let t=this.cartDetails.find("#discount"),i=this.cartDetails.find("#totalQuantity"),a=this.cartDetails.find("#netTotal"),r=this.cartDetails.find("#grandTotal");e=="landscape"?(this.cartDetails.css("display","flex"),this.cartDetails.addClass("rowBox align_center"),this.cartDetails.removeClass("columnBox"),t.css("display","none"),this.vat.css("display","none"),i.css("font-size","smaller"),a.css("font-size","smaller"),r.css("font-size","small"),r.css("font-weight","500")):(this.cartDetails.addClass("columnBox"),this.cartDetails.removeClass("rowBox"),this.settings_data.settings.showDiscountField&&t.css("display","flex"),this.vat.css("display","flex"),i.css("font-size","small"),a.css("font-size","small"),r.css("font-size","larger"),r.css("font-weight","700"))}makeSelectedButtonHighlighted(){let e=this.buttonsContainer.find("#key_quantity"),t=this.buttonsContainer.find("#key_rate"),i=this.buttonsContainer.find("#key_discount");this.selected_field.field_name=="quantity"?(e.addClass("selected"),t.removeClass("selected"),i.removeClass("selected")):this.selected_field.field_name=="rate"?(e.removeClass("selected"),t.addClass("selected"),i.removeClass("selected")):this.selected_field.field_name=="discount_percentage"?(e.removeClass("selected"),t.removeClass("selected"),i.addClass("selected")):(e.removeClass("selected"),t.removeClass("selected"),i.removeClass("selected"))}hideCart(){this.tabs_bar.css("display","none"),this.cartBox.css("display","none")}showCart(){this.tabs_bar.css("display","flex"),this.cartBox.css("display","flex")}setButtonsListeners(){let e=this.buttonsContainer.find("#key_0"),t=this.buttonsContainer.find("#key_1"),i=this.buttonsContainer.find("#key_2"),a=this.buttonsContainer.find("#key_3"),r=this.buttonsContainer.find("#key_4"),n=this.buttonsContainer.find("#key_5"),o=this.buttonsContainer.find("#key_6"),c=this.buttonsContainer.find("#key_7"),l=this.buttonsContainer.find("#key_8"),d=this.buttonsContainer.find("#key_9"),h=this.buttonsContainer.find("#key_quantity"),f=this.buttonsContainer.find("#key_discount"),g=this.buttonsContainer.find("#key_rate"),y=this.buttonsContainer.find("#key_remove"),_=this.buttonsContainer.find("#key_delete"),u=this.buttonsContainer.find("#key_point");[e,t,i,a,r,n,o,c,l,d,h,f,g,y,_,u].forEach(v=>{v.on("mousedown",w=>{w.preventDefault();let m=v.data("action");isNaN(m)?m=="."?this.on_key_pressed("addToField",m):m=="Quantity"?this.on_key_pressed("quantity",null):m=="Rate"?this.on_key_pressed("rate",null):m=="Discount"&&this.settings_data.settings.showDiscountField?this.on_key_pressed("discount",null):m=="Remove"?this.on_key_pressed("remove",null):m=="Delete"&&this.on_key_pressed("delete",null):this.on_key_pressed("addToField",m)})})}setListener(){this.add_tab_button.on("mousedown",e=>{this.createNewTab()}),this.tabs_container.find(".tabDeleteBtn").on("click",e=>{e.stopPropagation();let t=$(e.target).closest(".tab").find(".tabName").text();this.selected_item_maps.delete(t),this.selected_item_maps.size>0?this.selected_tab.tabName=Array.from(this.selected_item_maps.keys())[0]:this.createNewTab(),this.refreshTabs(),this.refreshSelectedItem()}),this.discountInput.on("input",e=>{if(e.target.value==""){this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage=0;return}else if(e.target.value>100){this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage=100;return}this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage=parseFloat(e.target.value),this.calculateNetTotal(),this.calculateVAT(),this.calculateGrandTotal()}),this.discountInput.on("blur",e=>{e.target.value==""?e.target.value=0:e.target.value>100&&(e.target.value=100),this.calculateNetTotal(),this.calculateVAT(),this.calculateGrandTotal()}),this.priceListInput.on("input",e=>{this.selected_item_maps.get(this.selected_tab.tabName).priceList=e.target.value,this.resetItemRateBaseOnPriceList(),this.refreshSelectedItem(),this.save_pos_invoice()}),this.customerInput.on("input",e=>{this.selected_item_maps.get(this.selected_tab.tabName).customer=e.target.value,this.save_pos_invoice()})}calculateNetTotal(){let e=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(i=>{e+=i.rate*i.qty}),this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage>0&&(e-=e*(this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage/100));let t=document.getElementById("netTotalValue");t.textContent=e,this.invoice_data.netTotal=e}calculateVAT(){this.sales_taxes.forEach(e=>{let t=0,i=e.rate/100,a=(this.invoice_data.netTotal*i).toFixed(2);this.taxes_map.set(e.name,a);let r=document.getElementById(`tax_${e.name}_Value`);r.textContent=this.taxes_map.get(e.name)})}calculateTotalTaxAmount(){let e=0;return this.taxes_map.forEach(t=>{e+=t}),e}calculateQnatity(){let e=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(i=>{e+=i.qty});let t=document.getElementById("totalQuantityValue");t.textContent=e}calculateGrandTotal(){let e=0,t=this.invoice_data.netTotal,i=0;this.taxes_map.forEach(r=>{i+=parseFloat(r)}),e=t+i;let a=document.getElementById("grandTotalValue");a.textContent=e.toFixed(2),this.invoice_data.grandTotal=e}resetItemRateBaseOnPriceList(){this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(e=>{e.rate=this.get_item_price(e,this.selected_item_maps.get(this.selected_tab.tabName).priceList),e.discount_percentage=0,e.discount_amount=0})}makeItemHighlight(e){document.getElementById("selectedItemsContainer").querySelectorAll(".selected").forEach(a=>{a.classList.remove("selected")}),e.classList.add("selected")}cleanHeighlight(){document.getElementById("selectedItemsContainer").querySelectorAll(".selected").forEach(i=>{i.classList.remove("selected")})}};pos_ar.PointOfSale.pos_item_details=class{constructor(e,t,i,a,r,n,o,c,l){this.wrapper=e,this.warehouse=t,this.price_lists=i,this.item_prices=a,this.selected_item=n,this.selected_field=o,this.on_input=c,this.on_close_cart=l,this.bin_list=r,this.start_the_work()}start_the_work(){this.prepare_item_details_cart(),this.setDetailsFieldsListeners()}prepare_item_details_cart(){this.wrapper.append('<div id="itemDetailsCart" class="columnBox align_center"><div>'),this.item_details_cart=this.wrapper.find("#itemDetailsCart"),this.item_details_cart.append('<div id="itemDetailsCartHeader" class="rowBox header align_center row_sbtw"></div>'),this.cart_header=this.item_details_cart.find("#itemDetailsCartHeader"),this.cart_header.append('<h4 class="CartTitle">Item Details</h4>'),this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="itemDetailsCartXBtn" class="xBtn">'),this.close_btn=this.cart_header.find("#itemDetailsCartXBtn").on("click",e=>{this.on_close_cart()}),this.item_details_cart.append('<div id="itemDetailsHeader" class="rowBox"></div>'),this.header_details=this.item_details_cart.find("#itemDetailsHeader"),this.header_details.append('<div id="detailsItemImage" class="rowBox centerItem"></div>'),this.header_details.append('<div id="price_and_name" class="columnBox"></div>'),this.price_and_name_details=this.header_details.find("#price_and_name"),this.price_and_name_details.append('<div id="detailsItemName" class="rowBox align_center"></div>'),this.price_and_name_details.append('<div id="detailsItemGroupWarhouseContainer" class="rowBox align_center row_sa"></divr>'),this.item_group_warehouse_details=this.price_and_name_details.find("#detailsItemGroupWarhouseContainer"),this.item_group_warehouse_details.append('<div id="detailsItemGroup" class="rowBox align_center">Group : ...</div>'),this.item_group_warehouse_details.append('<div id="detailsItemWarehouse" class="rowBox align_center">Warehouse : ...</div>'),this.item_details_cart.append('<div id="itemDetailsAll"  class="rowBox"></div>'),this.details_all=this.item_details_cart.find("#itemDetailsAll"),this.details_all.append('<div id="itemDetails_C1" class="columnBox"></div>'),this.c1=this.details_all.find("#itemDetails_C1"),this.c1.append('<div class="columnBox"><label for="itemDetailsQuantityInput">Quantity</label><input type="float" id="itemDetailsQuantityInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsRateInput">Rate</label><input type="float" id="itemDetailsRateInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsDiscountInput">Discount (%)</label><input type="float" id="itemDetailsDiscountInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsAvailableInput">Available Qty at Warehouse</label><input type="float" id="itemDetailsAvailableInput" disabled></div>'),this.details_all.append('<div id="itemDetails_C2" class="columnBox"></div>'),this.c2=this.details_all.find("#itemDetails_C2"),this.c2.append('<div class="columnBox"><label for="itemDetailsUomInput">UOM *</label><input type="text" id="itemDetailsUomInput"  disabled></div>'),this.c2.append('<div class="columnBox"><label for="detailsRateWithDescount">Discounted Rate</label>  <input type="text" id="discountedRateInput" disabled>  </div>'),this.c2.append('<div class="columnBox hideMe"><label for="detailsPriceList">Price List *</label><input list="detailsPriceList" id="detailsItemPriceListInput" class ="rowBox align_center pointerCursor"><datalist id="detailsPriceList"><option>fetching Price Lists ...</option></datalist></div>'),this.c2.append('<div class="columnBox"><label for="itemDetailsDiscountMontantInput">Discount (montant)</label><input type="float" id="itemDetailsDiscountMontantInput" class="pointerCursor"></div>'),this.c2.append('<div class="columnBox"><label for="itemDetailsPriceListRateInput">Price List Rate</label><input type="text" id="itemDetailsPriceListRateInput" disabled></div>')}refreshDate(e){var _,u;let t=document.getElementById("detailsItemImage"),i=document.getElementById("detailsItemName"),a=document.getElementById("detailsItemWarehouse"),r=document.getElementById("detailsItemGroup"),n=document.getElementById("itemDetailsQuantityInput"),o=document.getElementById("itemDetailsRateInput"),c=document.getElementById("discountedRateInput"),l=document.getElementById("itemDetailsDiscountInput"),d=document.getElementById("itemDetailsDiscountMontantInput"),h=document.getElementById("itemDetailsAvailableInput"),f=document.getElementById("itemDetailsUomInput"),g=document.getElementById("detailsItemPriceListInput"),y=document.getElementById("itemDetailsPriceListRateInput");if(e.image){let p=document.createElement("img");p.src=e.image,t.innerHTML="",t.appendChild(p)}else{let p=document.createElement("div");p.textContent=e.item_name[0],p.style.fontSize="xx-large",p.style.fontWeight="700",t.innerHTML="",t.appendChild(p)}i.textContent=e.item_name,i.classList.add("rowBox","align_center"),n.value=e.qty,o.value=e.rate,c.value=e.rate-e.discount_amount,d.value=(_=e.discount_amount)!=null?_:0,l.value=(u=e.discount_percentage)!=null?u:0,h.value=this.getQtyInWarehouse(e.name,this.warehouse),f.value=e.stock_uom,g.value=this.price_lists[0].price_list_name,a.textContent="Warehouse : "+this.warehouse,r.textContent="Item Group : "+e.item_group,y.value=this.getItemPrice(e.name)+"DA",console.log("end ref"),this.makeSelectedFieldHighlighted()}show_cart(){this.item_details_cart.css("display","flex")}hide_cart(){this.item_details_cart.css("display","none")}makeSelectedFieldHighlighted(){this.selected_field.field_name=="quantity"?(this.c1.find("#itemDetailsQuantityInput").addClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected")):this.selected_field.field_name=="rate"?(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").addClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected")):this.selected_field.field_name=="discount_percentage"?(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").addClass("selected")):(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected"))}requestFocus(e){e=="quantity"?this.c1.find("#itemDetailsQuantityInput").focus():e=="rate"?this.c1.find("#itemDetailsRateInput").focus():e=="discount_percentage"?this.c1.find("#itemDetailsDiscountInput").focus():e=="discount_amount"&&this.c1.find("#itemDetailsDiscountMontantInput").focus()}addToField(e,t){console.log("field : ",e,"value : ",t),e=="quantity"?this.c1.find("#itemDetailsQuantityInput").val((i,a)=>t=="."&&a.includes(".")?a:a+t):e=="rate"?this.c1.find("#itemDetailsRateInput").val((i,a)=>t=="."&&a.includes(".")?a:a+t):e=="discount_percentage"?this.c1.find("#itemDetailsDiscountInput").val((i,a)=>t=="."&&a.includes(".")?a:a+t):e=="discount_amount"&&this.c1.find("#itemDetailsDiscountInput").val((i,a)=>t=="."&&a.includes(".")?a:a+t)}deleteCharacter(){let e=this.selected_field.field_name,t=0;if(e=="quantity"){let i=this.c1.find("#itemDetailsQuantityInput"),a=i[0].selectionStart;i.val((r,n)=>n.length<0||n.length==1?(t=0,0):a==0?(t=n,n):a==n.length?(t=n.slice(0,a-1),n.slice(0,a-1)):(t=n.slice(0,a-1)+n.slice(a),n.slice(0,a-1)+n.slice(a))),setTimeout(()=>{i[0].setSelectionRange(a-1,a-1),i[0].focus()},0)}if(e=="rate"){let i=this.c1.find("#itemDetailsRateInput"),a=i[0].selectionStart;i.val((r,n)=>n.length<0||n.length==1?(t=0,0):a==0?(t=n,n):a==n.length?(t=n.slice(0,a-1),n.slice(0,a-1)):(t=n.slice(0,a-1)+n.slice(a),n.slice(0,a-1)+n.slice(a))),setTimeout(()=>{i[0].setSelectionRange(a-1,a-1),i[0].focus()},0)}if(e=="discount_percentage"){let i=this.c1.find("#itemDetailsDiscountInput"),a=i[0].selectionStart;i.val((r,n)=>n.length<0||n.length==1?(t=0,0):a==0?(t=n,n):a==n.length?(t=n.slice(0,a-1),n.slice(0,a-1)):(t=n.slice(0,a-1)+n.slice(a),n.slice(0,a-1)+n.slice(a))),setTimeout(()=>{i[0].setSelectionRange(a-1,a-1),i[0].focus()},0)}return console.log("we reach to here "),t}setDetailsFieldsListeners(){this.quantityInput=this.c1.find("#itemDetailsQuantityInput"),this.rateInput=this.c1.find("#itemDetailsRateInput"),this.discountInput=this.c1.find("#itemDetailsDiscountInput"),this.discountMontantInput=this.c2.find("#itemDetailsDiscountMontantInput"),this.quantityInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||t[t.length-1]==" "||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=parseFloat(this.quantityInput.val());if(isNaN(i)){console.warn("Invaide Quantity value =>",this.quantityInput.val());return}else i<=0&&(i=0);this.on_input("input","quantity",i)}),this.quantityInput.on("focus",e=>{this.on_input("focus","quantity",null)}),this.quantityInput.on("blur",e=>{this.on_input("blur","quantity",null)}),this.rateInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=parseFloat(this.rateInput.val());if(console.log("new rate : ",i),isNaN(i)){console.warn("Invalide Rate value");return}this.on_input("input","rate",i)}),this.rateInput.on("focus",e=>{this.on_input("focus","rate",null)}),this.rateInput.on("blur",e=>{this.on_input("blur","rate",null)}),this.discountInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=this.discountInput.val();if(console.log("the new value ",i),isNaN(i)){console.warn("Invalide discount value");return}i<100?this.on_input("input","discount_percentage",i):(e.target.value=100,this.on_input("input","discount_percentage",100))}),this.discountInput.on("focus",e=>{this.on_input("focus","discount_percentage",null)}),this.discountInput.on("blur",e=>{this.on_input("blur","discount_percentage",null)}),this.discountMontantInput.on("input",e=>{let t=e.target.value;t.length==0?e.target.value=0:!t.slice(0,-1).includes(".")&&t[t.length-1]=="."?e.target.value=t:t[t.length-1]=="."||isNaN(t[t.length-1])?e.target.value=t.slice(0,-1):e.target.value=t;let i=this.discountMontantInput.val();if(isNaN(i)){console.warn("Invalide discount value");return}this.on_input("input","discount_amount",i)}),this.discountMontantInput.on("focus",e=>{console.log("we are here"),this.on_input("focus","discount_amount",null)}),this.discountMontantInput.on("blur",e=>{this.on_input("blur","discount_amount",null)})}getItemPrice(e){let t=this.item_prices.find(i=>i.item_code==e);return t?t.price_list_rate:0}getQtyInWarehouse(e,t){let i=this.bin_list.find(a=>a.item_code==e&&a.warehouse==t);return i?i.actual_qty:0}};pos_ar.PointOfSale.pos_payment_cart=class{constructor(e,t,i,a,r,n,o,c,l,d){this.wrapper=e,this.selected_item_map=t,this.selected_tab=i,this.app_data=a,this.payment_methods=r,this.selected_payment_method=n,this.invoice_data=o,this.on_close_cart=c,this.on_complete=l,this.on_input=d,this._payment_method=this.payment_methods[0],this.start_work()}start_work(){this.prepare_payment_cart(),this.calculateGrandTotal(),this.setListeners()}prepare_payment_cart(){this.wrapper.append('<div id="paymentMethodCart" class="columnBox align_center"></div>'),this.cart=this.wrapper.find("#paymentMethodCart"),this.cart.append('<div id="paymentMethodCartHeader" class="rowBox header align_center row_sbtw"></div>'),this.cart.append('<div id="paymentMethodContent" class="columnBox align_center"></div>'),this.cart.append('<div id="paymentMethodCartFooter" class="columnBox align_center"></div>'),this.cart_header=this.cart.find("#paymentMethodCartHeader"),this.cart_content=this.cart.find("#paymentMethodContent"),this.cart_footer=this.cart.find("#paymentMethodCartFooter"),this.cart_header.append('<h4 class="CartTitle">Item Details</h4>'),this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="paymentMethodCartXBtn" class="xBtn">'),this.cart_header.find("#paymentMethodCartXBtn").on("click",e=>{this.on_close_cart()}),this.cart_content.append('<div id="paymentContentTopSection" class="rowBox"></div>'),this.cart_content.append('<div id="paymentContentBottomSection" class="columnBox"></div>'),this.cart_content_top_section=this.cart_content.find("#paymentContentTopSection"),this.cart_content_bottom_section=this.cart_content.find("#paymentContentBottomSection"),this.payment_methods.forEach(e=>{let t=this._payment_method.name==e.name?"selected":"",i=this.getModeOfPaymentById(e.mode_of_payment).type=="Phone"?"display:none;":"";this.cart_content_top_section.append(`<div id="${e.name}" class="paymentMethodBox ${t}"><div id="BoxTitle" class="title ${t}">${e.mode_of_payment}</div><input type="number" id="cachInput" class="paymentInput" value="0" style="${i}"  ></div>`)}),this.cart_content_bottom_section.append("<h4>Additional Information</h4>"),this.cart_footer.append('<div id="paymentDetailsContainer" class="rowBox align_center"></div>'),this.cart_footer.append('<button class="posBtn1" type="button" id="completeOrderBtn">Complete Order</button>'),this.payment_details=this.cart_footer.find("#paymentDetailsContainer"),this.payment_details.append('<div class="columnBox"><div id="paymentGrandTotalTitle" class="rowBox centerItem">Grand Total</div><div id="paymentGrandTotalValue" class="rowBox centerItem"></div></div>'),this.payment_details.append("<hr>"),this.payment_details.append('<div id="paymentPaidAmount" class="columnBox"><div id="paymentPaidAmountTitle" class="rowBox centerItem">Paid Amount</div><div id="paimentPaidAmountValue"  class="rowBox centerItem"> 0 DA </div></div>'),this.payment_details.append("<hr>"),this.payment_details.append(`<div id="paymentToChange" class="columnBox"><div id="paimentToChangeTitle" class="rowBox centerItem">To Change</div><div id="paimentToChangeValue"  class="rowBox centerItem"> ${this.calculateToChange()} DA </div></div>`)}preparDefault(){this.calculateGrandTotal();let e=$(`#${this._payment_method.name}`);e.length&&(e.find(".paymentInput").val(this.invoice_data.grandTotal),this.selected_item_map.get(this.selected_tab.tabName).payments.forEach(t=>{t.mode_of_payment==this._payment_method.mode_of_payment&&(t.amount=this.invoice_data.grandTotal)}),this.updatePaidAmount(),this.updateToChange())}showCart(){this.cart.css("display","flex"),this.preparDefault()}hideCart(){this.cart.css("display","none")}setListeners(){let e=this;this.cart_content_top_section.on("click",".paymentMethodBox",function(){$(".paymentMethodBox").removeClass("selected"),$(".paymentMethodBox div.title").removeClass("selected"),$(this).addClass("selected"),$(this).find(".title").addClass("selected");let t=$(this).attr("id");e.payment_methods.forEach(i=>{i.name==t&&(e._payment_method=i)}),$(".paymentMethodBox").not(this).find(".paymentInput").val(0),$(this).find(".paymentInput").val(e.invoice_data.grandTotal),e.selected_item_map.get(e.selected_tab.tabName).payments.forEach(i=>{i.mode_of_payment!=e._payment_method.mode_of_payment||e.getModeOfPaymentById(i.mode_of_payment).type=="Phone"?i.amount=0:i.amount=e.invoice_data.grandTotal}),e.updatePaidAmount(),e.updateToChange()}),this.cart_content_top_section.on("input",".paymentInput",function(){let t=parseFloat($(this).val())||0,i=$(this).closest(".paymentMethodBox").attr("id");e.selected_item_map.get(e.selected_tab.tabName).payments.forEach(a=>{a.mode_of_payment==e._payment_method.mode_of_payment&&(a.amount=parseFloat(t))}),e.updatePaidAmount(),e.updateToChange()}),this.cart_footer.find("#completeOrderBtn").on("click",t=>{frappe.confirm("Submit the invoice ?",()=>{this.on_complete()},()=>{})})}handleInput(e){}deleteKeyPress(){let e=this.cashBox.find("#cachInput"),t=0,i=e[0].selectionStart;e.val((a,r)=>r.length<0?(console.log("cnd 1"),t=0,0):r.length==1?(console.log("cnd 2"),t=0,0):i==0?(console.log("cnd 3"),t=r,r):i==r.length?(console.log("cnd 4"),t=r.slice(0,i-1),r.slice(0,i-1)):(console.log("cursor : ",i," current val ==> ",r," cnd 5 newValue ==> ",r.slice(0,i-1)+r.slice(i)),t=r.slice(0,i-1)+r.slice(i),r.slice(0,i-1)+r.slice(i))),console.log("we are in newValue ==> ",t),this.invoice_data.paidAmount=t,setTimeout(()=>{e[0].setSelectionRange(i-1,i-1),e[0].focus()},0),this.refreshData()}calculatePaidAmount(){let e=0;return this.selected_item_map.get(this.selected_tab.tabName).payments.forEach(t=>{e+=t.amount}),e}updatePaidAmount(){this.payment_details.find("#paimentPaidAmountValue").text(`${this.calculatePaidAmount()} DA`)}calculateToChange(){return console.log("see why the error "," calculatePaidAmount ",this.calculatePaidAmount()," grandTotal ",this.invoice_data.grandTotal),this.calculatePaidAmount()-this.invoice_data.grandTotal}updateToChange(){this.payment_details.find("#paimentToChangeValue").text(`${this.calculateToChange().toFixed(2)} DA`)}calculateGrandTotal(){return this.payment_details.find("#paymentGrandTotalValue").text(`${this.invoice_data.grandTotal.toFixed(2)} DA`),parseFloat(this.invoice_data.grandTotal.toFixed(2))}getModeOfPaymentById(e){let t=null;return this.app_data.posProfileModeOfPayments.forEach(i=>{i.name==e&&(t=i)}),t}};pos_ar.PointOfSale.pos_history=class{constructor(e,t,i,a,r,n){this.wrapper=e,this.db=t,this.selected_pos_profile=i,this.company=a,this.sales_taxes=r,this.on_click=n,this.localPosInvoice={lastTime:null,pos_invoices:[]},this.filter="",this.filtered_pos_list=[],this.selected_pos=null,this.start_work()}async start_work(){this.prepare_history_cart();let e=await this.db.getAllPosInvoice();console.log("the db data ",e),this.localPosInvoice.pos_invoices=e,this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(t=>t.status=="Draft"),console.log("log init data : ",this.filtered_pos_list),this.filtered_pos_list.length==0?(this.selected_pos=null,console.log("first condition")):(this.selected_pos=structuredClone(this.filtered_pos_list[0]),console.log("second condition")),this.refreshData(),this.setListener()}prepare_history_cart(){this.wrapper.find("#LeftSection").append('<div id="historyLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="historyRightContainer" class="columnBox"></div>'),this.left_container=this.wrapper.find("#historyLeftContainer"),this.right_container=this.wrapper.find("#historyRightContainer"),this.left_container.append('<div id="PosContentHeader" class="rowBox" ><div class="c1 columnBox"><div id="posCustomer">Customer</div><div id="posSoldBy"></div></div><div class="c2 columnBox"><div id="posCost">0,0000 DA</div><div id="posId">ACC-PSINV-2024-ID</div><div id="posStatus">POS Status</div></div></div>'),this.pos_header=this.left_container.find("#PosContentHeader"),this.left_container.append('<div id="posContent" class="columnBox"></div>'),this.pos_content=this.left_container.find("#posContent"),this.pos_content.append('<div id="posItemContainer"><div class="posSectionTitle">Items</div><div id="posItemList"></div></div>'),this.itemContainer=this.pos_content.find("#posItemContainer"),this.itemList=this.itemContainer.find("#posItemList"),this.pos_content.append('<div id="posTotalsContainer"><div class="posSectionTitle">Totals</div><div id="posTotalList"></div></div>'),this.totalsContainer=this.pos_content.find("#posTotalsContainer"),this.totalList=this.pos_content.find("#posTotalList"),this.pos_content.append('<div id="posPaymentsContainer"><div class="posSectionTitle">Payments</div><div id="posMethodList"></div></div>'),this.paymentsContainer=this.pos_content.find("#posPaymentsContainer"),this.methodList=this.pos_content.find("#posMethodList"),this.left_container.append('<div id="posActionsContainer" class="rowBox align_content"  style="display = none ;" > <div id="posPrintBtn" class="actionBtn rowBox centerItem"> Print Receipt </div>  <div id="posEmailBtn" class="actionBtn rowBox centerItem"> Email Receipt </div>   <div id="posReturnBtn" class="actionBtn rowBox centerItem"> Return </div>  </div>'),this.left_container.append('<div id="posDraftActionsContainer" class="rowBox align_content" style="display = none ;"> <div id="posEditBtn" class="actionBtn rowBox centerItem"> Edit Invoice </div>  <div id="posDeleteBtn" class="actionBtn rowBox centerItem"> Delete Invoice </div>  </div>'),this.actionButtonsContainer=this.left_container.find("#posActionsContainer"),this.printBtn=this.actionButtonsContainer.find("#posPrintBtn"),this.emailBtn=this.actionButtonsContainer.find("#posEmailBtn"),this.returnBtn=this.actionButtonsContainer.find("#posReturnBtn"),this.draftActionButtonsContainer=this.left_container.find("#posDraftActionsContainer"),this.deleteBtn=this.draftActionButtonsContainer.find("#posDeleteBtn"),this.editBtn=this.draftActionButtonsContainer.find("#posEditBtn"),this.right_container.append('<div id="historyRightContainerHeader" class="rowBox align_center" ><h4 class="CartTitle">Recent Orders</h4></div>'),this.right_container.append('<div id="historyRightSearchContainer" class="rowBox align_center" ></div>'),this.search_container=this.right_container.find("#historyRightSearchContainer"),this.search_container.append('<select  id="PosInvoiceTypeInput" placeholder="POS Invoice Type">'),this.filter_input=this.search_container.find("#PosInvoiceTypeInput"),this.filter_input.append('<option value="Draft">Draft</option><option value="Paid">Paid</option> <option value="Unpaid">Unpaid</option>'),this.search_container.append('<input type="text" id="historyInput" placeholder="Search by invoice id or custumer name">'),this.right_container.append('<div id="historyRecentInvoicesContainer" ></div>'),this.right_data_container=this.right_container.find("#historyRecentInvoicesContainer")}refreshData(){this.right_data_container.html(""),this.filtered_pos_list.forEach(e=>{var h;let t=document.createElement("div");t.classList.add("posInvoiceContainer"),t.classList.add("columnBox"),t.classList.add("align_content");let i=document.createElement("div");i.classList.add("l1"),i.classList.add("rowBox"),i.classList.add("align_content");let a=document.createElement("div");a.classList.add("posName"),a.textContent=e.name;let r=document.createElement("div");r.classList.add("posCost"),r.textContent=(h=e.paid_amount)!=null?h:0+" DA",i.appendChild(a),i.appendChild(r);let n=document.createElement("div");n.classList.add("l2"),n.classList.add("rowBox"),n.classList.add("align_content");let o=document.createElement("div");o.classList.add("customer"),o.classList.add("rowBox"),o.classList.add("align_content");let c=document.createElement("img");c.src="/assets/pos_ar/images/customer.png",c.width=16,c.height=16,c.classList.add("customerLogo");let l=document.createElement("div");l.textContent=e.customer,l.classList.add("customerName"),o.appendChild(c),o.appendChild(l),n.appendChild(o);let d=document.createElement("div");d.textContent=e.creation_time,n.appendChild(d),t.appendChild(i),t.appendChild(n),t.addEventListener("click",()=>{this.selected_pos=e,this.refreshPosDetailsData()}),this.right_data_container.append(t)}),this.refreshPosDetailsData()}refreshPosDetailsData(){var a,r,n;if(this.selected_pos==null){this.setEmpty();return}else this.setData();this.pos_header.find("#posCustomer").text((a=this.selected_pos.customer)!=null?a:"CustomerName"),this.pos_header.find("#posCost").text((r=this.selected_pos.paid_amount)!=null?r:0+"DA"),this.pos_header.find("#posId").text((n=this.selected_pos.name)!=null?n:"POS Invoice Name"),this.pos_header.find("#posStatus").text(this.selected_pos.status),this.pos_header.find("#posStatus").removeClass().addClass(`${this.selected_pos.status}`),this.selected_pos.status=="Draft"?(this.draftActionButtonsContainer.css("display","flex"),this.actionButtonsContainer.css("display","none")):(this.draftActionButtonsContainer.css("display","none"),this.actionButtonsContainer.css("display","flex")),this.itemList.html(""),this.selected_pos.items.forEach(o=>{this.itemList.append(`<div class="rowBox align_item">    <div class="itemName rowBox align_center">${o.item_name}</div>   <div class="itemQuantity rowBox align_center">${o.qty}</div>   <div class="itemCost rowBox align_center">${o.qty*o.rate} DA</div>  </div>`)}),this.totalList.html("");let e=0;this.selected_pos.items.forEach(o=>{e+=o.rate*o.qty}),this.totalList.append(`<div class="rowBox align_item"> <div class="name rowBox align_center">Net Total</div> <div class="price rowBox align_center">${e} DA</div> </div>`);let t=0;this.selected_pos.taxes_and_charges!=""&&this.selected_pos.taxes_and_charges!=null&&this.sales_taxes.forEach(o=>{t+=o.rate/100*e,this.totalList.append(`<div class="rowBox align_item"> <div class="name rowBox align_center">${o.description}</div> <div class="price rowBox align_center">${o.rate/100*e} DA</div> </div>`)}),this.totalList.append(`<div class="rowBox align_item"> <div class="grandTotalName rowBox align_center">Grand Total</div> <div class="grandTotalPrice rowBox align_center">${e+t} DA</div> </div>`),this.methodList.html("");let i=this.selected_pos.payments;i!=null&&i!=""&&i.forEach(o=>{this.methodList.append(`<div class="rowBox align_item"> <div class="name rowBox align_center">${o.mode_of_payment}</div> <div class="price rowBox align_center">${o.amount} DA</div> </div>`)})}show_cart(){this.left_container.css("display","flex"),this.right_container.css("display","flex");let e=this.filter_input.val();console.log("filter : ",e),this.db.getAllPosInvoice_callback(t=>{console.log("look at the result : ",t),this.localPosInvoice.pos_invoices=t,this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(i=>i.status==e),this.filtered_pos_list.length==0?this.selected_pos=null:this.selected_pos=structuredClone(this.filtered_pos_list[0]),this.refreshData()},t=>{console.log(t)})}hide_cart(){this.left_container.css("display","none"),this.right_container.css("display","none")}setEmpty(){this.pos_header.css("display","none"),this.pos_content.css("display","none"),this.actionButtonsContainer.css("display","none"),this.draftActionButtonsContainer.css("display","none")}setData(){this.pos_header.css("display","flex"),this.pos_content.css("display","flex")}setListener(){this.filter_input.on("input",e=>{let t=e.target.value;console.log("filter : ",t),this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(i=>t==""?!0:t==i.status),this.filtered_pos_list.length==0?this.selected_pos=null:this.selected_pos=this.filtered_pos_list[0],this.refreshData()}),this.deleteBtn.on("click",e=>{this.db.deletePosInvoice_callback(this.selected_pos.name,t=>{this.filtered_pos_list=this.filtered_pos_list.filter(i=>i.name!=this.selected_pos.name),this.filtered_pos_list.length>0?this.selected_pos=this.filtered_pos_list[0]:this.selected_pos=null,this.refreshData()},t=>{console.log("error on deleting the pos : ",t)})}),this.editBtn.on("click",e=>{this.on_click("edit",this.selected_pos)}),this.returnBtn.on("click",e=>{this.on_click("return",null)}),this.printBtn.on("click",e=>{this.print_receipt(this.selected_pos)})}print_receipt(e){let t=0,i=0,a=0,r=e.creation_time,[n,o]=r.split(" ");console.log("check the logo : ",this.company.company_logo);let c=`<style>#company_container {width: 100% ; height: 40px ; display:flex; align-items:center; font-size : 12px;}table{width: 100%; margin-top:16px;}tr{width:100%; height:16px;}tr:nth-child(1){}#first_row{border: 5px solid black;}#logContainer{width: 100%;height:80px;display : flex;justify-content:center;}#logContainer img{width:50%; height:100%;}#top_data_container{width:100%;display:flex;}#top_data_container>div.c1{font-size:12px;flex-grow:1;}#top_data_container>div.c2{font-size:12px;flex-grow:1;display:flex;flex-direction:column;align-items:end;}td>div{height:18px; width:100%;font-size:12px;display:flex; justify-content:start; align-items:center;}#footer_message{height:20px;}</style><div style="display:flex; flex-direction:column;"><div id="logContainer"  ><div style="width:20%;"></div><img src="http://makid_store.localhost:8000/files/1661795110-optilance.png"><div style="width:20%;"></div></div><div id="company_container"><div style="flex-grow:1;"></div><p style="margin:0px 25px;">${this.company.company_name}</p><div style="flex-grow:1;"></div></div><div id="top_data_container"><div class="c1"><div class="customer" style="font-weight:600;font-size:18px;"> Customer : ${e.customer} </div><div class="refrence"> Commande : ${e.refNum} </div></div><div class="c2"><div class="date"> ${n}/${o} </div></div></div><table><tr id="first_row" ><th style="boder:1px solid black;">Nom</th><th>Qt\xE9</th><th>Prix</th><th>Value</th>`;e.items.forEach(d=>{t+=d.rate*d.qty,c+=`<tr > <td ><div >${d.item_name}</div></td>  <td><div>${d.qty}</div></td>  <td><div>${d.rate}</div></td>  <td><div>${d.rate*d.qty}</div></td></tr>`}),c+="</table>",c+=`<div style="height:23px;"> <p style="font-size:12px;font-weight:500;" ><span style="font-size:12px;font-weight:600;">Sous-total : </span> ${t} DA </p> </div>`,c+=`<div style="height:23px;"> <p style="font-size:12px;font-weight:500;" ><span style="font-size:12px;font-weight:600;">Reduction : </span> ${e.additional_discount_percentage*t} DA </p> </div>`,this.sales_taxes.forEach(d=>{i+=d.rate,c+=`<div style="height:23px;"> <p style="font-size:12px;font-weight:500;" ><span style="font-size:12px;font-weight:600;">${d.description} : </span> ${d.rate} % </p> </div>`}),c+=`<div style="height:23px;"> <p style="font-size:12px;font-weight:500;" ><span style="font-size:12px;font-weight:600;">Total : </span> ${t+t*(i/100)-e.additional_discount_percentage*t} DA </p> </div>`,c+='<div id="footer_message" style="width:100%; display:flex; align-items:center; margin-top:30px;"><div style="flex-grow:1;"></div><div style="margin:30px 25px;"> Thank You, Come Again</div><div style="flex-grow:1;"></div></div>',c+="</div>";let l=window.open("","_blank");l.document.write(c),l.document.close(),l.focus(),l.print(),l.close()}};pos_ar.PointOfSale.pos_db=class{constructor(t){this.db=t,this.setupDatabase()}static async openDatabase(){return new Promise((t,i)=>{let a=window.indexedDB.open("POSDB_test33",1);a.onerror=r=>{i(a.error)},a.onsuccess=r=>{t(new pos_ar.PointOfSale.pos_db(r.target.result))},a.onupgradeneeded=r=>{let n=r.target.result;n.objectStoreNames.contains("Customer")||n.createObjectStore("Customer",{keyPath:"name"}),n.objectStoreNames.contains("Item Group")||n.createObjectStore("Item Group",{keyPath:"name"}),n.objectStoreNames.contains("Item")||n.createObjectStore("Item",{keyPath:"name"}),n.objectStoreNames.contains("Item Price")||n.createObjectStore("Item Price",{keyPath:"name"}),n.objectStoreNames.contains("Price List")||n.createObjectStore("Price List",{keyPath:"name"}),n.objectStoreNames.contains("Warehouse")||n.createObjectStore("Warehouse",{keyPath:"name"}),n.objectStoreNames.contains("POS Profile")||n.createObjectStore("POS Profile",{keyPath:"name"}),n.objectStoreNames.contains("Bin")||n.createObjectStore("Bin",{keyPath:"name"}),n.objectStoreNames.contains("POS Invoice")||n.createObjectStore("POS Invoice",{keyPath:"name"}).createIndex("docstatus","docstatus",{unique:!1}),n.objectStoreNames.contains("check_in_out")||n.createObjectStore("check_in_out",{keyPath:"name"}),n.objectStoreNames.contains("POS Settings")||n.createObjectStore("POS Settings",{keyPath:"id"})}})}setupDatabase(){this.db.onerror=t=>{var i;console.error(`Database error: ${(i=t.target.error)==null?void 0:i.message}`)}}getPosCounter(){return new Promise((t,i)=>{let r=this.db.transaction(["Counter"],"readwrite").objectStore("Counter")})}saveItemList(t){return new Promise((i,a)=>{let r=this.db.transaction(["Item"],"readwrite"),n=r.objectStore("Item");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving Item : ",o,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving Item."),a(o)}})}getAllItems(){return new Promise((t,i)=>{let n=this.db.transaction(["Item"],"readwrite").objectStore("Item").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}savePosProfileList(t){return new Promise((i,a)=>{let r=this.db.transaction(["POS Profile"],"readwrite"),n=r.objectStore("POS Profile");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving POS Profile : ",o,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving POS Profile."),a(o)}})}getAllPosProfile(){return new Promise((t,i)=>{let n=this.db.transaction(["POS Profile"],"readwrite").objectStore("POS Profile").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{let c=event.target.result;i(c)}})}saveBinList(t){return new Promise((i,a)=>{let r=this.db.transaction(["Bin"],"readwrite"),n=r.objectStore("Bin");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving Bin : ",o,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving Bin."),a(o)}})}getAllBin(){return new Promise((t,i)=>{let n=this.db.transaction(["Bin"],"readwrite").objectStore("Bin").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}saveWarehouseList(t){return new Promise((i,a)=>{let r=this.db.transaction(["Warehouse"],"readwrite"),n=r.objectStore("Warehouse");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving Warehouse : ",o,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving Warehouse List."),a(o)}})}getAllWarehouse(){return new Promise((t,i)=>{let n=this.db.transaction(["Warehouse"],"readwrite").objectStore("Warehouse").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}savePriceLists(t){return new Promise((i,a)=>{let r=this.db.transaction(["Price List"],"readwrite"),n=r.objectStore("Price List");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving Price List : ",itemPrice,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving Price Lists."),a(o)}})}getAllPriceList(){return new Promise((t,i)=>{let n=this.db.transaction(["Price List"],"readwrite").objectStore("Price List").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}saveItemPriceList(t){return new Promise((i,a)=>{let r=this.db.transaction(["Item Price"],"readwrite"),n=r.objectStore("Item Price");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving Item Price : ",o,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving Item Price."),a(o)}})}getAllItemPrice(){return new Promise((t,i)=>{let n=this.db.transaction(["Item Price"],"readwrite").objectStore("Item Price").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}saveItemGroupList(t){return new Promise((i,a)=>{let r=this.db.transaction(["Item Group"],"readwrite"),n=r.objectStore("Item Group");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{a(l),console.error("db => error saving Item Group : ",o,"err : ",l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving Item Group."),a(o)}})}getAllItemGroup(){return new Promise((t,i)=>{let n=this.db.transaction(["Item Group"],"readwrite").objectStore("Item Group").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}saveCustomerList(t){return new Promise((i,a)=>{let r=this.db.transaction(["Customer"],"readwrite"),n=r.objectStore("Customer");t.forEach(o=>{let c=n.put(o);c.onerror=l=>{console.error("db => error saving customer : ",o,"err : ",l),a(l)}}),r.oncomplete=()=>{i()},r.onerror=o=>{console.error("db => error saving customer."),a(o)}})}getAllCustomers(){return new Promise((t,i)=>{let n=this.db.transaction(["Customer"],"readonly").objectStore("Customer").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{console.error("error when getting customer from db"),i(event)}})}savePosInvoice(t){return new Promise((i,a)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").put(t);o.onsuccess=c=>{i(c)},o.onerror=c=>{a(c)}})}updatePosInvoice(t){return new Promise((i,a)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").put(t);o.onsuccess=c=>{i(c.target.result)},o.onerror=c=>{a(c)}})}getAllPosInvoice(){return new Promise((t,i)=>{let n=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}getAllPosInvoice_callback(t,i){let n=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}}getDraftPosInvoice(){return new Promise((t,i)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("docstatus").getAll(0);o.onsuccess=c=>{t(c.target.result)},o.onerror=c=>{i(c)}})}getNotSyncedPosNumber(t,i){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("docstatus").getAll(1);o.onsuccess=c=>{let l=c.target.result.filter(d=>d.synced==!1);t(l.length)},o.onerror=c=>{i(c)}}getNotSyncedPos(t,i){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("docstatus").getAll(1);o.onsuccess=c=>{let l=c.target.result.filter(d=>d.synced==!1);t(l)},o.onerror=c=>{i(c)}}deletePosInvoice(t){return new Promise((i,a)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").delete(t);o.onsuccess=()=>{i()},o.onerror=c=>{a(c)}})}deletePosInvoice_callback(t,i,a){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").delete(t);o.onsuccess=()=>{i()},o.onerror=c=>{a(c)}}deleteAllPosInvoice(){return new Promise((t,i)=>{let n=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").clear();n.onsuccess=()=>{t()},n.onerror=o=>{i(o)}})}saveCheckInOut(t,i,a){let o=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").put(t);o.onsuccess=c=>{i(c.target.result)},o.onerror=c=>{a(c)}}getAllCheckInOut(){return new Promise((t,i)=>{let n=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}})}getAllCheckInOut_callback(t,i){let n=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").getAll();n.onsuccess=o=>{let c=o.target.result;t(c)},n.onerror=o=>{i(o)}}deleteAllCheckInOut(){return new Promise((t,i)=>{let n=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").clear();n.onsuccess=()=>{t()},n.onerror=o=>{i(o)}})}updateSettings(t){return new Promise((i,a)=>{let o=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").put(I({id:1},t));o.onsuccess=c=>{i(c.target.result)},o.onerror=c=>{a(c)}})}updateSettings_callback(t,i,a){let o=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").put(I({id:1},t));o.onsuccess=c=>{i(c.target.result)},o.onerror=c=>{a(c)}}getSettings(t,i){let n=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").get(1);n.onsuccess=o=>{t(o.target.result)},n.onerror=o=>{i(o)}}deleteAllSettings(){return new Promise((t,i)=>{let n=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").clear();n.onsuccess=()=>{t()},n.onerror=o=>{i(o)}})}};pos_ar.PointOfSale.pos_settings=class{constructor(e,t,i,a){this.wrapper=e,this.settings_data=t,this.selected_pos_profile=i,this.on_settings_change=a,this.scene="pos_profile",this.start_work()}start_work(){this.prepareSettingsCart(),this.refreshLeftSection(),this.setListener()}prepareSettingsCart(){this.wrapper.find("#RightSection").append('<div id="settingsRightContainer" class="columnBox"></div>'),this.wrapper.find("#LeftSection").append('<div id="settingsLeftContainer" class="columnBox"></div>'),this.leftContainer=this.wrapper.find("#settingsLeftContainer"),this.rightContainer=this.wrapper.find("#settingsRightContainer"),this.rightContainer.append('<div id="pos_profile_btn"      class="settings_tab active" >POS Profile</div>'),this.rightContainer.append('<div id="general_settings_btn" class="settings_tab"        >Generale Settings</div>'),this.rightContainer.append('<div id="about_us_btn"         class="settings_tab"        >About Us</div>'),this.pos_profile_btn=this.rightContainer.find("#pos_profile_btn"),this.general_settings_btn=this.rightContainer.find("#general_settings_btn"),this.about_us_btn=this.rightContainer.find("#about_us_btn")}refreshLeftSection(){this.leftContainer.html(""),this.scene=="pos_profile"?this.refreshPosProfileScene():this.scene=="general_settings"?this.refreshGeneralSettings():this.scene=="about_us"&&this.refreshAboutUs()}refreshPosProfileScene(){this.leftContainer.addClass("columnBox"),this.leftContainer.append('<h4 class="CartTitle" style="margin-bottom:35px; font-size:35px;" >POS Profile</h4>'),this.leftContainer.append('<div id="settingsCartContentsContainer">  </div>'),this.contentsContainer=this.leftContainer.find("#settingsCartContentsContainer"),this.contentsContainer.append('<div id="posProfileContent" class="contentContainer rowBox" style="width:100%;"> <div class="c1 columnBox"></div>   <div class="c2 columnBox"></div> </div>'),this.pos_profile_content=this.contentsContainer.find("#posProfileContent"),this.c1=this.pos_profile_content.find("div.c1"),this.c2=this.pos_profile_content.find("div.c2"),this.c1.append('<label for="pos_profile"> POS Profile </label>'),this.c1.append('<select  name="pos_profile" id="posProfileSelect" disabled ></select>'),this.pos_profile_select=this.c1.find("#posProfileSelect"),this.pos_profile_select.append(`<option value="${this.selected_pos_profile.name} selected ">${this.selected_pos_profile.name}</option>`),this.c1.append('<label for="warehouse">POS Warehouse</label>'),this.c1.append(`<input name="warehouse" value="${this.selected_pos_profile.warehouse}" disabled>`),this.c1.append('<label for="income_account">POS income account</label>'),this.c1.append(`<input name="income_account" value="${this.selected_pos_profile.income_account}" disabled>`),this.c2.append('<label for="write_off_account">POS write off account</label>'),this.c2.append(`<input name="write_off_account" value="${this.selected_pos_profile.write_off_account}" disabled>`),this.c2.append('<label for="write_off_cost_center">POS write off cost center</label>'),this.c2.append(`<input name="write_off_cost_center" value="${this.selected_pos_profile.write_off_cost_center}" disabled>`),this.c2.append('<label for="taxes_and_charges">POS taxes and charges</label>'),this.c2.append(`<input name="taxes_and_charges" value="${this.selected_pos_profile.taxes_and_charges}" disabled>`)}refreshGeneralSettings(){let e=this.settings_data.settings.itemPriceBasedOn,t=this.settings_data.settings.showItemDetails?"checked":"",i=this.settings_data.settings.showItemImage?"checked":"",a=this.settings_data.settings.showDiscountField?"checked":"",r=this.settings_data.settings.search_by_group?"checked":"",n=this.settings_data.settings.keyboard_style;this.leftContainer.addClass("columnBox"),this.leftContainer.append('<h4 class="CartTitle" style="margin-bottom:35px; font-size:35px;" >General Settings</h4>'),this.leftContainer.append('<div id="settingsCartContentsContainer">  </div>'),this.contentsContainer=this.leftContainer.find("#settingsCartContentsContainer"),this.contentsContainer.append('<div id="generalSettingsContent" class="contentContainer rowBox" style="width:100%;"> <div class="c1 columnBox"></div>   <div class="c2 columnBox"></div> </div>'),this.general_settings_content=this.contentsContainer.find("#generalSettingsContent"),this.general_settings_c1=this.general_settings_content.find("div.c1"),this.general_settings_c2=this.general_settings_content.find("div.c2"),this.general_settings_c1.append('<label for="priceBasedOn" style="font-weight:600;"> Item Price Based On : </label>'),this.general_settings_c1.append('<select  name="priceBasedOn" id="priceBasedOnSelect" ></select>'),this.item_price_based_on_select=this.general_settings_c1.find("#priceBasedOnSelect"),this.settings_data.getAllPriceBases().forEach(o=>{this.settings_data.settings.itemPriceBasedOn==o?this.item_price_based_on_select.append(`<option value="${o}" selected> ${o} </option>`):this.item_price_based_on_select.append(`<option value="${o}"> ${o} </option>`)}),this.general_settings_c2.append('<label for="keyboardStyle" style="font-weight:600;"> Keyboard Style : </label>'),this.general_settings_c2.append('<select  name="keyboardStyle" id="keyboardStyle" ></select>'),this.keyboard_style_select=this.general_settings_c2.find("#keyboardStyle"),this.settings_data.getAllKeyboardStyles().forEach(o=>{this.settings_data.settings.keyboardStyle==o?this.keyboard_style_select.append(`<option value="${o}" selected> ${o} </option>`):this.keyboard_style_select.append(`<option value="${o}"> ${o} </option>`)}),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Item Details Cart : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;"><label for="showItemDetailsCartCheckBox" style="margin-right:16px;width:50%;" > show cart: </label> <input type="checkbox"  name="showItemDetailsCartCheckBox" id="showItemDetailsCartCheckBox" ${t} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Item Image : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;" ><label for="showItemImageCheckBox" style="margin-right:16px;width:50%;"> show item image: </label> <input type="checkbox"  name="showItemImageCheckBox" id="showItemImageCheckBox" ${i} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Discount feature : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;" ><label for="showDiscountFieldCheckBox" style="margin-right:16px;width:50%;"> show discount field: </label> <input type="checkbox"  name="showDiscountFieldCheckBox" id="showDiscountFieldCheckBox" ${a} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> filter item by group : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;" ><label for="showItemGroupFilterCheckBox" style="margin-right:16px;width:50%;"> show item group filter: </label> <input type="checkbox"  name="showItemGroupFilterCheckBox" id="showItemGroupFilterCheckBox" ${r} ></div>`),this.item_price_based_on_select.on("input",o=>{this.settings_data.setPriceItemBasedOn(o.target.value,()=>{this.on_settings_change("itemPriceBasedOn")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.keyboard_style_select.on("input",o=>{this.settings_data.settings.keyboardStyle=o.target.value,this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showItemImage")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showItemDetailsCartCheckBox").on("click",o=>{this.settings_data.settings.showItemDetails=$(o.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showItemDetails")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showItemImageCheckBox").on("click",o=>{this.settings_data.settings.showItemImage=$(o.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showItemImage")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showDiscountFieldCheckBox").on("click",o=>{this.settings_data.settings.showDiscountField=$(o.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showDiscountField")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showItemGroupFilterCheckBox").on("click",o=>{this.settings_data.settings.search_by_group=$(o.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("")},()=>{console.error("error to save the settings changes (settings.js)")})})}refreshAboutUs(){this.leftContainer.addClass("columnBox"),this.leftContainer.append('<h4 class="CartTitle" style="margin-bottom:35px; font-size:35px;" >About Us</h4>'),this.leftContainer.append('<div id="settingsCartContentsContainer">  </div>'),this.contentsContainer=this.leftContainer.find("#settingsCartContentsContainer")}showCart(){this.rightContainer.css("display","flex"),this.leftContainer.css("display","flex")}hideCart(){this.rightContainer.css("display","none"),this.leftContainer.css("display","none")}setListener(){let e=document.querySelectorAll(".settings_tab"),t=document.querySelectorAll(".contentContainer");e.forEach((i,a)=>{i.addEventListener("click",()=>{e.forEach(r=>{r.classList.remove("active")}),i.classList.add("active")})}),this.pos_profile_btn.on("click",i=>{this.scene="pos_profile",this.refreshLeftSection()}),this.general_settings_btn.on("click",i=>{this.scene="general_settings",this.refreshLeftSection()}),this.about_us_btn.on("click",i=>{this.scene="about_us",this.refreshLeftSection()})}};pos_ar.PointOfSale.pos_check_in_out=class{constructor(e,t){this.wrapper=e,this.db=t,this.checkList=[],this.filter="All",this.selectedCheckInOut=null,this.start_work()}start_work(){this.prepare_checkInOut_cart(),this.getAllCheckInOut(),this.setListeners()}prepare_checkInOut_cart(){this.wrapper.find("#LeftSection").append('<div id="checkInOutLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="checkInOutRightContainer" class="columnBox"></div>'),this.left_container=this.wrapper.find("#checkInOutLeftContainer"),this.right_container=this.wrapper.find("#checkInOutRightContainer"),this.right_container.append('<div id="checkInOutTabContainer" class="rowBox">  <div id="tabAll" class="tab selected">All</div> <div id="tabCheckIn" class="tab">Check In</div> <div id="tabCheckOut" class="tab">Check Out</div>  </div>'),this.tab_container=this.right_container.find("#checkInOutTabContainer"),this.tab_all=this.tab_container.find("#tabAll"),this.tab_in=this.tab_container.find("#tabCheckIn"),this.tab_out=this.tab_container.find("#tabCheckOut"),this.right_container.append('<div id="checkInOutList" class="columnBox"></div>'),this.check_in_out_list=this.right_container.find("#checkInOutList");let e='<div id="detailsCheckInOutHeader" class="rowBox" ><div class="checkInAmount columnBox" ><div class="rowBox centerItem" style="width:100%;height:50%;"><div style="font-size:25px; font-weight:700;">Check In</div></div><div id="TotalCheckInValue" class="rowBox centerItem" style="height:50%; width:100%;">...DA</div></div><div class="checkOutAmount columnBox" ><div class="rowBox centerItem" style="width:100%;height:50%;" ><div style="font-size:25px; font-weight:700;">Check Out</div></div><div id="TotalCheckOutValue" class="rowBox centerItem" style="width:100%;height:50%;"> ...DA </div></div><div class="totalCheckInOutAmount columnBox centerItem"><div class="rowBox centerItem" style="width:100%;height:50%;"><div style="font-size:25px; font-weight:700;">Total</div></div><div id="TotalCheckInOutValue" class="rowBox centerItem" style="height:50%; width:100%;">...DA</div></div></div>';this.left_container.append(e),this.details_checkInOut_header=this.left_container.find("#detailsCheckInOutHeader"),this.check_in_amount=this.details_checkInOut_header.find("#TotalCheckInValue"),this.check_out_amount=this.details_checkInOut_header.find("#TotalCheckOutValue"),this.check_total_in_out_amount=this.details_checkInOut_header.find("#TotalCheckInOutValue"),this.left_container.append('<div id="detailsCheckInOutContent" class="columnBox"></div>'),this.detailsCheckInOutContent=this.left_container.find("#detailsCheckInOutContent");let t='<div class="l1 rowBox"><div><span class="key">Check Type :<span> <span id="selectedCheckInOutType" class="value"> THE_TYPE </span></div><div><span class="value" id="selectedCheckInOutCreationTime"> THE_DATE </span></div></div><div class="l2 rowBox"><div><span class="key">Amount :</span> <span id="selectedCheckInOutAmount" class="value">THE AMOUNT</span></div><div><span id="selectedCheckInOutOwner" class="value">THE OWNER</span></div></div><div class="l3"><div class="title">Reason</div><textarea id="selectedCheckInOutReason" disabled ></textarea></div>';this.detailsCheckInOutContent.append(t),this.checkType=this.detailsCheckInOutContent.find("#selectedCheckInOutType"),this.checkAmount=this.detailsCheckInOutContent.find("#selectedCheckInOutAmount"),this.checkCreationTime=this.detailsCheckInOutContent.find("#selectedCheckInOutCreationTime"),this.checkOwner=this.detailsCheckInOutContent.find("#selectedCheckInOutOwner"),this.checkReason=this.detailsCheckInOutContent.find("#selectedCheckInOutReason")}refreshCheckInOutList(){this.check_in_out_list.empty(),this.checkList.filter(t=>t.check_type==this.filter||this.filter=="All").forEach(t=>{let i=document.createElement("div");i.classList.add("checkInOutItem","rowBox");let a=document.createElement("div");a.classList.add("type");let r=document.createElement("img");r.src="/assets/pos_ar/images/arrow.png",r.style.width="35px",r.style.height="35px",r.transform=t.check_type==="In"?"rotate(180deg);":"";let n=document.createElement("div");n.textContent=t.check_type;let o=document.createElement("div");o.classList.add("creationTime"),o.textContent=t.creation_time;let c=document.createElement("div");c.classList.add("amount"),c.textContent=t.amount+" DA",a.append(r),a.append(n),i.append(a),i.append(o),i.append(c),i.addEventListener("click",()=>{this.selectedCheckInOut=t,this.refreshCheckInOutDetails()}),this.check_in_out_list.append(i)})}refreshCheckInOutAmount(){this.check_total_in_out_amount.html(""),this.check_in_amount.html(""),this.check_out_amount.html("");let e=0,t=0,i=0;this.checkList.forEach(a=>{i+=parseFloat(a.amount)||0,a.check_type=="In"?e+=parseFloat(a.amount)||0:a.check_type=="Out"&&(t+=parseFloat(a.amount)||0)}),this.check_in_amount.append(`${e.toFixed(2)} DA`),this.check_out_amount.append(`${t.toFixed(2)} DA`),this.check_total_in_out_amount.append(`${i.toFixed(2)} DA`)}refreshCheckInOutDetails(){this.selectedCheckInOut!=null&&(this.checkType.html(""),this.checkCreationTime.html(""),this.checkReason.html(""),this.checkOwner.html(""),this.checkAmount.html(""),this.checkType.append(this.selectedCheckInOut.check_type),this.checkCreationTime.append(this.selectedCheckInOut.creation_time),this.checkAmount.append(this.selectedCheckInOut.amount+" DA"),this.checkReason.append(this.selectedCheckInOut.reason),this.checkOwner.append(this.selectedCheckInOut.owner),console.log("this.checkReason.scrollHeight : ",this.checkReason.get(0).scrollHeight),this.checkReason.get(0).style.height="auto",this.checkReason.get(0).style.height=this.checkReason.get(0).scrollHeight+"px")}showCart(){this.left_container.css("display","flex"),this.right_container.css("display","flex")}hideCart(){this.left_container.css("display","none"),this.right_container.css("display","none")}setListeners(){this.tab_all.on("click",e=>{this.filter="All",this.tab_all.addClass("selected"),this.tab_out.removeClass("selected"),this.tab_in.removeClass("selected"),this.refreshCheckInOutList()}),this.tab_in.on("click",e=>{this.filter="In",this.tab_in.addClass("selected"),this.tab_out.removeClass("selected"),this.tab_all.removeClass("selected"),this.refreshCheckInOutList()}),this.tab_out.on("click",e=>{this.filter="Out",this.tab_out.addClass("selected"),this.tab_all.removeClass("selected"),this.tab_in.removeClass("selected"),this.refreshCheckInOutList()})}async getAllCheckInOut(){this.db.getAllCheckInOut_callback(e=>{e.length>0&&(this.selectedCheckInOut=e[0]),this.checkList=e,this.refreshCheckInOutList(),this.refreshCheckInOutAmount(),this.refreshCheckInOutDetails(),console.log("res : ",e)},e=>{console.log("err : ",e)})}};pos_ar.PointOfSale.posSettingsData=class{constructor(e){this.db=e,this.price_bases=["brand","priceList"],this.keyboard_styles=["primery","secondary"],this.db.getSettings(t=>{t&&t.itemPriceBasedOn?this.settings=t:this.settings={itemPriceBasedOn:"brand",keyboardStyle:"secondary",showItemDetails:!1,showItemImage:!1,showDiscountField:!1,search_by_group:!1}},t=>{console.log("error when trying to get the setting from local, so we use the default."),this.settings={itemPriceBasedOn:"brand",keyboardStyle:"secondary",showItemDetails:!1,showItemImage:!1,showDiscountField:!1,search_by_group:!1}})}getAllPriceBases(){return this.price_bases}getAllKeyboardStyles(){return this.keyboard_styles}getPriceBase(){return this.settings.itemPriceBasedOn}setPriceItemBasedOn(e,t,i){this.price_bases.includes(e)?(this.settings.itemPriceBasedOn=e,this.db.updateSettings_callback(this.settings,()=>{t(),console.log("settings update is save successfuly")},()=>{console.error("error occured when trying to save settings")})):console.error("invalide base : ",e,"there are just : ",this.price_bases)}getShowItemDetails(){return this.settings.showItemDetails}setShowItemDetails(e,t,i){this.settings.showItemDetails=e,this.db.updateSettings_callback(this.settings,()=>{t(),console.log("settings update is save successfuly")},()=>{console.error("error occured when trying to save settings")})}setSettings(e,t,i){this.settings=e,this.db.updateSettings_callback(this.settings,()=>{t(),console.log("settings update is save successfuly")},()=>{console.error("error occured when trying to save settings")})}};pos_ar.PointOfSale.posAppData=class{constructor(e,t){this.db=e,this.api_handler=t,this.since=localStorage.getItem("lastTime"),this.appData={}}async getAllData(){try{frappe.show_progress("Please Wait",0,12,"loading deleted documents"),await this.getDeletedDocs(),frappe.show_progress("Please Wait",1,12,"loading customers..."),await this.getCustomers(),frappe.show_progress("Please Wait",2,12,"loading items..."),await this.getItems(),frappe.show_progress("Please Wait",3,12,"loading pos profiles"),await this.getPosProfiles(),frappe.show_progress("Please Wait",4,12,"loading mode of payment"),await this.getPosProfileModeOfPayments(this.appData.pos_profile),await this.getBins(),frappe.show_progress("Please Wait",5,12,"loading warehouses"),await this.getWarehouses(),frappe.show_progress("Please Wait",6,12,"loading price lists"),await this.getPriceLists(),frappe.show_progress("Please Wait",7,12,"loading item prices"),await this.getItemPrices(),frappe.show_progress("Please Wait",8,12,"loading item groups"),await this.getItemGroups(),frappe.show_progress("Please Wait",9,12,"loading invoices"),await this.getPosInvoices(),frappe.show_progress("Please Wait",10,12,"loading check in out"),await this.getCheckInOuts(),frappe.show_progress("Please Wait",11,12,"loading barcodes"),await this.getItemBarcodes(),frappe.show_progress("Please Wait",12,12,"Completed"),frappe.hide_progress(),frappe.hide_progress(),frappe.hide_progress(),frappe.hide_progress(),this.since=frappe.datetime.now_datetime(),localStorage.setItem("lastTime",frappe.datetime.now_datetime()),console.log("app data : ",this.appData)}catch(e){console.error("appData Class Error  : ",e),frappe.hide_progress()}frappe.hide_progress()}async getCustomers(){let e=[],t=await this.api_handler.fetchCustomers(this.since);await this.db.saveCustomerList(t),this.appData.customers=this.combineLocalAndUpdated(e,t)}async getBrands(){this.appData.brands=await this.api_handler.fetchBrands(this.since)}async getItems(){let e=[],t=await this.api_handler.fetchItems(this.since);await this.db.saveItemList(t),this.appData.items=this.combineLocalAndUpdated(e,t)}async getPosProfiles(){this.appData.pos_profile=await this.api_handler.fetchPosProfile(this.since)}async getPosProfileModeOfPayments(e){let t=[];e.payments.forEach(i=>{t.push(i.mode_of_payment)}),this.appData.posProfileModeOfPayments=await this.api_handler.fetchPosProfileModeOfPayments(t,e.company)}async getBins(){let e=[],t=await this.api_handler.fetchBinList(this.since);await this.db.saveBinList(t),this.appData.bins=this.combineLocalAndUpdated(e,t)}async getWarehouses(){let e=[],t=await this.api_handler.fetchWarehouseList(this.since);await this.db.saveWarehouseList(t),this.appData.warehouses=this.combineLocalAndUpdated(e,t)}async getPriceLists(){let e=[],t=await this.api_handler.fetchPriceList(this.since);await this.db.savePriceLists(t),this.appData.price_lists=this.combineLocalAndUpdated(e,t)}async getItemPrices(){let e=[],t=await this.api_handler.fetchItemPrice(this.since);await this.db.saveItemPriceList(t),this.appData.item_prices=this.combineLocalAndUpdated(e,t),console.log()}async getItemGroups(){let e=[],t=await this.api_handler.fetchItemGroups(this.since);await this.db.saveItemGroupList(t),this.appData.item_groups=this.combineLocalAndUpdated(e,t)}async getItemBarcodes(){this.appData.item_barcodes=await this.api_handler.fetchItemBarCodes()}async getPosInvoices(){this.appData.pos_invoices=await this.db.getAllPosInvoice()}async getCheckInOuts(){this.appData.check_in_outs=await this.db.getAllCheckInOut()}async getDeletedDocs(){this.appData.deleted_documents=await this.api_handler.fetchDeletedDocs(this.since)}saveCheckInOut(e,t,i){this.db.saveCheckInOut(e,t,i)}savePosInvoice(e){this.db.savePosInvoice(e)}updatePosInvoice(e){this.db.updatePosInvoice(e)}getNotSyncedPos(e,t){this.db.getNotSyncedPos(i=>{e(i)},i=>{t(i)})}getNotSyncedPosNumber(e,t){this.db.getNotSyncedPosNumber(i=>{e(i)},i=>{t(i)})}combineLocalAndUpdated(e,t){let i=new Map(e.map(a=>[a.name,a]));return this.appData.deleted_documents.forEach(a=>{i.delete(a.name)}),t.forEach(a=>{i.set(a.name,a)}),Array.from(i.values())}};pos_ar.PointOfSale.FetchHandler=class{constructor(){}async fetchCustomers(t){try{let i={disabled:0};return await frappe.db.get_list("Customer",{fields:["name","customer_name"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching customers:",i),[]}}async fetchBrands(t){try{let i={};return await frappe.db.get_list("Brand",{fields:["brand"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching customers:",i),[]}}async fetchItemGroups(t){try{let i={};return await frappe.db.get_list("Item Group",{fields:["name","item_group_name","parent_item_group","is_group"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching Item Group :",i),[]}}async fetchItems(t){try{let i={disabled:0};return await frappe.db.get_list("Item",{fields:["name","item_name","image","brand","item_group","description","stock_uom","barcodes"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching Item Group :",i),[]}}async fetchItemBarCodes(){try{return(await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_item_barcodes",args:{}})).message}catch(t){return console.error("Error fetching Item Barcodes:",t),[]}}async fetchItemPrice(t){try{let i={};return await frappe.db.get_list("Item Price",{fields:["name","item_code","item_name","price_list","price_list_rate","brand"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching Item Group :",i),[]}}async fetchPriceList(t){try{let i={selling:1};return await frappe.db.get_list("Price List",{fields:["name","price_list_name","currency"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching Item Group :",i),[]}}async fetchWarehouseList(t){try{let i={};return await frappe.db.get_list("Warehouse",{fields:["name","warehouse_name"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching Warehouse list : ",i),[]}}async fetchPosProfile(){try{let t={disabled:0},i=await frappe.db.get_list("POS Profile",{fields:["name"],filters:t,limit:1});return await frappe.db.get_doc("POS Profile",i[0].name)}catch(t){return console.error("Error fetching pos profile list : ",t),null}}async fetchPosProfileModeOfPayments(t,i){try{let a=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_mode_of_payments",args:{}});return console.log("see :::====> ",a.message),a.message}catch(a){return console.error("Error fetching mode_of_payments",a),[]}}async fetchCompany(t){try{return await frappe.db.get_doc("Company",t)}catch(i){return console.error("Error fetching company by companyId from the profile list : ",i),[]}}async fetchSalesTaxesAndChargesTemplate(t){try{return await frappe.db.get_doc("Sales Taxes and Charges Template",t)}catch(i){return console.error("Error fetching Warehouse list : ",i),[]}}async fetchBinList(t){try{let i={};return await frappe.db.get_list("Bin",{fields:["name","actual_qty","item_code","warehouse"],filters:i,limit:1})}catch(i){return console.error("Error fetching Bin list : ",i),[]}}async fetchDeletedDocs(t){try{let i={};return t&&(i.modified=[">",t]),await frappe.db.get_list("Deleted Document",{fields:["name","deleted_name","deleted_doctype","restored"],filters:i,limit:1e5})}catch(i){return console.error("Error fetching deleted documents :",i),[]}return[]}};pos_ar.PointOfSale.pos_debt_cart=class{constructor(e){this.wrapper=e,this.start_work()}start_work(){console.log("hello from pos_debt_cart"),this.prepare_cart()}prepare_cart(){this.wrapper.find("#LeftSection").append('<div id="debtLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="debtRightContainer" class="columnBox"></div>'),this.leftContainer=this.wrapper.find("#debtLeftContainer"),this.rightContainer=this.wrapper.find("#debtRightContainer")}showCart(){console.log("showing ..."),this.leftContainer.css("display","flex"),this.rightContainer.css("display","flex")}hideCart(){console.log("hiding ..."),this.leftContainer.css("display","none"),this.rightContainer.css("display","none")}};})();
//# sourceMappingURL=pos.bundle.RPRFWHZR.js.map
