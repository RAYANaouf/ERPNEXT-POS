(()=>{var C=Object.defineProperty;var I=Object.getOwnPropertySymbols;var x=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var w=(t,e,s)=>e in t?C(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,y=(t,e)=>{for(var s in e||(e={}))x.call(e,s)&&w(t,s,e[s]);if(I)for(var s of I(e))k.call(e,s)&&w(t,s,e[s]);return t};frappe.provide("pos_ar.myaccessories");pos_ar.myaccessories.AccessoriesController=class{constructor(t){this.wrapper=$(t).find(".layout-main-section"),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/accessories_page/main.css">'),this.selectedDate=frappe.datetime.get_today(),this.make()}make(){this.createLayout()}createLayout(){let t=$('<div class="accessories-container">').appendTo(this.wrapper),e=$('<div class="top-bar">').appendTo(t),s=$('<div class="top-bar-left">').appendTo(e);$("<h2>").text("Accessories").appendTo(s);let i=$('<div class="top-bar-center">').appendTo(e),n=$('<div class="date-filter">').appendTo(i);this.datePicker=$('<input type="date">').val(this.selectedDate).change(()=>{this.selectedDate=this.datePicker.val(),this.loadItems(t.find(".items-container"))}).appendTo(n);let a=$('<div class="top-bar-right">').appendTo(e);$('<button class="btn-export">').html('<i class="fa fa-download"></i> Export').click(()=>this.exportData()).appendTo(a);let o=$('<div class="items-container">').appendTo(t),r=$('<div class="item-row header">').html(`
            <div class="item-col name">Name</div>
            <div class="item-col qty">Quantity</div>
            <div class="item-col total">Total</div>
        `).appendTo(o);this.loadItems(o)}formatCurrency(t){return t.toFixed(2)+" DA"}loadItems(t){frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_saled_item",args:{},callback:e=>{e.message&&this.renderItems(t,e.message.items)}})}renderItems(t,e){if(t.find(".item-row:not(.header)").remove(),console.log(e),Object.keys(e).length===0){$('<div class="item-row no-data">').html('<div class="item-col name">No sales data found for selected date</div>').appendTo(t);return}Object.entries(e).forEach(([s,i])=>{$('<div class="item-row">').html(`
                    <div class="item-col name">${frappe.utils.escape_html(s)}</div>
                    <div class="item-col qty">${i.qty}</div>
                    <div class="item-col total">${this.formatCurrency(i.rate)}</div>
                `).appendTo(t)}),$('<div class="item-row grand-total">').html(`
                <div class="item-col name">Grand Total</div>
                <div class="item-col qty"></div>
                <div class="item-col total">${this.formatCurrency(item.rate)}</div>
            `).appendTo(t)}exportData(){frappe.call({method:"frappe.client.get_list",args:{doctype:"POS Invoice Item",fields:["item_name","qty","rate","amount"],filters:[["POS Invoice","posting_date","=",this.selectedDate],["POS Invoice","docstatus","=",1]],order_by:"posting_date desc"},callback:t=>{t.message&&this.downloadCSV(t.message)}})}downloadCSV(t){let s=["Item Name","Price (DA)","Quantity","Total (DA)"].join(",")+`
`;t.forEach(r=>{s+=[`"${r.item_name}"`,r.rate.toFixed(2),r.qty,r.amount.toFixed(2)].join(",")+`
`}),s+=`
Grand Total,,,"${t.reduce((r,c)=>r+c.amount,0).toFixed(2)}"`;let n=new Blob([s],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a"),o=URL.createObjectURL(n);a.setAttribute("href",o),a.setAttribute("download",`accessories_sales_${this.selectedDate}.csv`),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}};frappe.provide("pos_ar.Pricing");pos_ar.Pricing.PricingController=class{constructor(t){this.wrapper=$(t).find(".layout-main-section"),this.current_screen="pricing",this.fetcher=new pos_ar.Pricing.PricingFetcher,this.setup_page(),this.add_style(),this.setup_events(),this.load_companies(),this.priceLists=[],this.brands=[],this.priceMap={}}setup_page(){this.page_content=$(`
            <div class="pricing-container">
                <!-- Loading Popover -->
                <div id="loadingPopover" popover="manual">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading Prices</div>
                    </div>
                </div>

                <!-- Top App Bar -->
                <div class="pricing-top-bar">
                    <div class="top-bar-left">
                        <h2>Pricing Management</h2>
                    </div>
                    <div class="top-bar-filters">
                        <div class="filter-item">
                            <select class="form-control company-filter" placeholder="Company">
                            </select>
                        </div>
                    </div>
                    <div class="top-bar-right">
                        <button class="btn btn-primary">New Price</button>
                        <button class="btn btn-default">Import</button>
                        <button class="btn btn-default">Export</button>
                    </div>
                </div>

                <!-- Main Content Area with Sidebar -->
                <div class="pricing-main-content">
                    <!-- Sidebar Navigation -->
                    <div class="pricing-sidebar">
                        <div class="sidebar-nav">
                            <div class="nav-item active" data-screen="pricing">
                                <i class="fa fa-tag"></i>
                                <span>Pricing</span>
                            </div>
                            <div class="nav-item" data-screen="fixing">
                                <i class="fa fa-wrench"></i>
                                <span>Fixing</span>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="pricing-content">
                        <div class="screen pricing-screen active">
                            <!-- Pricing screen content will be loaded here -->
                        </div>
                        <div class="screen fixing-screen">
                            <!-- Fixing screen content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        `).appendTo(this.wrapper),this.loadingPopover=document.getElementById("loadingPopover")}setup_events(){this.wrapper.find(".nav-item").on("click",t=>{let e=$(t.currentTarget).data("screen");this.switch_screen(e)}),this.wrapper.find(".company-filter").on("change",t=>{let e=$(t.currentTarget).val();this.filter_by_company(e)}),this.wrapper.find(".btn-primary").on("click",()=>{this.create_new_item_price()}),this.wrapper.find('.btn-default:contains("Export")').on("click",()=>{this.export_pricing_data()})}switch_screen(t){this.wrapper.find(".nav-item").removeClass("active"),this.wrapper.find(`.nav-item[data-screen="${t}"]`).addClass("active"),this.wrapper.find(".screen").removeClass("active"),this.wrapper.find(`.${t}-screen`).addClass("active"),this.current_screen=t}load_companies(){frappe.call({method:"frappe.client.get_list",args:{doctype:"Company",fields:["name","company_name"],order_by:"company_name asc"},callback:t=>{if(t.message){let e=t.message,s=this.wrapper.find(".company-filter");s.empty(),e.forEach(i=>{s.append(`<option value="${i.name}">${i.company_name}</option>`)}),frappe.defaults.get_default("company")?(s.val(frappe.defaults.get_default("company")),this.filter_by_company(frappe.defaults.get_default("company"))):this.filter_by_company(e[0].name),s.select2({placeholder:"Company",allowClear:!0})}}})}filter_by_company(t){this.current_screen==="pricing"?this.load_pricing_data(t):this.current_screen==="fixing"&&this.load_fixing_data(t)}async load_pricing_data(t){if(!!t)try{this.loadingPopover||(this.loadingPopover=document.getElementById("loadingPopover")),this.loadingPopover.matches(":popover-open")&&this.loadingPopover.hidePopover(),requestAnimationFrame(()=>{this.loadingPopover.showPopover()});let e=await this.fetcher.fetchItemPrices(t),s=e.prices;this.priceLists=e.price_lists,this.brands=e.brands,this.loadingPopover.hidePopover(),this.render_pricing_data(s,this.priceLists,this.brands)}catch(e){this.loadingPopover&&this.loadingPopover.hidePopover(),frappe.msgprint({title:__("Error"),indicator:"red",message:__("Failed to load item prices")}),console.error("Error loading item prices:",e)}}render_pricing_data(t,e,s){let i=this.wrapper.find(".pricing-screen");if(i.empty(),!t||t.length===0){i.html(`
                <div class="no-data-state">
                    <div class="no-data-icon">
                        <i class="fa fa-tag"></i>
                    </div>
                    <div class="no-data-message">
                        No item prices found for this company
                    </div>
                </div>
            `);return}this.priceMap={},t.forEach(o=>{let r=`${o.brand||"No Brand"}_${o.price_list}`;this.priceMap[r]={name:o.name,price:o.price_list_rate,item_code:o.item_code}});let n=$(`
            <div class="pricing-data">
                <div class="pricing-controls">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="search-wrapper">
                                <div class="search-field">
                                    <i class="fa fa-search search-icon"></i>
                                    <input type="text" class="form-control global-search" placeholder="Search across all columns...">
                                    <button class="btn btn-link btn-clear-search" style="display: none;">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-right">
                            <button class="btn btn-default toggle-filters">
                                <i class="fa fa-filter"></i> Filters
                            </button>
                            <button class="btn btn-default clear-filters">
                                <i class="fa fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="pricing-table">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr class="headers">
                                <th class="sortable" data-sort="brand">
                                    Brand <i class="fa fa-sort"></i>
                                </th>
                                ${e.map(o=>`
                                    <th class="sortable" data-sort="price" data-price-list="${o.name}">
                                        ${o.name} <i class="fa fa-sort"></i>
                                    </th>
                                `).join("")}
                            </tr>
                            <tr class="filters" style="display: none;">
                                <td>
                                    <input type="text" class="form-control brand-filter" placeholder="Filter Brand...">
                                </td>
                                ${e.map(()=>`
                                    <td>
                                        <input type="text" class="form-control price-filter" placeholder="Filter Price...">
                                    </td>
                                `).join("")}
                            </tr>
                        </thead>
                        <tbody>
                            ${s.map(o=>`
                                <tr>
                                    <td>${o.brand||o.name}</td>
                                    ${e.map(r=>{let c=this.priceMap[`${o.name}_${r.name}`]||{};return`
                                            <td>
                                                ${c.price?`<div class="price-cell">
                                                        <div class="price-value">
                                                            ${frappe.format(c.price,{fieldtype:"Currency"})}
                                                            <button class="btn btn-xs btn-default edit-price" 
                                                                    data-item="${c.name}"
                                                                    title="Edit Price">
                                                                <i class="fa fa-pencil"></i>
                                                            </button>
                                                        </div>
                                                    </div>`:'<div class="no-price">-</div>'}
                                            </td>
                                        `}).join("")}
                                </tr>
                            `).join("")}
                        </tbody>
                    </table>
                </div>
            </div>
        `);this.setupTableEvents(n);let a=$(`
            <style>
                .pricing-table {
                    overflow-x: auto;
                }
                .pricing-table table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 0;
                }
                .pricing-table th, .pricing-table td {
                    text-align: center;
                    padding: 12px;
                    vertical-align: middle;
                }
                .pricing-table th:first-child, 
                .pricing-table td:first-child {
                    text-align: left;
                    font-weight: bold;
                    position: sticky;
                    left: 0;
                    background: var(--bg-color);
                    z-index: 1;
                }
                .pricing-table .headers th {
                    background-color: var(--bg-gray);
                    position: sticky;
                    top: 0;
                    z-index: 2;
                }
                .pricing-table .headers th:first-child {
                    z-index: 3;
                }
                .pricing-table .sortable {
                    cursor: pointer;
                }
                .pricing-table .sortable:hover {
                    background-color: var(--bg-light-gray);
                }
                .pricing-table .filters input {
                    width: 100%;
                    padding: 4px 8px;
                    border-radius: 4px;
                }
                .price-cell {
                    display: flex;
                    flex-direction: column;
                    gap: var(--margin-xs);
                    align-items: center;
                }
                .price-value {
                    display: flex;
                    align-items: center;
                    gap: var(--margin-xs);
                    font-weight: 500;
                    color: var(--text-color);
                }
                .no-price {
                    color: var(--text-muted);
                    font-style: italic;
                }
                .edit-price {
                    visibility: hidden;
                    padding: var(--padding-xs) !important;
                    min-width: 28px;
                    min-height: 28px;
                    border: 1px solid var(--border-color);
                    background: var(--control-bg);
                    color: var(--text-color);
                    border-radius: var(--border-radius-sm);
                    transition: all 0.2s;
                }
                .price-cell:hover .edit-price {
                    visibility: visible;
                }
                .pricing-controls {
                    padding: var(--padding-md);
                    margin-bottom: var(--margin-lg);
                }
                .search-wrapper {
                    max-width: 500px;
                }
                .search-field {
                    position: relative;
                    display: flex;
                    align-items: center;
                    background: var(--control-bg);
                    border: 1px solid var(--border-color);
                    border-radius: var(--border-radius-lg);
                    transition: all 0.2s;
                }
                .search-field:focus-within {
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 3px var(--primary-color-light);
                }
                .search-icon {
                    color: var(--text-muted);
                    padding: 0 var(--padding-sm);
                    font-size: 14px;
                }
                .search-field .form-control {
                    border: none;
                    box-shadow: none;
                    padding: var(--padding-sm) var(--padding-xs);
                    background: transparent;
                    height: 40px;
                    font-size: var(--text-base);
                }
                .search-field .form-control:focus {
                    outline: none;
                }
                .btn-clear-search {
                    color: var(--text-muted);
                    padding: var(--padding-xs) var(--padding-sm);
                    margin-right: 2px;
                }
                .btn-clear-search:hover {
                    color: var(--text-color);
                }
                .toggle-filters, .clear-filters {
                    padding: var(--padding-sm) var(--padding-md);
                    font-weight: 500;
                    border-radius: var(--border-radius-lg);
                    margin-left: var(--margin-sm);
                    transition: all 0.2s ease;
                }
                .toggle-filters:hover, .clear-filters:hover {
                    background-color: var(--fg-hover-color);
                    border-color: var(--gray-600);
                }
            </style>
        `);i.append(a).append(n)}setupTableEvents(t){let e=this;t.find(".toggle-filters").on("click",function(){t.find(".filters").toggle()}),t.find(".clear-filters").on("click",function(){t.find(".filters input, .global-search").val(""),t.find("tbody tr").show()}),t.find(".global-search").on("input",function(){let i=$(this).val().toLowerCase();t.find("tbody tr").each(function(){let n=$(this),a=n.text().toLowerCase();n.toggle(a.includes(i))})}),t.find(".brand-filter, .price-filter").on("input",function(){let n=t.find(".filters input").map(function(){return{column:$(this).closest("td").index(),value:$(this).val().toLowerCase()}}).get();t.find("tbody tr").each(function(){let a=$(this),o=n.every(r=>{let c=a.find(`td:eq(${r.column})`).text().toLowerCase();return!r.value||c.includes(r.value)});a.toggle(o)})}),$(document).off("click",".edit-price").on("click",".edit-price",function(i){let n=$(this).data("item");n&&e.show_price_editor(n)});let s={column:null,direction:"asc"};t.find(".sortable").on("click",function(){let i=$(this).data("sort"),n=$(this).data("price-list"),a=$(this).index();s.column===a?s.direction=s.direction==="asc"?"desc":"asc":s={column:a,direction:"asc"},t.find(".sortable i").attr("class","fa fa-sort"),$(this).find("i").attr("class",`fa fa-sort-${s.direction}`);let o=t.find("tbody tr").get();o.sort((r,c)=>{let l=$(r).find(`td:eq(${a})`).text(),d=$(c).find(`td:eq(${a})`).text();return i==="price"&&(l=parseFloat(l.replace(/[^0-9.-]+/g,""))||0,d=parseFloat(d.replace(/[^0-9.-]+/g,""))||0),s.direction==="asc"?l>d?1:-1:l<d?1:-1}),t.find("tbody").html(o)})}create_new_item_price(){let t=this.wrapper.find(".company-filter").val();if(!t){frappe.throw(__("Please select a company first"));return}frappe.prompt([{label:"Brand",fieldname:"brand",fieldtype:"Link",options:"Brand",reqd:1},{label:"Price List",fieldname:"price_list",fieldtype:"Link",options:"Price List",reqd:1},{label:"Price List Rate",fieldname:"price_list_rate",fieldtype:"Currency",reqd:1}],e=>{frappe.db.get_list("Item",{filters:{brand:e.brand}}).then(s=>{if(s.length>0){let i=s[0].name;frappe.call({method:"frappe.client.insert",args:{doc:{doctype:"Item Price",item_code:i,price_list:e.price_list,price_list_rate:e.price_list_rate,company:t}},callback:n=>{n.message&&(frappe.show_alert({message:__("Item Price created successfully"),indicator:"green"}),this.load_pricing_data(t))}})}else frappe.msgprint({title:__("Error"),indicator:"red",message:__("No item with the specified brand exists. Please create an item with the specified brand first.")})})},"Create New Item Price","Create")}show_price_editor(t){frappe.db.get_doc("Item Price",t).then(e=>{frappe.prompt([{label:"Current Price",fieldname:"current_price",fieldtype:"Currency",read_only:1,default:e.price_list_rate},{label:"New Price",fieldname:"price",fieldtype:"Currency",reqd:1}],s=>{frappe.call({method:"frappe.client.set_value",args:{doctype:"Item Price",name:t,fieldname:"price_list_rate",value:s.price},callback:i=>{if(i.exc){frappe.msgprint({title:__("Error"),indicator:"red",message:__("Failed to update price")});return}frappe.show_alert({message:__("Price updated successfully"),indicator:"green"});let n=this.wrapper.find(".company-filter").val();this.load_pricing_data(n)}})},__("Update Price"),__("Update"))}).catch(e=>{frappe.msgprint({title:__("Error"),indicator:"red",message:__("Failed to fetch item price details")}),console.error("Error fetching item price:",e)})}load_fixing_data(t){console.log("Loading fixing data for company:",t)}export_pricing_data(){let t=this.wrapper.find(".company-filter").val();if(!t){frappe.msgprint({title:__("Error"),indicator:"red",message:__("Please select a company first")});return}let e="data:text/csv;charset=utf-8,";e+="Brand,"+this.priceLists.map(n=>n.name).join(",")+`
`,console.log("the price lists : ",e),this.brands.forEach(n=>{let a=n.brand;this.priceLists.forEach(o=>{let r=this.priceMap[`${n.name}_${o.name}`]||{};a+=","+(r.price||"empty")}),e+=a+`
`});let s=encodeURI(e),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",`pricing_matrix_${t}.csv`),document.body.appendChild(i),i.click()}add_style(){this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/pricing_page/main.css">');let t=`
            <style>
                :root {
                    --primary-color: #4f46e5;
                    --primary-hover: #4338ca;
                    --bg-color: #f8fafc;
                    --surface-color: #ffffff;
                    --text-primary: #1e293b;
                    --text-secondary: #64748b;
                    --border-color: #e2e8f0;
                }

                .pricing-container {
                    display: flex;
                    flex-direction: column;
                    height: 100vh;
                    overflow: hidden;
                    background: var(--bg-color);
                    padding: 1.5rem;
                    gap: 1.5rem;
                }

                .pricing-top-bar {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1rem 1.5rem;
                    background: var(--surface-color);
                    border-radius: 1rem;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
                    gap: 2rem;
                }

                .top-bar-left h2 {
                    font-size: 1.5rem;
                    font-weight: 600;
                    color: var(--text-primary);
                    margin: 0;
                    letter-spacing: -0.025em;
                }

                .top-bar-filters {
                    display: flex;
                    gap: 1rem;
                    flex: 1;
                    position: relative;
                }

                .filter-item {
                    min-width: 240px;
                    position: relative;
                }

                .filter-item::before {
                    content: '';
                    position: absolute;
                    inset: 0;
                    border-radius: 14px;
                    padding: 2px;
                    background: linear-gradient(135deg, var(--primary-color), #818cf8);
                    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                    -webkit-mask-composite: xor;
                    mask-composite: exclude;
                    opacity: 0;
                    transition: opacity 0.3s;
                }

                .filter-item:hover::before {
                    opacity: 0.5;
                }

                .filter-item .select2-container {
                    width: 100% !important;
                }

                .filter-item .select2-container .select2-selection--single {
                    height: 48px;
                    background: var(--surface-color);
                    border: 1px solid var(--border-color);
                    border-radius: 14px;
                    display: flex;
                    align-items: center;
                    transition: all 0.2s;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
                }

                .filter-item .select2-container .select2-selection--single:hover {
                    border-color: var(--text-secondary);
                    transform: translateY(-1px);
                }

                .filter-item .select2-container.select2-container--focus .select2-selection--single {
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 4px var(--primary-color-light);
                }

                .filter-item .select2-container .select2-selection--single .select2-selection__rendered {
                    line-height: 48px;
                    padding: 0 1.25rem;
                    color: var(--text-primary);
                    font-weight: 500;
                    font-size: 0.9375rem;
                }

                .filter-item .select2-container .select2-selection--single .select2-selection__placeholder {
                    color: var(--text-secondary);
                    font-weight: 400;
                }

                .filter-item .select2-container .select2-selection--single .select2-selection__arrow {
                    height: 48px;
                    width: 48px;
                    position: absolute;
                    right: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .filter-item .select2-container .select2-selection--single .select2-selection__arrow b {
                    display: none;
                }

                .filter-item .select2-container .select2-selection--single .select2-selection__arrow::after {
                    content: '';
                    width: 10px;
                    height: 10px;
                    border: 2px solid var(--text-secondary);
                    border-left: 0;
                    border-top: 0;
                    transform: rotate(45deg) translateY(-2px);
                    transition: all 0.2s;
                }

                .filter-item .select2-container.select2-container--open .select2-selection--single .select2-selection__arrow::after {
                    transform: rotate(-135deg) translateY(-2px);
                    border-color: var(--primary-color);
                }

                .top-bar-right {
                    display: flex;
                    gap: 0.75rem;
                }

                .btn {
                    height: 42px;
                    padding: 0 1.5rem;
                    border-radius: 0.75rem;
                    font-weight: 500;
                    transition: all 0.2s;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.5rem;
                }

                .btn-primary {
                    background: var(--primary-color);
                    color: white;
                    border: none;
                }

                .btn-primary:hover {
                    background: var(--primary-hover);
                    transform: translateY(-1px);
                }

                .btn-default {
                    background: var(--surface-color);
                    border: 1px solid var(--border-color);
                    color: var(--text-primary);
                }

                .btn-default:hover {
                    border-color: var(--text-secondary);
                    transform: translateY(-1px);
                }

                .pricing-main-content {
                    display: flex;
                    flex: 1;
                    gap: 1.5rem;
                    height: calc(100vh - 120px);
                    overflow: hidden;
                }

                .pricing-sidebar {
                    width: 280px;
                    background: var(--surface-color);
                    border-radius: 1rem;
                    padding: 1.25rem 1rem;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
                }

                .sidebar-nav {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .nav-item {
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    padding: 0.875rem 1rem;
                    border-radius: 0.75rem;
                    cursor: pointer;
                    transition: all 0.15s;
                    color: var(--text-secondary);
                }

                .nav-item:hover {
                    color: var(--text-primary);
                    background: var(--bg-color);
                }

                .nav-item.active {
                    color: var(--primary-color);
                    background: rgba(79, 70, 229, 0.1);
                    font-weight: 500;
                }

                .nav-item i {
                    font-size: 1.25rem;
                    width: 24px;
                }

                .pricing-content {
                    flex: 1;
                    background: var(--surface-color);
                    border-radius: 1rem;
                    padding: 1.5rem;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
                    overflow-y: auto;
                }

                .screen {
                    display: none;
                }

                .screen.active {
                    display: block;
                }

                /* Custom scrollbar */
                .pricing-content::-webkit-scrollbar {
                    width: 6px;
                }

                .pricing-content::-webkit-scrollbar-track {
                    background: transparent;
                }

                .pricing-content::-webkit-scrollbar-thumb {
                    background: var(--border-color);
                    border-radius: 3px;
                }

                .pricing-content::-webkit-scrollbar-thumb:hover {
                    background: var(--text-secondary);
                }

                /* Loading Popover Styles */
                #loadingPopover {
                    position: fixed;
                    inset: 0;
                    margin: auto;
                    width: max-content;
                    height: max-content;
                    background: rgba(255, 255, 255, 0.98);
                    padding: 2.5rem 3rem;
                    border-radius: 1.2rem;
                    box-shadow: 0 8px 16px -1px rgba(0, 0, 0, 0.1), 
                               0 4px 8px -1px rgba(0, 0, 0, 0.06);
                    border: none;
                    z-index: 1000;
                }

                #loadingPopover::backdrop {
                    background: rgba(0, 0, 0, 0.25);
                    backdrop-filter: blur(6px);
                }

                .loading-content {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 1.25rem;
                }

                .loading-spinner {
                    width: 48px;
                    height: 48px;
                    border: 3px solid var(--border-color);
                    border-top-color: var(--primary-color);
                    border-radius: 50%;
                    animation: spin 0.8s linear infinite;
                }

                .loading-text {
                    color: var(--text-primary);
                    font-weight: 500;
                    font-size: 1.1rem;
                    letter-spacing: -0.01em;
                }

                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
        `;this.wrapper.append(t)}};pos_ar.Pricing.PricingFetcher=class{constructor(){console.log("PricingFetcher initialized")}async fetchItemPrices(t){try{let e=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_item_prices",args:{company:t}});return console.log("fetched item prices",e.message),e.message||[]}catch(e){return console.error("Error fetching item prices:",e),[]}}};pos_ar.PointOfSale.Controller=class{constructor(t){this.wrapper=$(t).find(".layout-main-section"),this.page=t.page,this.selectedItemMaps=new Map,this.selectedItem={name:""},this.selectedField={field_name:""},this.selectedTab={tabName:""},this.selectedPaymentMethod={methodName:""},this.defaultCustomer={name:"",customer_name:""},this.defaultPriceList={name:""},this.taxes_and_charges_template=null,this.taxes_and_charges=[],this.payment_methods=[],this.POSOpeningEntry={},this.invoiceData={netTotal:0,grandTotal:0,paidAmount:0,toChange:0,discount:0},this.db=null,this.syncInput=!1,frappe.db.get_list("Customer",{filters:{custom_company:"Optilens BISKRA"},fields:["name"]}).then(e=>{console.log(" customers ::: ",e)}),this.start_app()}async start_app(){try{this.db=await pos_ar.PointOfSale.pos_db.openDatabase(),this.settings_data=new pos_ar.PointOfSale.posSettingsData(this.db),this.dataHandler=new pos_ar.PointOfSale.FetchHandler,this.appData=new pos_ar.PointOfSale.posAppData(this.db,this.dataHandler),await this.appData.getAllData(),this.screenManager=new pos_ar.PointOfSale.ScreenManager(this.settings_data),this.toggleKeyboardMode(!this.settings_data.settings.showItemDetails),this.prepare_container(),await this.prepare_app_data(),await this.checkForPOSEntry(),await this.prepare_components(),this.checkUnSyncedPos(),this.setListeners();let t=await this.appData.getAllOpenedPosInvoice();this.restorePosInvoices(t)}catch(t){console.error("halfware POS Err ==> ",t)}}async prepare_app_data(){try{await this.handleAppData();let t=this.getCustomerDefaultPriceList(this.defaultCustomer.name);(t==""||t==null||t==null)&&(t=this.defaultPriceList.name);let e=frappe.model.get_new_doc("POS Invoice");e.customer=this.defaultCustomer.name,e.pos_profile=this.appData.appData.pos_profile.name,e.items=[],e.taxes_and_charges=this.appData.appData.pos_profile.taxes_and_charges,e.additional_discount_percentage=0,e.paid_amount=0,e.base_paid_amount=0,e.creation_time=frappe.datetime.now_datetime(),e.payments=this.getPaymentMethods(),e.is_pos=1,e.update_stock=1,e.docstatus=0,e.status="Draft",e.priceList=t,e.opened=1;let s=new Date,[i,n,a]=s.toISOString().split("T")[0].split("-"),o=s.getHours(),r=s.getMinutes(),c=s.getMilliseconds();e.refNum=this.appData.appData.pos_profile.name+"-"+i+"-"+n+"-"+a+"-"+o+r+c,e.custom_cach_name=e.refNum,this.selectedItemMaps.set("C1",e),this.selectedTab.tabName="C1"}catch(t){throw console.error("Hlafware POS Error ==> ",t),t}}async handleAppData(){if(this.appData.appData.pos_profile==null)throw frappe.set_route("Form","POS Profile"),new Error("there is no pos profile");if(this.appData.appData.pos_profile.taxes_and_charges!=null&&this.appData.appData.pos_profile.taxes_and_charges!=""&&(this.taxes_and_charges_template=await this.dataHandler.fetchSalesTaxesAndChargesTemplate(this.appData.appData.pos_profile.taxes_and_charges),this.taxes_and_charges=this.taxes_and_charges_template.taxes),this.appData.appData.pos_profile.company!=null&&this.appData.appData.pos_profile.company!=""&&(this.company=await this.dataHandler.fetchCompany(this.appData.appData.pos_profile.company)),this.appData.appData.customers.length>0)this.defaultCustomer=structuredClone(this.appData.appData.customers[0]);else throw frappe.warn("You dont have a customer","please create a customer to continue",()=>{frappe.set_route("Form","Customer")},"Create",!1),new Error("there is no customer");if(this.appData.appData.price_lists.length>0)this.defaultPriceList.name=this.appData.appData.pos_profile.selling_price_list;else throw frappe.warn("You dont have a single price list","please create a priceList to continue",()=>{frappe.set_route("Form","Price List")},"Create",!1),new Error("there is no price list")}prepare_container(){this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/selectorBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/checkInOutCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/itemDetailsCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/paymentMethodCart.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/customerBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/cartBox.css">'),this.wrapper.append('<link rel="stylesheet" type="text/css" href="/assets/pos_ar/css/historyCarts.css">'),this.wrapper.append('<div id="MainContainer" class="rowBoxReverse"></div>'),this.$components_wrapper=this.wrapper.find("#MainContainer")}prepare_components(){this.set_right_and_left_sections(),this.init_item_selector(),this.init_customer_box(),this.init_selected_item(),this.init_item_details(),this.init_paymentCart(),this.init_historyCart(),this.init_checkInOutCart(),this.init_debtCart(),this.init_settingsCart(),this.init_unsyncedPosCart()}async checkForPOSEntry(){let t=frappe.session.user,e=this.appData.appData.pos_profile.name;try{let s=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.check_opening_entry",args:{user:t,posProfile:e}});console.log("the result is :::: ",s," user : ",t," posProfile : ",e);let i=s.message;return i.length===0?(this.create_opening_voucher(),!1):(Object.assign(this.POSOpeningEntry,i[0]),this.db.updateCheckInOutSync(this.POSOpeningEntry.period_start_date),!0)}catch(s){return console.error("error occured : ",s),frappe.throw("Error checking for POS Opening Entry."),!1}}create_opening_voucher(){let t=this,e=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",options:"company:company_currency",change:function(){i.fields_dict.balance_details.df.data.some(a=>{if(a.idx==this.doc.idx)return a.opening_amount=this.value,i.fields_dict.balance_details.grid.refresh(),!0})}}],s=()=>{let a=i.fields_dict.pos_profile.get_value();!a||frappe.db.get_doc("POS Profile",a).then(({payments:o})=>{i.fields_dict.balance_details.df.data=[],this.payment_methods=o,o.forEach(r=>{let{mode_of_payment:c}=r;i.fields_dict.balance_details.df.data.push({mode_of_payment:c,opening_amount:"0"})}),i.fields_dict.balance_details.grid.refresh()})},i=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>n(),onchange:()=>s()},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:e}],primary_action:async function({company:a,pos_profile:o,balance_details:r}){if(!r.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");r=r.filter(d=>d.mode_of_payment);let c="erpnext.selling.page.point_of_sale.point_of_sale.create_opening_voucher",l=await frappe.call({method:c,args:{pos_profile:o,company:a,balance_details:r},freeze:!0});!l.exc&&t.prepare_app_data(l.message),Object.assign(t.POSOpeningEntry,{name:l.message.name,pos_profile:l.message.pos_profile,period_start_date:l.message.period_start_date,company:l.message.company}),t.db.updateCheckInOutSync(t.POSOpeningEntry.period_start_date),t.check_in_out_cart.getAllCheckInOut(),i.hide()},primary_action_label:__("Submit")});i.show();let n=()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:i.fields_dict.company.get_value()}})}set_right_and_left_sections(){this.$components_wrapper.append('<div id="LeftSection" class="columnBoxReverse"></div>'),this.$components_wrapper.append('<div id="RightSection" class="columnBox"></div>'),this.$rightSection=this.$components_wrapper.find("#RightSection"),this.$leftSection=this.$components_wrapper.find("#LeftSection")}init_customer_box(){this.customer_box=new pos_ar.PointOfSale.pos_customer_box(this.$leftSection,this.appData.appData.customers,this.defaultCustomer,()=>{this.screenManager.navigate("home")},this.onSync.bind(this),this.saveCheckInOut.bind(this),this.onMenuClick.bind(this),()=>{this.screenManager.navigate("debt_cart")}),this.screenManager.registerScreen("customer_box",this.customer_box),this.screenManager.customer_box=this.customer_box}init_item_selector(){this.item_selector=new pos_ar.PointOfSale.pos_item_selector(this.$leftSection,this.appData.appData.items,this.appData.appData.item_barcodes,this.appData.appData.item_groups,this.appData.appData.item_prices,this.settings_data.settings,this.defaultPriceList,this.getItemPrice.bind(this),this.auto_select.bind(this),t=>{this.itemClick_selector(t)}),this.screenManager.registerScreen("item_selector",this.item_selector),this.screenManager.item_selector=this.item_selector}init_selected_item(){this.selected_item_cart=new pos_ar.PointOfSale.pos_selected_item_cart(this.$rightSection,this.settings_data,this.selectedItemMaps,this.appData.appData.price_lists,this.appData.appData.customers,this.appData.brands,this.taxes_and_charges,this.invoiceData,this.selectedTab,this.selectedItem,this.selectedField,this.getItemPrice.bind(this),t=>{this.onSelectedItemClick(t)},t=>{this.screenManager.navigate("home")},(t,e)=>{this.onKeyPressed(t,e)},this.createNewTab.bind(this),()=>{this.savePosInvoice(),this.screenManager.navigate("payment_cart")},this.savePosInvoice.bind(this),this.db),this.screenManager.registerScreen("selected_item_cart",this.selected_item_cart),this.screenManager.selected_item_cart=this.selected_item_cart}init_item_details(){this.item_details=new pos_ar.PointOfSale.pos_item_details(this.$leftSection,this.appData.appData.pos_profile.warehouse,this.appData.appData.price_lists,this.appData.appData.item_prices,this.appData.appData.bins,this.selectedItem,this.selectedField,(t,e,s)=>{this.onInput(t,e,s)},()=>{this.screenManager.navigate("home")}),this.screenManager.registerScreen("item_details",this.item_details),this.screenManager.item_details=this.item_details}init_paymentCart(){this.payment_cart=new pos_ar.PointOfSale.pos_payment_cart(this.$leftSection,this.selectedItemMaps,this.selectedTab,this.appData.appData,this.appData.appData.pos_profile.payments,this.selectedPaymentMethod,this.invoiceData,()=>{this.screenManager.navigate("home")},this.onCompleteOrder.bind(this),(t,e,s)=>{this.onInput(t,e,s)}),this.screenManager.registerScreen("payment_cart",this.payment_cart),this.screenManager.payment_cart=this.payment_cart}init_historyCart(){this.history_cart=new pos_ar.PointOfSale.pos_history(this.wrapper,this.db,this.appData.appData.pos_profile,this.appData,this.settings_data,this.company,this.taxes_and_charges,this.historyCartClick.bind(this)),this.screenManager.registerScreen("history_cart",this.history_cart),this.screenManager.history_cart=this.history_cart}init_checkInOutCart(){this.check_in_out_cart=new pos_ar.PointOfSale.pos_check_in_out(this.wrapper,this.db),this.screenManager.registerScreen("check_in_out_cart",this.check_in_out_cart),this.screenManager.check_in_out_cart=this.check_in_out_cart}init_debtCart(){this.debt_cart=new pos_ar.PointOfSale.pos_debt_cart(this.wrapper,this.appData,()=>{this.check_in_out_cart.getAllCheckInOut()}),this.screenManager.registerScreen("debt_cart",this.debt_cart),this.screenManager.debt_cart=this.debt_cart}init_settingsCart(){this.settings_cart=new pos_ar.PointOfSale.pos_settings(this.wrapper,this.settings_data,this.appData.appData.pos_profile,this.onSettingsChange.bind(this)),this.screenManager.registerScreen("settings_cart",this.settings_cart),this.screenManager.settings_cart=this.settings_cart}init_unsyncedPosCart(){this.unsynced_pos_cart=new pos_ar.PointOfSale.pos_unsynced_cart(this.wrapper,this.appData,this.db,t=>{let e=this.selected_item_cart.createTabForEditPOS();this.selectedItemMaps.set(`C${e}`,t),this.selectedTab.tabName=`C${e}`,this.screenManager.navigate("home")},()=>{this.unsyncedPos>=1?(this.customer_box.setSynced(),this.unsyncedPos=0):(this.unsyncedPos-=1,this.customer_box.setNotSynced(this.unsyncedPos))}),this.screenManager.registerScreen("unsynced_pos_cart",this.unsynced_pos_cart),this.screenManager.unsynced_pos_cart=this.unsynced_pos_cart}itemClick_selector(t,e){this.syncInput=!1;let s=structuredClone(t);s.discount_amount=0,s.discount_percentage=0,Object.assign(this.selectedItem,s),this.addItemToPosInvoice(s),this.selected_item_cart.calculateNetTotal(),this.selected_item_cart.calculateVAT(),this.selected_item_cart.calculateQnatity(),this.selected_item_cart.calculateGrandTotal(),this.selected_item_cart.refreshSelectedItem(),e&&this.item_selector.refreshItemSelector(),this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted(),this.selected_item_cart.scrollToBottom(),this.savePosInvoice()}onSelectedItemClick(t){this.syncInput=!1;let e=structuredClone(t);Object.assign(this.selectedItem,e),this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted(),this.screenManager.navigate("item_details"),this.item_details.refreshDate(t)}saveCheckInOut(t){t.is_sync=0,this.appData.saveCheckInOut(t,e=>{this.check_in_out_cart.getAllCheckInOut()},e=>{console.log("err to save checkInOut : ",e)})}onSettingsChange(t){t=="itemPriceBasedOn"&&(this.item_selector.refreshItemSelector(),this.selected_item_cart.resetItemRateBaseOnPriceList(),this.selected_item_cart.refreshSelectedItem())}savePosInvoice(t){this.selectedItemMaps.get(this.selectedTab.tabName).synced=!1,console.log("savePosInvoice : ",this.selectedItemMaps.get(this.selectedTab.tabName)),this.appData.savePosInvoice(this.selectedItemMaps.get(this.selectedTab.tabName))}auto_select(t){this.itemClick_selector(t),this.item_selector.refresh()}onMenuClick(t){t=="recent_pos"?this.screenManager.navigate("history_cart"):t=="close_pos"?this.onClosePOS():t=="unsenced_invoices"?this.screenManager.navigate("unsynced_pos_cart"):t=="settings"?this.screenManager.navigate("settings_cart"):t=="checkInOut"&&this.screenManager.navigate("check_in_out_cart")}getDefaultPaymentMethod(){let t=null;return this.appData.appData.pos_profile.payments.forEach(e=>{e.default&&(t=e)}),t}getPaymentMethods(){let t=[];return this.appData.appData.pos_profile.payments.forEach(e=>{t.push({mode_of_payment:e.mode_of_payment,default:e.default,amount:0})}),t}restorePosInvoices(t){t.forEach(e=>{let s=this.selected_item_cart.createTabForEditPOS();this.selectedItemMaps.set(`C${s}`,e),this.selectedTab.tabName=`C${s}`}),this.screenManager.navigate("home")}createNewTab(t){let e=frappe.model.get_new_doc("POS Invoice");e.customer=this.defaultCustomer.name,e.pos_profile=this.appData.appData.pos_profile.name,e.items=[],e.taxes_and_charges=this.appData.appData.pos_profile.taxes_and_charges,e.additional_discount_percentage=0,e.paid_amount=0,e.base_paid_amount=0,e.creation_time=frappe.datetime.now_datetime(),e.payments=this.getPaymentMethods(),e.is_pos=1,e.update_stock=1,e.docstatus=0,e.synced=!1,e.status="Draft",e.priceList=this.defaultPriceList.name,e.opened=1;let s=new Date,[i,n,a]=s.toISOString().split("T")[0].split("-"),o=s.getHours(),r=s.getMinutes(),c=s.getMilliseconds();e.refNum=this.appData.appData.pos_profile.name+"-"+i+"-"+n+"-"+a+"-"+o+r+c,e.custom_cach_name=e.refNum,this.selectedItemMaps.set(`C${t}`,e),this.selectedTab.tabName=`C${t}`,this.screenManager.navigate("home")}historyCartClick(t,e){if(t=="edit"){let s=this.selected_item_cart.createTabForEditPOS();this.selectedItemMaps.set(`C${s}`,e),this.selectedTab.tabName=`C${s}`,this.screenManager.navigate("home")}else if(t=="duplicate"){let s=this.selected_item_cart.createTabForEditPOS();e.name=frappe.model.get_new_doc("POS Invoice").name,e.pos_profile=this.appData.appData.pos_profile.name,e.taxes_and_charges=this.appData.appData.pos_profile.taxes_and_charges,e.creation_time=frappe.datetime.now_datetime(),e.payments=this.getPaymentMethods(),e.priceList=this.defaultPriceList.name;let i=new Date,[n,a,o]=i.toISOString().split("T")[0].split("-"),r=i.getHours(),c=i.getMinutes(),l=i.getMilliseconds();e.refNum=this.appData.appData.pos_profile.name+"-"+n+"-"+a+"-"+o+"-"+r+c+l,e.custom_cach_name=e.refNum,this.selectedItemMaps.set(`C${s}`,e),this.selectedTab.tabName=`C${s}`,this.screenManager.navigate("home")}else if(t=="return"){let s=this.selected_item_cart.createTabForEditPOS(),i=this.makePosInvoiceReturn(e);this.selectedItemMaps.set(`C${s}`,i),this.selectedTab.tabName=`C${s}`,this.screenManager.navigate("home")}}onInput(t,e,s){if(t=="focus"||t=="blur"){t=="focus"&&Object.assign(this.selectedField,{field_name:e}),t=="blur"&&Object.assign(this.selectedField,{field_name:null}),this.item_details.makeSelectedFieldHighlighted(),this.selected_item_cart.makeSelectedButtonHighlighted();return}if(e=="quantity")this.selectedItem.qty=parseFloat(s),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem();else if(e=="rate"){this.selectedItem.rate=parseFloat(s);let i=this.selectedItem.rate,n=this.selectedItem.discount_percentage,a=i*(n/100);this.selectedItem.discount_percentage=n,this.selectedItem.discount_amount=a,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(e=="discount_percentage"){let n=this.selectedItem.rate*(parseFloat(s)/100);this.selectedItem.discount_percentage=parseFloat(s),this.selectedItem.discount_amount=n,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemDiscountPercentage(this.selectedItem.name,this.selectedItem.discount_percentage),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}else if(e=="discount_amount"){let i=this.selectedItem.rate,n=(parseFloat(s)*100/i).toFixed(2),a=parseFloat(s);n>100&&(n=100),parseFloat(s)>i&&(a=i),this.selectedItem.discount_percentage=parseFloat(n),this.selectedItem.discount_amount=a,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemDiscountPercentage(this.selectedItem.name,this.selectedItem.discount_percentage),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}this.savePosInvoice()}onKeyPressed(t,e){var s,i;if(t=="quantity")this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted();else if(t=="rate")this.selectedField.field_name="rate",this.selected_item_cart.makeSelectedButtonHighlighted();else if(t=="minus"){this.syncInput=!0;let n=parseFloat(this.selectedItem.qty)*-1;this.selectedItem.qty=parseFloat(n),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem()}else if(t=="print"){this.history_cart.print_receipt(structuredClone(this.selectedItemMaps.get(this.selectedTab.tabName))),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem),this.savePosInvoice();return}else if(t=="remove")this.syncInput=!1,this.deleteItemFromPOsInvoice(this.selectedItem.name);else if(t=="delete"){if(!this.settings_data.settings.showItemDetails){if(this.selectedField.field_name=="quantity"){let o=`${parseFloat(this.selectedItem.qty)}`.slice(0,-1);this.selectedItem.qty=parseFloat(o)||0}else if(this.selectedField.field_name=="rate"){let o=`${parseFloat(this.selectedItem.rate)}`.slice(0,-1);this.selectedItem.rate=parseFloat(o)||0;let r=this.selectedItem.rate,c=this.selectedItem.discount_percentage,l=r*(c/100);this.selectedItem.discount_percentage=c,this.selectedItem.discount_amount=l,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate)}else if(this.selectedField.field_name=="discount_percentage"){let a=this.selectedItem.rate,r=`${(s=this.selectedItem.discount_percentage)!=null?s:0}`+e,c=parseFloat(r);c>100&&(c=100);let l=a*(c/100),d=a-l;this.selectedItem.discount_percentage=c,this.selectedItem.discount_amount=l}}let n=parseFloat(this.item_details.deleteCharacter());if(this.selectedField.field_name=="quantity")this.selectedItem.qty=n;else if(this.selectedField.field_name=="rate"){this.selectedItem.rate=n;let a=this.selectedItem.rate,o=this.selectedItem.discount_percentage,r=a*(o/100);this.selectedItem.discount_amount=r}else if(this.selectedField.field_name=="discount_percentage"){let o=this.selectedItem.rate*(n/100);this.selectedItem.discount_percentage=n,this.selectedItem.discount_amount=o}else if(this.selectedField.field_name=="discount_percentage"){let o=this.selectedItem.rate*(n/100);this.selectedItem.discount_percentage=n,this.selectedItem.discount_rate=o}else this.selectedField.field_name=="cash"&&this.payment_cart.deleteKeyPress()}else if(t=="addToField"){if(this.selectedField.field_name=="cash")this.payment_cart.handleInput(e);else if(this.selectedField.field_name=="quantity"){let n=0;this.syncInput?n=parseFloat(this.selectedItem.qty):(n=0,this.syncInput=!0);let a=`${n}`+e;this.selectedItem.qty=parseFloat(a)}else if(this.selectedField.field_name=="rate"){let n=0;this.syncInput?n=parseFloat(this.selectedItem.rate):(n=0,this.syncInput=!0);let a=`${n}`+e;this.selectedItem.rate=parseFloat(a);let o=this.selectedItem.rate,r=this.selectedItem.discount_percentage,c=o*(r/100);this.selectedItem.discount_percentage=r,this.selectedItem.discount_amount=c,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate)}else if(this.selectedField.field_name=="discount_percentage"){let n=this.selectedItem.rate,o=`${(i=this.selectedItem.discount_percentage)!=null?i:0}`+e,r=parseFloat(o);r>100&&(r=100);let c=n*(r/100),l=n-c;this.selectedItem.discount_percentage=r,this.selectedItem.discount_amount=c}}this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem),this.savePosInvoice()}onCompleteOrder(){if(this.payment_cart.show_waiting(),this.savePosInvoice(),this.defaultCustomer.name==""){frappe.warn("Customer didnt selected!","you have to select a customer",()=>{},"Done",!1);return}let t=[],e=1;if(this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{let o={item_name:a.item_name,item_code:a.item_code,rate:a.rate,qty:a.qty,description:a.description,image:a.image,use_serial_batch_fields:1,cost_center:this.appData.appData.pos_profile.cost_center,discount_percentage:a.discount_percentage,discount_amount:a.discount_amount,warehouse:this.appData.appData.pos_profile.warehouse,income_account:this.appData.appData.pos_profile.income_account};t.push(o),a.qty>0&&(e=0)}),this.selectedItemMaps.get(this.selectedTab.tabName).is_return=e,this.selectedItemMaps.get(this.selectedTab.tabName).items=t,t.length==0)return;let s=0;this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(a=>{s+=a.rate*a.qty}),this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName))>s?(this.selectedItemMaps.get(this.selectedTab.tabName).paid_amount=s,this.selectedItemMaps.get(this.selectedTab.tabName).base_paid_amount=s,this.selectedItemMaps.get(this.selectedTab.tabName).outstanding_amount=0,this.selectedItemMaps.get(this.selectedTab.tabName).total_customer_payment=this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName))):(this.selectedItemMaps.get(this.selectedTab.tabName).paid_amount=this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName)),this.selectedItemMaps.get(this.selectedTab.tabName).base_paid_amount=this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName)),this.selectedItemMaps.get(this.selectedTab.tabName).outstanding_amount=this.invoiceData.grandTotal-this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName)),this.selectedItemMaps.get(this.selectedTab.tabName).total_customer_payment=this.calculatePaidAmount(this.selectedItemMaps.get(this.selectedTab.tabName))),this.selectedItemMaps.get(this.selectedTab.tabName).docstatus=1;let i=this.checkIfPaid(this.selectedItemMaps.get(this.selectedTab.tabName));this.selectedItemMaps.get(this.selectedTab.tabName).status=i;let n=structuredClone(this.selectedItemMaps.get(this.selectedTab.tabName));if(i=="Unpaid")n.synced=!0,frappe.db.insert(n).then(a=>{this.payment_cart.hide_waiting(),n.opened=0,n.real_name=a.name,this.history_cart.print_receipt(n),this.appData.updatePosInvoice(n),this.selectedItemMaps.delete(this.selectedTab.tabName);let o=Array.from(this.selectedItemMaps.keys());o.length>0?(this.selectedTab.tabName=o[0],this.selected_item_cart.refreshTabs(),this.selected_item_cart.refreshSelectedItem()):this.selected_item_cart.createNewTab(),this.screenManager.navigate("home")}).catch(a=>{this.payment_cart.hide_waiting(),console.log("cant push pos invoice : ",a)});else{this.payment_cart.hide_waiting(),this.history_cart.print_receipt(n),this.selectedItemMaps.delete(this.selectedTab.tabName);let a=Array.from(this.selectedItemMaps.keys());a.length>0?(this.selectedTab.tabName=a[0],this.selected_item_cart.refreshTabs(),this.selected_item_cart.refreshSelectedItem()):this.selected_item_cart.createNewTab(),this.screenManager.navigate("home"),n.synced=!1,n.opened=0,this.appData.updatePosInvoice(n),this.unsyncedPos+=1,this.customer_box.setNotSynced(this.unsyncedPos)}}onSync(){if(this.POSOpeningEntry.name==""){this.checkForPOSEntry();return}if(this.unsyncedPos<=0){frappe.msgprint({title:__("Sync Complete"),indicator:"green",message:__("All data is already synchronized.")});return}let t=0,e=0;this.appData.getNotSyncedPos(s=>{frappe.show_progress("Syncing Invoices...",0,s.length,"syncing"),s.forEach(i=>{frappe.db.insert(i).then(n=>{let a=structuredClone(i);a.synced=!0,a.real_name=n.name,this.appData.updatePosInvoice(a),t+=1,frappe.show_progress("Syncing Invoices...",t,s.length,"syncing"),t==s.length&&(frappe.hide_progress(),this.customer_box.setSynced(),this.unsyncedPos=0)}).catch(n=>{t+=1,e+=1,t==s.length&&(frappe.hide_progress(),this.customer_box.setSynced(),this.unsyncedPos=0)})})},s=>{console.log("cant get the unseced POS from local")})}getCustomerDefaultPriceList(t){let e="";return this.appData.appData.customers.forEach(s=>{s.name==t&&(e=s.default_price_list)}),e}checkIfPaid(t){let e=0,s=0,i=0,n=0;return t.items.forEach(a=>{e+=a.qty*a.rate}),this.taxes_and_charges.forEach(a=>{i+=a.rate/100*e}),n=t.additional_discount_percentage/100*e,s=e+i-n,t.paid_amount==0||t.paid_amount<s?"Unpaid":"Paid"}checkIfRateZero(t){return t.items.some(e=>e.rate==0)}onClosePOS(){this.unsyncedPos>0&&frappe.throw(__("you have  some invoices to sync first."));let t=frappe.model.get_new_doc("POS Closing Entry");t.pos_opening_entry=this.POSOpeningEntry.name,t.pos_profile=this.POSOpeningEntry.pos_profile,t.company=this.POSOpeningEntry.company,t.user=frappe.session.user,t.posting_date=frappe.datetime.now_date(),t.posting_time=frappe.datetime.now_time(),this.check_in_out_cart.checkList.filter(s=>s.is_sync===0).forEach(s=>{let i=frappe.model.add_child(t,"check_in_out","custom_check_in_out");i.check_type=s.check_type,i.creation_time=s.creation_time,i.amount=s.amount,i.reason_note=s.reason_note,i.user=s.owner}),frappe.set_route("Form","POS Closing Entry",t.name).then(()=>{window.addEventListener("popstate",s=>{frappe.set_route("Form","POS Closing Entry",t.name)})}),this.POSOpeningEntry.name=""}setListeners(){window.addEventListener("offline",function(){frappe.msgprint("you lose the connection (offline mode)")}),window.addEventListener("online",function(){frappe.msgprint("the connection is back (online mode)")})}makePosInvoiceReturn(t){let e=structuredClone(t),s=frappe.model.get_new_doc("POS Invoice").name;e.name=s,e.is_return=1,e.return_against=t.real_name,e.real_name="",e.consolidated_invoice=null,e.outstanding_amount=0;let i=[];e.items.forEach(p=>{if(p.qty>0){let h=structuredClone(p);h.qty=h.qty*-1,h.description="Returned item",i.push(h)}}),e.items=i,e.pos_profile=this.appData.appData.pos_profile.name,e.taxes_and_charges=this.appData.appData.pos_profile.taxes_and_charges,e.creation_time=frappe.datetime.now_datetime(),e.payments=this.getPaymentMethods(),e.priceList=this.defaultPriceList.name;let n=new Date,[a,o,r]=n.toISOString().split("T")[0].split("-"),c=n.getHours(),l=n.getMinutes(),d=n.getMilliseconds();return e.refNum=this.appData.appData.pos_profile.name+"-"+a+"-"+o+"-"+r+"-"+c+l+d,e.custom_cach_name=e.refNum,e}toggleKeyboardMode(t){t?document.addEventListener("keydown",e=>{let s=document.activeElement;if(!(s.tagName==="INPUT"||s.tagName==="TEXTAREA"||s.isContentEditable)){if(e.key=="q")this.selectedField.field_name="quantity",this.selected_item_cart.makeSelectedButtonHighlighted();else if(e.key=="p")this.selectedField.field_name="rate",this.selected_item_cart.makeSelectedButtonHighlighted();else if(e.key=="Delete")this.deleteItemFromPOsInvoice(this.selectedItem.name),this.selected_item_cart.refreshSelectedItem(),this.screenManager.navigate("home");else if(e.key=="Backspace"){if(this.selectedField.field_name=="quantity"){let n=parseFloat(this.selectedItem.qty),a=0;a=parseFloat(`${n}`.slice(0,-1))||0,this.selectedItem.qty=parseFloat(a),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem()}else if(this.selectedField.field_name=="rate"){let n=parseFloat(this.selectedItem.rate),a=parseFloat(`${n}`.slice(0,-1))||0;this.selectedItem.rate=parseFloat(a);let o=this.selectedItem.rate,r=this.selectedItem.discount_percentage,c=o*(r/100);this.selectedItem.discount_percentage=r,this.selectedItem.discount_amount=c,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}}else if(this.selectedField.field_name=="quantity"){if(parseFloat(e.key)||e.key=="0"){let n=0;this.syncInput?n=parseFloat(this.selectedItem.qty):(n=0,this.syncInput=!0);let a=`${n}`+e.key;this.selectedItem.qty=parseFloat(a),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem()}else if(e.key=="-"){this.syncInput=!0;let n=parseFloat(this.selectedItem.qty)*-1;this.selectedItem.qty=parseFloat(n),this.editPosItemQty(this.selectedItem.name,this.selectedItem.qty),this.selected_item_cart.refreshSelectedItem()}}else if(this.selectedField.field_name=="rate"&&(parseFloat(e.key)||e.key=="0")){let n=0;this.syncInput?n=parseFloat(this.selectedItem.rate):(n=0,this.syncInput=!0);let a=`${n}`+e.key;this.selectedItem.rate=parseFloat(a);let o=this.selectedItem.rate,r=this.selectedItem.discount_percentage,c=o*(r/100);this.selectedItem.discount_percentage=r,this.selectedItem.discount_amount=c,this.editPosItemDiscountAmount(this.selectedItem.name,this.selectedItem.discount_amount),this.editPosItemRate(this.selectedItem.name,this.selectedItem.rate),this.selected_item_cart.refreshSelectedItem(),this.item_details.refreshDate(this.selectedItem)}}}):document.removeEventListener("keydown",e=>{})}getItemPrice(t,e){let s=this.settings_data.settings.itemPriceBasedOn;if(s=="brand"){if(t.brand==null)return 0;let i=this.appData.appData.item_prices.find(n=>n.brand==t.brand&&n.price_list==e);return i?i.price_list_rate:0}else if(s=="priceList"){let i=this.appData.appData.item_prices.find(n=>n.item_code==t.item_name&&n.price_list==e);return i?i.price_list_rate:0}}checkServiceWorker(){"serviceWorker"in navigator&&(window.addEventListener("DOMContentLoaded",()=>{navigator.serviceWorker.register("./sw.js").then(t=>console.log("Service Worker registered successfully.")).catch(t=>console.log(`Service Worker registration failed: ${t}`))}),this.sw=new pos_ar.PointOfSale.Sw,document.readyState==="complete"&&navigator.serviceWorker.register("../assets/pos_ar/public/js/sw.js").then(t=>console.log("Service Worker registered successfully.")).catch(t=>console.log(`Service Worker registration failed: ${t}`)))}checkUnSyncedPos(){this.appData.getNotSyncedPosNumber(t=>{this.unsyncedPos=t,this.unsyncedPos==0?this.customer_box.setSynced(t):this.customer_box.setNotSynced(t)},t=>{console.log(`error occured when check unSynced POS : ${t} `)})}addItemToPosInvoice(t){let e=structuredClone(t),i=this.selectedItemMaps.get(this.selectedTab.tabName).items,n=!1;if(i.forEach(a=>{if(a.name==t.name){n=!0,a.qty+=1;let o=structuredClone(a);Object.assign(this.selectedItem,o)}}),!n){e.item_code=e.name,e.discount_amount=0,e.discount_percentage=0,e.qty=1,e.rate=this.getItemPrice(t,this.selectedItemMaps.get(this.selectedTab.tabName).priceList),i.push(e);let a=structuredClone(e);Object.assign(this.selectedItem,a)}}deleteItemFromPOsInvoice(t){let e=this.selectedItemMaps.get(this.selectedTab.tabName),s=e.items;e.items=s.filter(i=>i.name!=t),this.selectedItem=structuredClone({name:""})}editPosItemQty(t,e){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(i=>{i.name==t&&(i.qty=e)})}editPosItemRate(t,e){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(i=>{i.name==t&&(i.rate=e)})}editPosItemDiscountPercentage(t,e){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(i=>{i.name==t&&(i.discount_percentage=e)})}editPosItemDiscountAmount(t,e){this.selectedItemMaps.get(this.selectedTab.tabName).items.forEach(i=>{i.name==t&&(i.discount_amount=e)})}calculatePaidAmount(t){let e=0;return t.payments.forEach(s=>{e+=s.amount}),e}};pos_ar.PointOfSale.pos_item_selector=class{constructor(t,e,s,i,n,a,o,r,c,l){this.wrapper=t,this.item_list=e,this.item_barcodes=s,this.item_group_list=i,this.item_prices=n,this.settings_data=a,this.selected_price_list=o,this.get_item_price=r,this.auto_select=c,this.on_item_click=l,this.barcode_map={},this.item_barcodes.forEach(d=>{this.barcode_map[d.barcode]||(this.barcode_map[d.barcode]=[]),this.barcode_map[d.barcode].push(d.parent)}),this.start_item_selector()}start_item_selector(){this.prepare_select_box(),this.setItemGroupsInList(),this.setItemInFlow(this.getItemByItemGroup("")),this.setListeners()}refresh(){this.setItemInFlow(this.getItemByItemGroup(""))}prepare_select_box(){this.wrapper.append('<div id="SelectorBox" class="columnBox" ></div>'),this.selectorBox=this.wrapper.find("#SelectorBox"),this.selectorBox.append('<div id="selectorBoxHeader" class="rowBox header"></div>'),this.header=this.selectorBox.find("#selectorBoxHeader"),this.header.append('<h4 class="CartTitle">Items</h4>'),this.header.append('<div id="inputsBox" class="rowBox align_center"></div>'),this.inputBox=this.header.find("#inputsBox"),this.inputBox.append('<input type="text" autocomplete="off"  maxlength="140" placeholder="Search by item code, item name or barcode" id="ItemInput" name="item" placeHolder="Enter the customer">'),this.inputBox.append('<input list="ItemGroupList"  id="ItemGroupInput" name="ItemGroup" placeHolder="Item Group">'),this.inputBox.append('<datalist id="ItemGroupList"></datalist>'),this.itemGroupList=this.inputBox.find("#ItemGroupList"),this.itemGroupList.append("<option>fetching Item Groups ...</option>"),this.settings_data.search_by_group||(console.log(" see settings ",this.settings_data),this.inputBox.find("#ItemGroupInput").hide()),this.selectorBox.append('<div id="itemsContainer" class="rowBox row_wrap"></div>'),this.itemsContainer=this.selectorBox.find("#itemsContainer")}setItemGroupsInList(){let t=document.getElementById("ItemGroupList");t.innerHTML="",this.item_group_list.forEach(e=>{let s=document.createElement("option");s.value=e.name,s.textContent=e.customer_name,t.appendChild(s)})}refreshItemSelector(){let t=document.getElementById("ItemInput");t.value="";let e=document.getElementById("ItemGroupInput");this.setItemInFlow(this.getItemByItemGroup(e.value))}setItemInFlow(t){let e=document.getElementById("itemsContainer");e.innerHTML="";let s=document.getElementById("ItemInput");if(t.length===0){e.innerHTML=`
				<div class="no-items-found">
					<svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M15.5 15.5L19 19" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						<path d="M5 11C5 14.3137 7.68629 17 11 17C12.6597 17 14.1621 16.3261 15.2483 15.2483C16.3261 14.1621 17 12.6597 17 11C17 7.68629 14.3137 5 11 5C7.68629 5 5 7.68629 5 11Z" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
					<p>No items found</p>
				</div>
			`;return}for(let i=0;i<t.length&&i<300;i++){let n=t[i],a=document.createElement("div");a.classList.add("itemBox"),a.classList.add("columnBox"),a.classList.add("C_A_Center"),a.addEventListener("click",c=>{let l=s.value.length>0;this.on_item_click(n,l)});let o=n.image||"/assets/pos_ar/images/no_image.png",r=this.get_item_price(n,this.selected_price_list.name);a.innerHTML=`
				<img class="itemImage" src="${o}" alt="${n.item_name}" onerror="this.src='/assets/pos_ar/images/no_image.png'">
				<div class="itemTitle">${n.item_name}</div>
				<div class="itemPrice">${r} DA</div>
			`,e.appendChild(a)}t.length>=700&&e.insertAdjacentHTML("beforeend",`
				<div class="more-items-notice">
					<p>Showing first 700 items. Please refine your search to see more specific results.</p>
				</div>
			`)}showCart(){this.selectorBox.css("display","flex")}hideCart(){this.selectorBox.css("display","none")}setListeners(){document.getElementById("ItemGroupInput").addEventListener("input",s=>{this.setItemInFlow(this.getItemByItemGroup(event.target.value))}),document.getElementById("ItemInput").addEventListener("input",s=>{this.setItemInFlow(this.filterListByItemData(s.target.value))})}filterListByItemData(t){let e=this.barcode_map[t];if(e&&e.length>0){let s=this.item_list.filter(i=>e.includes(i.name));if(s.length===1){this.auto_select(s[0]);let i=document.getElementById("ItemInput");return i.value="",this.item_list}else if(s.length>1)return s}return this.item_list.filter(s=>s.item_name.toLowerCase().includes(t.toLowerCase()))}getItemByItemGroup(t){let e=[],s=a=>{e.push(a),this.item_group_list.forEach(o=>{o.parent_item_group==a&&(e.push(o.name),o.is_group&&s(o.name))})};s(t);let i=[],n=a=>{this.item_list.forEach(o=>{o.item_group==a&&i.push(o)})};return e.forEach(a=>{n(a)}),i}};pos_ar.PointOfSale.pos_customer_box=class{constructor(t,e,s,i,n,a,o,r){this.wrapper=t,this.customers_list=e,this.selected_customer=s,this.back_home=i,this.on_sync=n,this.on_menu_click=o,this.save_check_in_out=a,this.on_debt_click=r,this.online=!0,this.show_menu=!1,this.start_work()}start_work(){this.prepare_customer_box(),this.checkForSync(),this.setListeners()}prepare_customer_box(){this.wrapper.append('<div id="ActionsContainerBox">'),this.actionContainer=this.wrapper.find("#ActionsContainerBox"),this.actionContainer.append(`
			<div id="SyncBox" class="action-btn">
				<span id="syncBoxContent">Sync</span>
			</div>
		`),this.actionContainer.append(`
			<div id="HomeBox" class="action-btn" style="display:none;">
				<img src="/assets/pos_ar/images/home.png" alt="Home">
			</div>
		`),this.actionContainer.append(`
			<div id="DebtBox" class="action-btn">
				<img src="/assets/pos_ar/images/debt.png" alt="Debt">
			</div>
		`),this.actionContainer.append(`
			<div id="exchangeBtn" class="action-btn">
				<img src="/assets/pos_ar/images/exchange.png" alt="Exchange">
			</div>
		`),this.actionContainer.append(`
			<div id="MenuBox" class="action-btn">
				<img src="/assets/pos_ar/images/menu.png" alt="Menu">
				<div id="menuItemsContainer">
					<div id="posInvoiceMenuItem"       class="menuItem">Recent POS Invoices</div>
					<div id="checkInOutMenuItem"       class="menuItem">Check In/Out</div>
					<div id="unsencedInvoicesMenuItem" class="menuItem">Unsenced invoices</div>
					<div id="closePosMenuItem"         class="menuItem">Close the POS</div>
					<div id="settingMenuItem"          class="menuItem">About</div>
				</div>
			</div>
		`),this.sync_btn=this.actionContainer.find("#SyncBox"),this.sync_btn_content=this.sync_btn.find("#syncBoxContent"),this.home=this.actionContainer.find("#HomeBox"),this.debt=this.actionContainer.find("#DebtBox"),this.exchange_btn=this.actionContainer.find("#exchangeBtn"),this.menu=this.actionContainer.find("#MenuBox"),this.menuItemsContainer=this.actionContainer.find("#menuItemsContainer"),this.pos_invoices=this.menuItemsContainer.find("#posInvoiceMenuItem"),this.check_in_out=this.menuItemsContainer.find("#checkInOutMenuItem"),this.close_pos=this.menuItemsContainer.find("#closePosMenuItem"),this.unsenced_invoices=this.menuItemsContainer.find("#unsencedInvoicesMenuItem"),this.setting=this.menuItemsContainer.find("#settingMenuItem"),this.wrapper.append('<div id="darkFloatingBackground"></div>'),this.dark_floating_background=this.wrapper.find("#darkFloatingBackground"),this.wrapper.append(`
			<div id="checkInOutDialog">
				<div class="dialog-header">
					<h2>Add Transaction</h2>
				</div>
				<div id="checkTypeContainer">
					<div id="checkInType" class="rowBox centerItem checkType selected">
						<div class="type-icon">
							<img src="/assets/pos_ar/images/arrow.png" style="transform: rotate(180deg);" alt="In">
						</div>
						<div class="type-text">Check In</div>
					</div>
					<div id="checkOutType" class="rowBox centerItem checkType">
						<div class="type-icon">
							<img src="/assets/pos_ar/images/arrow.png" alt="Out">
						</div>
						<div class="type-text">Check Out</div>
					</div>
				</div>
				<div class="inputGroup">
					<label for="check_in_out_input">Amount</label>
					<input autocomplete="off" required type="number" id="check_in_out_input" placeholder="Enter amount">
				</div>
				<div class="inputGroup">
					<label for="check_in_out_note_textarea">Reason</label>
					<textarea id="check_in_out_note_textarea" placeholder="Enter reason for transaction"></textarea>
				</div>
				<div id="btnsContainers" class="rowBox">
					<button id="cancelBtn" class="dialogBtn rowBox centerItem">Cancel</button>
					<button id="confirmBtn" class="dialogBtn rowBox centerItem">Confirm</button>
				</div>
			</div>
		`),this.check_in_out_dialog=this.wrapper.find("#checkInOutDialog"),this.check_in_out_dialog.css("flex-direction","column"),this.check_type_container=this.check_in_out_dialog.find("#checkTypeContainer"),this.check_in_box=this.check_type_container.find("#checkInType"),this.check_out_box=this.check_type_container.find("#checkOutType"),this.check_in_out_type="In",this.check_in_out_input=this.check_in_out_dialog.find("#check_in_out_input"),this.check_in_out_note=this.check_in_out_dialog.find("#check_in_out_note_textarea"),this.cancel_dialog_btn=this.check_in_out_dialog.find("#cancelBtn"),this.confirm_dialog_btn=this.check_in_out_dialog.find("#confirmBtn")}showHomeBar(){this.home.css("display","flex")}hideHomeBar(){this.home.css("display","none")}showSyncBar(){this.sync_btn.css("display","flex")}hideSyncBar(){this.sync_btn.css("display","none")}showCheckInOutDialog(){this.check_in_out_dialog.css("display","flex"),this.dark_floating_background.css("display","flex")}hideCheckInOutDialog(){this.checkAmount=0,this.check_in_out_dialog.css("display","none"),this.dark_floating_background.css("display","none"),this.check_in_out_input.val(0)}checkForSync(){this.sync_btn.addClass("Synced")}setListeners(){this.sync_btn.on("click",t=>{frappe.confirm("Are you sure you want to sync",()=>{this.on_sync()},()=>{})}),this.close_pos.on("click",t=>{this.on_menu_click("close_pos")}),this.unsenced_invoices.on("click",t=>{this.on_menu_click("unsenced_invoices")}),this.pos_invoices.on("click",t=>{this.on_menu_click("recent_pos")}),this.setting.on("click",t=>{this.on_menu_click("settings")}),this.check_in_out.on("click",t=>{this.on_menu_click("checkInOut")}),this.menu.on("click",t=>{this.show_menu?(this.show_menu=!this.show_menu,this.menuItemsContainer.css("visibility","hidden"),this.menuItemsContainer.css("opacity","0")):(this.show_menu=!this.show_menu,this.menuItemsContainer.css("visibility","visible"),this.menuItemsContainer.css("opacity","1"))}),this.home.on("click",t=>{this.back_home()}),this.debt.on("click",t=>{this.on_debt_click()}),this.exchange_btn.on("click",t=>{this.showCheckInOutDialog()}),this.dark_floating_background.on("click",t=>{this.hideCheckInOutDialog()}),this.check_in_box.on("click",t=>{this.check_in_out_type="In",this.check_in_box.addClass("selected"),this.check_out_box.removeClass("selected")}),this.check_out_box.on("click",t=>{this.check_in_out_type="Out",this.check_out_box.addClass("selected"),this.check_in_box.removeClass("selected")}),this.check_in_out_input.on("input",t=>{}),this.cancel_dialog_btn.on("click",t=>{console.log("cancel"),this.hideCheckInOutDialog()}),this.confirm_dialog_btn.on("click",t=>{let e=frappe.model.get_new_doc("check_in_out");if(e.creation_time=frappe.datetime.now_datetime(),e.user=frappe.session.user,e.check_type=this.check_in_out_type,e.amount=parseFloat(this.check_in_out_input.val()),e.reason_note=this.check_in_out_note.val(),parseFloat(this.check_in_out_input.val())<=0||this.check_in_out_note.val()==""){frappe.msgprint("you should fulfilled fileds.");return}this.save_check_in_out(e),this.hideCheckInOutDialog(),console.log("checkInOut : ",e)})}setSynced(){this.sync_btn.addClass("Synced"),this.sync_btn.removeClass("NotSynced"),this.sync_btn_content.html("Synced")}setNotSynced(t){this.sync_btn.addClass("NotSynced"),this.sync_btn.removeClass("Synced"),this.sync_btn_content.html(`Sync (${t})`)}};pos_ar.PointOfSale.pos_selected_item_cart=class{constructor(t,e,s,i,n,a,o,r,c,l,d,p,h,m,f,g,_,v,b){this.wrapper=t,this.settings_data=e,this.selected_item_maps=s,this.price_lists=i,this.customer_list=n,this.brand_list=a,this.sales_taxes=o,this.invoice_data=r,this.selected_tab=c,this.selected_item=l,this.selected_field=d,this.get_item_price=p,this.on_key_pressed=f,this.on_checkout_click=_,this.on_selected_item_click=h,this.on_tab_click=m,this.create_new_tab=g,this.save_pos_invoice=v,this.db=b,this.taxes_map=new Map,this.total_tax_amout=0,this.counter=1,this.show_discount=!1,this.start_work()}start_work(){this.prepare_selected_item_cart(),this.fulfillingSelects(),this.setButtonsListeners(),this.setListener()}prepare_selected_item_cart(){let t="",e="",s="",i="";this.settings_data.settings.keyboardStyle==this.settings_data.keyboard_styles[0]?(t="margin:0px 16px;padding:0px 0px 16px 0px;",e="width:100%;display:grid;grid-template-columns:auto auto auto auto;",s="height:45px;padding:4px;margin:6px;background:#f5f5f5;border:2px solid #e0e0e0;border-radius:12px;color:black;font-size:small;text-align:center;display:flex;justify-content:center;align-items:center;",i="width:calc(100% - 32px);margin:0px 16px 16px 16px;padding : 8px 0px ;color:#FFFFFF;font-size:larger;font-weight:600;background:#44A292;border:3px solid #2D6B61;border-radius:8px;outline:none;"):(t="width:100%;",e="width:100%;display:grid;grid-template-columns:auto auto auto auto;",s="height:45px;padding:4px;background:#f5f5f5;border:1px solid #a0a0a0;color:black;font-size:small;text-align:center;display:flex;justify-content:center;align-items:center;",i="width:100%;height:55px;color:#FFFFFF;font-size:19px;font-weight:600;background:#44A292;border:none;outline:none;"),this.wrapper.append('<div id="tabs"    class="rowBox"><div id="tabs_container" class="rowBox" style="overflow-x:auto;overflow-y:hidden;" ></div></div>'),this.wrapper.append('<div id="CartBox" class="columnBox"></div>'),this.tabs_bar=this.wrapper.find("#tabs"),this.tabs_container=this.tabs_bar.find("#tabs_container"),this.cartBox=this.wrapper.find("#CartBox"),this.tabs_container.append('<div class="tab selected rowBox align_center"><div class="tabName">C1</div><img src="/assets/pos_ar/images/cancel.png" width="10px" height="10px" class="tabDeleteBtn"></div>'),this.tabs_bar.append('<div id="addTabBtn" class="tab unselected">+</div>'),this.add_tab_button=this.tabs_bar.find("#addTabBtn"),this.cartBox.append('<div id="CartBoxTopBar" class=" rowBox align_center  row_sbtw"><div>'),this.cartBox.append('<div id="cartHeader" class="rowBox row_sbtw align_center"></div>'),this.cartBox.append('<div id="selectedItemsContainer" class="columnBox"></div>'),this.cartBox.append('<div id="cartFooter" class="columnBox"></div>'),this.cartTopBar=this.cartBox.find("#CartBoxTopBar"),this.cartTopBar.append('<div id="selectedCustomerInput"></div>'),this.cartTopBar.append('<div id="selectedBrandInput"></div>'),this.cartTopBar.append('<div id="selectedItemsPriceListInput"></div>'),this.customerInputContainer=this.cartTopBar.find("#selectedCustomerInput"),this.customerInputContainer.append('<select  id="customerInput"  placeHolder="Choice a customer">'),this.customerInput=this.customerInputContainer.find("#customerInput"),this.priceListInputContainer=this.cartTopBar.find("#selectedItemsPriceListInput"),this.priceListInputContainer.append('<select  id="PriceListInput" name="PriceList" placeHolder="Choice a Price list">'),this.priceListInput=this.priceListInputContainer.find("#PriceListInput"),this.cartHeader=this.cartBox.find("#cartHeader"),this.cartHeader.append('<div style="font-size:16px;font-weight:600;"><p>Item</p></div>'),this.cartHeader.append('<div id="cartHeaderTitles" class="rowBox"></div>'),this.cartHeaderTitles=this.cartHeader.find("#cartHeaderTitles"),this.cartHeaderTitles.append('<div id="quantityTitle" style="font-size:16px;font-weight:600;margin-right:16px;" >  <p>Quantity</p></div>'),this.cartHeaderTitles.append('<div id="amountTitle"   style="font-size:16px;font-weight:600;" >  <p>Amount  </p></div>'),this.selectedItemContainer=this.cartBox.find("#selectedItemsContainer"),this.cartFooter=this.cartBox.find("#cartFooter"),this.cartFooter.append('<div id="cartDetails" class="columnBox"></div>'),this.cartFooter.append(`<div id="editSelectedItemCart" style="${t}"></div>`),this.cartFooter.append(`<div id="mainBtnContainer" class="rowBox centerItem"  style="${i}">  </div>`),this.cartDetails=this.cartFooter.find("#cartDetails"),this.cartDetails.append('<div id="discount" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="totalQuantity" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="netTotal" class="rowBox align_center row_sbtw"></div>'),this.cartDetails.append('<div id="VAT" class="columnBox"></div>'),this.cartDetails.append('<div id="grandTotal" class="rowBox align_center row_sbtw"></div>'),this.discount=this.cartDetails.find("#discount"),this.discount.append('<div id="addDiscountTitle">Add Discount % </div>'),this.discount.append('<input type="number" id="addGlobalDiscountInput" value="0" step="1" min="0" max="100" >'),this.discountInput=this.discount.find("#addGlobalDiscountInput"),this.discountTitle=this.discount.find("#addDiscountTitle"),this.totalQuantity=this.cartDetails.find("#totalQuantity"),this.totalQuantity.append('<div id="totalQuantityTitle">Total Quantity</div>'),this.totalQuantity.append('<div id="totalQuantityValue">0</div>'),this.netTotal=this.cartDetails.find("#netTotal"),this.netTotal.append('<div id="netTotalTitle">Net Total</div>'),this.netTotal.append('<div id="netTotalValue">0.00</div>'),this.sales_taxes.length==0&&this.netTotal.css("display","none"),this.vat=this.cartDetails.find("#VAT"),this.sales_taxes.forEach(n=>{this.vat.append(`<div id="taxConatiner_${n.name}" class="rowBox align_center row_sbtw"></div>`);let a=this.vat.find(`#taxConatiner_${n.name}`);a.append(`<div id="tax_${n.name}_Title">${n.description}</div>`),a.append(`<div id="tax_${n.name}_Value">0.00</div>`)}),this.grandTotal=this.cartDetails.find("#grandTotal"),this.grandTotal.append('<div id="grandTotalTitle">Grand Total</div>'),this.grandTotal.append('<div id="grandTotalValue">0.00</div>'),this.settings_data.settings.showDiscountField||(this.setKeyboardOrientation("landscape"),this.discount.css("display","none")),this.editSelectedItem=this.cartFooter.find("#editSelectedItemCart"),this.editSelectedItem.css("display","flex"),this.editSelectedItem.append(`<div class="grid-container"  style="${e}">`),this.buttonsContainer=this.editSelectedItem.find(".grid-container"),this.buttonsContainer.append(`<button id="key_1"        class="grid-item"  style="${s}" data-action="1"        > 1         </button>`),this.buttonsContainer.append(`<button id="key_2"        class="grid-item"  style="${s}" data-action="2"        > 2         </button>`),this.buttonsContainer.append(`<button id="key_3"        class="grid-item"  style="${s}" data-action="3"        > 3         </button>`),this.buttonsContainer.append(`<button id="key_quantity" class="grid-item"  style="${s}" data-action="Quantity" > Quantit\xE9  </button>`),this.buttonsContainer.append(`<button id="key_4"        class="grid-item"  style="${s}" data-action="4"        > 4         </button>`),this.buttonsContainer.append(`<button id="key_5"        class="grid-item"  style="${s}" data-action="5"        > 5         </button>`),this.buttonsContainer.append(`<button id="key_6"        class="grid-item"  style="${s}" data-action="6"        > 6         </button>`),this.buttonsContainer.append(`<button id="key_rate"     class="grid-item"  style="${s}" data-action="Rate"     > Prix      </button>`),this.buttonsContainer.append(`<button id="key_7"        class="grid-item"  style="${s}" data-action="7"        > 7         </button>`),this.buttonsContainer.append(`<button id="key_8"        class="grid-item"  style="${s}" data-action="8"        > 8         </button>`),this.buttonsContainer.append(`<button id="key_9"        class="grid-item"  style="${s}" data-action="9"        > 9         </button>`),this.buttonsContainer.append(`<button id="key_minus"    class="grid-item"  style="${s}" data-action="-"        > -         </button>`),this.buttonsContainer.append(`<button id="key_point"    class="grid-item"  style="${s}" data-action="."        > .         </button>`),this.buttonsContainer.append(`<button id="key_0"        class="grid-item"  style="${s}" data-action="0"        > 0         </button>`),this.buttonsContainer.append(`<button id="key_delete"   class="grid-item"  style="${s}" data-action="Delete"   > Supprimer </button>`),this.buttonsContainer.append(`<button id="key_remove"   class="grid-item"  style="${s}color:red;font-weight:700;" data-action="Remove">Retirer</button>`),this.mainBtnContainer=this.cartFooter.find("#mainBtnContainer"),this.mainBtnContainer.append('<button type="button" id="checkoutBtn" style="width:50%;height:100%;background:none;border:none;border-right:2px solid #663959;color:white;"> Payment </button>'),this.mainBtnContainer.append('<button type="button" id="printBtn"    style="width:50%;height:100%;background:#E1472B;border:none;border-left:2px solid #2D6B61;color:white;"> Print </button>'),this.mainBtnContainer.find("#checkoutBtn").on("mousedown",n=>{this.on_checkout_click()}),this.mainBtnContainer.find("#printBtn").on("mousedown",n=>{console.log("1..the map : ",structuredClone(this.selected_item_maps.get(this.selected_tab.tabName))),this.on_key_pressed("print",null),console.log("2..the map : ",structuredClone(this.selected_item_maps.get(this.selected_tab.tabName)))})}fulfillingSelects(){this.price_lists.forEach(t=>{this.priceListInput.append(`<option value="${t.name}">${t.price_list_name}</option>`)}),this.customer_list.forEach(t=>{this.customerInput.append(`<option value="${t.name}">${t.customer_name}</option>`)})}refreshTabs(){this.tabs_container.empty();for(let t of this.selected_item_maps.keys())t==this.selected_tab.tabName?this.tabs_container.append(`<div class="tab selected rowBox align_center"><div class="tabName">${t}</div>  <img src="/assets/pos_ar/images/cancel.png" width="10px" height="10px"  class="tabDeleteBtn"  >  </div>`):this.tabs_container.append(`<div class="tab">  <div class="tabName">${t}</div>  </div>`);this.tabs_container.find(".tab").on("click",t=>{let e=$(t.target).closest(".tab").find(".tabName").text();this.selected_tab.tabName=e,this.refreshTabs(),this.refreshSelectedItem(),this.on_tab_click(e)}),this.tabs_container.find(".tabDeleteBtn").on("click",t=>{t.stopPropagation();let e=$(t.target).closest(".tab").find(".tabName").text(),s=this.selected_item_maps.get(e).items;s&&s.length>0?frappe.confirm("Are you sure you want to proceed?",()=>{console.log("see here : ",this.selected_item_maps.get(e)),this.db.deletePosInvoice(this.selected_item_maps.get(e).name),this.selected_item_maps.delete(e),this.selected_item_maps.size>0?(this.selected_tab.tabName=Array.from(this.selected_item_maps.keys())[0],console.log("this.selected_tab.tabName : ",this.selected_tab)):this.createNewTab(),this.refreshTabs(),this.refreshSelectedItem()},()=>{}):(this.selected_item_maps.delete(e),this.selected_item_maps.size>0?this.selected_tab.tabName=Array.from(this.selected_item_maps.keys())[0]:this.createNewTab(),this.refreshTabs(),this.refreshSelectedItem())})}refreshSelectedItem(){this.priceListInput.val(this.selected_item_maps.get(this.selected_tab.tabName).priceList),this.customerInput.val(this.selected_item_maps.get(this.selected_tab.tabName).customer);let t=document.getElementById("selectedItemsContainer");t.innerHTML="",this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(e=>{let s=document.createElement("div"),i=document.createElement("div"),n=document.createElement("div"),a=document.createElement("h5"),o=document.createElement("div"),r=document.createElement("div");if(this.settings_data.settings.showItemImage)if(e.image){let c=document.createElement("img");c.src=e.image,c.classList.add("selectedItemImage"),i.appendChild(c)}else{let c=document.createElement("div"),l=document.createElement("div");c.classList.add("selectedItemImage","rowBox","centerItem"),l.textContent=e.name[0],c.appendChild(l),i.appendChild(c)}a.textContent=e.item_name,a.classList.add("selectedItemName"),i.appendChild(a),o.textContent=e.qty,o.classList.add("itemQuantity"),o.style.fontSize="18px",o.style.fontWeight="600",n.appendChild(o),r.textContent=e.rate-e.discount_amount+" DA",r.classList.add("itemPrice"),r.style.fontSize="18px",r.style.fontWeight="600",r.style.width="90px",r.style.display="flex",r.style.flexDirection="row-reverse",n.appendChild(r),i.classList.add("rowBox","align_center","leftGroup"),s.appendChild(i),n.classList.add("rowBox","align_center","rightGroup"),s.appendChild(n),s.classList.add("rowBox","align_center","row_sbtw","ItemElement","pointer"),e.name==this.selected_item.name&&s.classList.add("selected"),s.addEventListener("click",c=>{this.makeItemHighlight(s),this.on_selected_item_click(e)}),t.appendChild(s)}),this.calculateNetTotal(),this.calculateVAT(),this.calculateQnatity(),this.calculateGrandTotal()}scrollToBottom(){console.log("scrolling"),this.selectedItemContainer.scrollTop(this.selectedItemContainer[0].scrollHeight)}createNewTab(){this.counter+=1,this.create_new_tab(this.counter),this.refreshTabs(),this.refreshSelectedItem()}restorePos(t){this.counter+=1,this.create_new_tab(this.counter),this.refreshTabs(),this.refreshSelectedItem()}createTabForEditPOS(){return this.counter+=1,this.counter}showKeyboard(){this.editSelectedItem.css("display","flex")}hideKeyboard(){this.editSelectedItem.css("display","none")}setKeyboardOrientation(t){let e=this.cartDetails.find("#discount"),s=this.cartDetails.find("#totalQuantity"),i=this.cartDetails.find("#netTotal"),n=this.cartDetails.find("#grandTotal");t=="landscape"?(this.cartDetails.css("display","flex"),this.cartDetails.addClass("rowBox align_center"),this.cartDetails.removeClass("columnBox"),e.css("display","none"),this.vat.css("display","none"),s.css("font-size","smaller"),i.css("font-size","smaller"),n.css("font-size","small"),n.css("font-weight","500")):(this.cartDetails.addClass("columnBox"),this.cartDetails.removeClass("rowBox"),this.settings_data.settings.showDiscountField&&e.css("display","flex"),this.vat.css("display","flex"),s.css("font-size","small"),i.css("font-size","small"),n.css("font-size","larger"),n.css("font-weight","700"))}makeSelectedButtonHighlighted(){let t=this.buttonsContainer.find("#key_quantity"),e=this.buttonsContainer.find("#key_rate"),s=this.buttonsContainer.find("#key_minus");this.selected_field.field_name=="quantity"?(t.addClass("selected"),e.removeClass("selected"),s.removeClass("selected")):this.selected_field.field_name=="rate"?(t.removeClass("selected"),e.addClass("selected"),s.removeClass("selected")):this.selected_field.field_name=="discount_percentage"?(t.removeClass("selected"),e.removeClass("selected"),s.addClass("selected")):(t.removeClass("selected"),e.removeClass("selected"),s.removeClass("selected"))}hideCart(){this.tabs_bar.css("display","none"),this.cartBox.css("display","none")}showCart(){this.tabs_bar.css("display","flex"),this.cartBox.css("display","flex")}setButtonsListeners(){let t=this.buttonsContainer.find("#key_0"),e=this.buttonsContainer.find("#key_1"),s=this.buttonsContainer.find("#key_2"),i=this.buttonsContainer.find("#key_3"),n=this.buttonsContainer.find("#key_4"),a=this.buttonsContainer.find("#key_5"),o=this.buttonsContainer.find("#key_6"),r=this.buttonsContainer.find("#key_7"),c=this.buttonsContainer.find("#key_8"),l=this.buttonsContainer.find("#key_9"),d=this.buttonsContainer.find("#key_quantity"),p=this.buttonsContainer.find("#key_minus"),h=this.buttonsContainer.find("#key_rate"),m=this.buttonsContainer.find("#key_remove"),f=this.buttonsContainer.find("#key_delete"),g=this.buttonsContainer.find("#key_point");[t,e,s,i,n,a,o,r,c,l,d,p,h,m,f,g].forEach(v=>{v.on("mousedown",b=>{b.preventDefault();let u=v.data("action");isNaN(u)?u=="."?this.on_key_pressed("addToField",u):u=="Quantity"?this.on_key_pressed("quantity",null):u=="Rate"?this.on_key_pressed("rate",null):u=="-"?this.on_key_pressed("minus",null):u=="Remove"?this.on_key_pressed("remove",null):u=="Delete"&&this.on_key_pressed("delete",null):this.on_key_pressed("addToField",u)})})}setListener(){this.add_tab_button.on("mousedown",t=>{this.createNewTab()}),this.discountInput.on("input",t=>{if(t.target.value==""){this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage=0;return}else if(t.target.value>100){this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage=100;return}this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage=parseFloat(t.target.value),this.calculateNetTotal(),this.calculateVAT(),this.calculateGrandTotal()}),this.discountInput.on("blur",t=>{t.target.value==""?t.target.value=0:t.target.value>100&&(t.target.value=100),this.calculateNetTotal(),this.calculateVAT(),this.calculateGrandTotal()}),this.priceListInput.on("input",t=>{this.selected_item_maps.get(this.selected_tab.tabName).priceList=t.target.value,this.resetItemRateBaseOnPriceList(),this.refreshSelectedItem(),this.save_pos_invoice()}),this.customerInput.on("input",t=>{this.selected_item_maps.get(this.selected_tab.tabName).customer=t.target.value;let e=this.getCustomerDefaultPriceList(t.target.value);e==""||e==null||e==null||(this.priceListInput.val(e),this.selected_item_maps.get(this.selected_tab.tabName).priceList=e),this.resetItemRateBaseOnPriceList(),this.refreshSelectedItem(),this.save_pos_invoice()})}getCustomerDefaultPriceList(t){let e="";return this.customer_list.forEach(s=>{s.name==t&&(e=s.default_price_list)}),e}calculateNetTotal(){let t=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(s=>{t+=s.rate*s.qty}),this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage>0&&(t-=t*(this.selected_item_maps.get(this.selected_tab.tabName).additional_discount_percentage/100));let e=document.getElementById("netTotalValue");e.textContent=t,this.invoice_data.netTotal=t}calculateVAT(){this.sales_taxes.forEach(t=>{let e=0,s=t.rate/100,i=(this.invoice_data.netTotal*s).toFixed(2);this.taxes_map.set(t.name,i);let n=document.getElementById(`tax_${t.name}_Value`);n.textContent=this.taxes_map.get(t.name)})}calculateTotalTaxAmount(){let t=0;return this.taxes_map.forEach(e=>{t+=e}),t}calculateQnatity(){let t=0;this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(s=>{t+=s.qty});let e=document.getElementById("totalQuantityValue");e.textContent=t}calculateGrandTotal(){let t=0,e=this.invoice_data.netTotal,s=0;this.taxes_map.forEach(n=>{s+=parseFloat(n)}),t=e+s;let i=document.getElementById("grandTotalValue");i.textContent=t.toFixed(2),this.invoice_data.grandTotal=t}resetItemRateBaseOnPriceList(){this.selected_item_maps.get(this.selected_tab.tabName).items.forEach(t=>{t.rate=this.get_item_price(t,this.selected_item_maps.get(this.selected_tab.tabName).priceList),t.discount_percentage=0,t.discount_amount=0})}makeItemHighlight(t){document.getElementById("selectedItemsContainer").querySelectorAll(".selected").forEach(i=>{i.classList.remove("selected")}),t.classList.add("selected")}cleanHeighlight(){document.getElementById("selectedItemsContainer").querySelectorAll(".selected").forEach(s=>{s.classList.remove("selected")})}};pos_ar.PointOfSale.pos_item_details=class{constructor(t,e,s,i,n,a,o,r,c){this.wrapper=t,this.warehouse=e,this.price_lists=s,this.item_prices=i,this.selected_item=a,this.selected_field=o,this.on_input=r,this.on_close_cart=c,this.bin_list=n,this.start_the_work()}start_the_work(){this.prepare_item_details_cart(),this.setDetailsFieldsListeners()}prepare_item_details_cart(){this.wrapper.append('<div id="itemDetailsCart" class="columnBox align_center"><div>'),this.item_details_cart=this.wrapper.find("#itemDetailsCart"),this.item_details_cart.append('<div id="itemDetailsCartHeader" class="rowBox header align_center row_sbtw"></div>'),this.cart_header=this.item_details_cart.find("#itemDetailsCartHeader"),this.cart_header.append('<h4 class="CartTitle">Item Details</h4>'),this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="itemDetailsCartXBtn" class="xBtn">'),this.close_btn=this.cart_header.find("#itemDetailsCartXBtn").on("click",t=>{this.on_close_cart()}),this.item_details_cart.append('<div id="itemDetailsHeader" class="rowBox"></div>'),this.header_details=this.item_details_cart.find("#itemDetailsHeader"),this.header_details.append('<div id="detailsItemImage" class="rowBox centerItem"></div>'),this.header_details.append('<div id="price_and_name" class="columnBox"></div>'),this.price_and_name_details=this.header_details.find("#price_and_name"),this.price_and_name_details.append('<div id="detailsItemName" class="rowBox align_center"></div>'),this.price_and_name_details.append('<div id="detailsItemGroupWarhouseContainer" class="rowBox align_center row_sa"></divr>'),this.item_group_warehouse_details=this.price_and_name_details.find("#detailsItemGroupWarhouseContainer"),this.item_group_warehouse_details.append('<div id="detailsItemGroup" class="rowBox align_center">Group : ...</div>'),this.item_group_warehouse_details.append('<div id="detailsItemWarehouse" class="rowBox align_center">Warehouse : ...</div>'),this.item_details_cart.append('<div id="itemDetailsAll"  class="rowBox"></div>'),this.details_all=this.item_details_cart.find("#itemDetailsAll"),this.details_all.append('<div id="itemDetails_C1" class="columnBox"></div>'),this.c1=this.details_all.find("#itemDetails_C1"),this.c1.append('<div class="columnBox"><label for="itemDetailsQuantityInput">Quantity</label><input type="float" id="itemDetailsQuantityInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsRateInput">Rate</label><input type="float" id="itemDetailsRateInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsDiscountInput">Discount (%)</label><input type="float" id="itemDetailsDiscountInput" class="pointerCursor"></div>'),this.c1.append('<div class="columnBox"><label for="itemDetailsAvailableInput">Available Qty at Warehouse</label><input type="float" id="itemDetailsAvailableInput" disabled></div>'),this.details_all.append('<div id="itemDetails_C2" class="columnBox"></div>'),this.c2=this.details_all.find("#itemDetails_C2"),this.c2.append('<div class="columnBox"><label for="itemDetailsUomInput">UOM *</label><input type="text" id="itemDetailsUomInput"  disabled></div>'),this.c2.append('<div class="columnBox"><label for="detailsRateWithDescount">Discounted Rate</label>  <input type="text" id="discountedRateInput" disabled>  </div>'),this.c2.append('<div class="columnBox hideMe"><label for="detailsPriceList">Price List *</label><input list="detailsPriceList" id="detailsItemPriceListInput" class ="rowBox align_center pointerCursor"><datalist id="detailsPriceList"><option>fetching Price Lists ...</option></datalist></div>'),this.c2.append('<div class="columnBox"><label for="itemDetailsDiscountMontantInput">Discount (montant)</label><input type="float" id="itemDetailsDiscountMontantInput" class="pointerCursor"></div>'),this.c2.append('<div class="columnBox"><label for="itemDetailsPriceListRateInput">Price List Rate</label><input type="text" id="itemDetailsPriceListRateInput" disabled></div>')}refreshDate(t){var f,g;let e=document.getElementById("detailsItemImage"),s=document.getElementById("detailsItemName"),i=document.getElementById("detailsItemWarehouse"),n=document.getElementById("detailsItemGroup"),a=document.getElementById("itemDetailsQuantityInput"),o=document.getElementById("itemDetailsRateInput"),r=document.getElementById("discountedRateInput"),c=document.getElementById("itemDetailsDiscountInput"),l=document.getElementById("itemDetailsDiscountMontantInput"),d=document.getElementById("itemDetailsAvailableInput"),p=document.getElementById("itemDetailsUomInput"),h=document.getElementById("detailsItemPriceListInput"),m=document.getElementById("itemDetailsPriceListRateInput");if(t.image){let _=document.createElement("img");_.src=t.image,e.innerHTML="",e.appendChild(_)}else{let _=document.createElement("div");_.textContent=t.item_name[0],_.style.fontSize="xx-large",_.style.fontWeight="700",e.innerHTML="",e.appendChild(_)}s.textContent=t.item_name,s.classList.add("rowBox","align_center"),a.value=t.qty,o.value=t.rate,r.value=t.rate-t.discount_amount,l.value=(f=t.discount_amount)!=null?f:0,c.value=(g=t.discount_percentage)!=null?g:0,d.value=this.getQtyInWarehouse(t.name,this.warehouse),p.value=t.stock_uom,h.value=this.price_lists[0].price_list_name,i.textContent="Warehouse : "+this.warehouse,n.textContent="Item Group : "+t.item_group,m.value=this.getItemPrice(t.name)+"DA",console.log("end ref"),this.makeSelectedFieldHighlighted()}show_cart(){this.item_details_cart.css("display","flex")}hide_cart(){this.item_details_cart.css("display","none")}makeSelectedFieldHighlighted(){this.selected_field.field_name=="quantity"?(this.c1.find("#itemDetailsQuantityInput").addClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected")):this.selected_field.field_name=="rate"?(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").addClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected")):this.selected_field.field_name=="discount_percentage"?(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").addClass("selected")):(this.c1.find("#itemDetailsQuantityInput").removeClass("selected"),this.c1.find("#itemDetailsRateInput").removeClass("selected"),this.c1.find("#itemDetailsDiscountInput").removeClass("selected"))}requestFocus(t){t=="quantity"?this.c1.find("#itemDetailsQuantityInput").focus():t=="rate"?this.c1.find("#itemDetailsRateInput").focus():t=="discount_percentage"?this.c1.find("#itemDetailsDiscountInput").focus():t=="discount_amount"&&this.c1.find("#itemDetailsDiscountMontantInput").focus()}addToField(t,e){console.log("field : ",t,"value : ",e),t=="quantity"?this.c1.find("#itemDetailsQuantityInput").val((s,i)=>e=="."&&i.includes(".")?i:i+e):t=="rate"?this.c1.find("#itemDetailsRateInput").val((s,i)=>e=="."&&i.includes(".")?i:i+e):t=="discount_percentage"?this.c1.find("#itemDetailsDiscountInput").val((s,i)=>e=="."&&i.includes(".")?i:i+e):t=="discount_amount"&&this.c1.find("#itemDetailsDiscountInput").val((s,i)=>e=="."&&i.includes(".")?i:i+e)}deleteCharacter(){let t=this.selected_field.field_name,e=0;if(t=="quantity"){let s=this.c1.find("#itemDetailsQuantityInput"),i=s[0].selectionStart;s.val((n,a)=>a.length<0||a.length==1?(e=0,0):i==0?(e=a,a):i==a.length?(e=a.slice(0,i-1),a.slice(0,i-1)):(e=a.slice(0,i-1)+a.slice(i),a.slice(0,i-1)+a.slice(i))),setTimeout(()=>{s[0].setSelectionRange(i-1,i-1),s[0].focus()},0)}if(t=="rate"){let s=this.c1.find("#itemDetailsRateInput"),i=s[0].selectionStart;s.val((n,a)=>a.length<0||a.length==1?(e=0,0):i==0?(e=a,a):i==a.length?(e=a.slice(0,i-1),a.slice(0,i-1)):(e=a.slice(0,i-1)+a.slice(i),a.slice(0,i-1)+a.slice(i))),setTimeout(()=>{s[0].setSelectionRange(i-1,i-1),s[0].focus()},0)}if(t=="discount_percentage"){let s=this.c1.find("#itemDetailsDiscountInput"),i=s[0].selectionStart;s.val((n,a)=>a.length<0||a.length==1?(e=0,0):i==0?(e=a,a):i==a.length?(e=a.slice(0,i-1),a.slice(0,i-1)):(e=a.slice(0,i-1)+a.slice(i),a.slice(0,i-1)+a.slice(i))),setTimeout(()=>{s[0].setSelectionRange(i-1,i-1),s[0].focus()},0)}return console.log("we reach to here "),e}setDetailsFieldsListeners(){this.quantityInput=this.c1.find("#itemDetailsQuantityInput"),this.rateInput=this.c1.find("#itemDetailsRateInput"),this.discountInput=this.c1.find("#itemDetailsDiscountInput"),this.discountMontantInput=this.c2.find("#itemDetailsDiscountMontantInput"),this.quantityInput.on("input",t=>{let e=t.target.value;e.length==0?t.target.value=0:!e.slice(0,-1).includes(".")&&e[e.length-1]=="."?t.target.value=e:e[e.length-1]=="."||e[e.length-1]==" "||isNaN(e[e.length-1])?t.target.value=e.slice(0,-1):t.target.value=e;let s=parseFloat(this.quantityInput.val());if(isNaN(s)){console.warn("Invaide Quantity value =>",this.quantityInput.val());return}else s<=0&&(s=0);this.on_input("input","quantity",s)}),this.quantityInput.on("focus",t=>{this.on_input("focus","quantity",null)}),this.quantityInput.on("blur",t=>{this.on_input("blur","quantity",null)}),this.rateInput.on("input",t=>{let e=t.target.value;e.length==0?t.target.value=0:!e.slice(0,-1).includes(".")&&e[e.length-1]=="."?t.target.value=e:e[e.length-1]=="."||isNaN(e[e.length-1])?t.target.value=e.slice(0,-1):t.target.value=e;let s=parseFloat(this.rateInput.val());if(console.log("new rate : ",s),isNaN(s)){console.warn("Invalide Rate value");return}this.on_input("input","rate",s)}),this.rateInput.on("focus",t=>{this.on_input("focus","rate",null)}),this.rateInput.on("blur",t=>{this.on_input("blur","rate",null)}),this.discountInput.on("input",t=>{let e=t.target.value;e.length==0?t.target.value=0:!e.slice(0,-1).includes(".")&&e[e.length-1]=="."?t.target.value=e:e[e.length-1]=="."||isNaN(e[e.length-1])?t.target.value=e.slice(0,-1):t.target.value=e;let s=this.discountInput.val();if(console.log("the new value ",s),isNaN(s)){console.warn("Invalide discount value");return}s<100?this.on_input("input","discount_percentage",s):(t.target.value=100,this.on_input("input","discount_percentage",100))}),this.discountInput.on("focus",t=>{this.on_input("focus","discount_percentage",null)}),this.discountInput.on("blur",t=>{this.on_input("blur","discount_percentage",null)}),this.discountMontantInput.on("input",t=>{let e=t.target.value;e.length==0?t.target.value=0:!e.slice(0,-1).includes(".")&&e[e.length-1]=="."?t.target.value=e:e[e.length-1]=="."||isNaN(e[e.length-1])?t.target.value=e.slice(0,-1):t.target.value=e;let s=this.discountMontantInput.val();if(isNaN(s)){console.warn("Invalide discount value");return}this.on_input("input","discount_amount",s)}),this.discountMontantInput.on("focus",t=>{console.log("we are here"),this.on_input("focus","discount_amount",null)}),this.discountMontantInput.on("blur",t=>{this.on_input("blur","discount_amount",null)})}getItemPrice(t){let e=this.item_prices.find(s=>s.item_code==t);return e?e.price_list_rate:0}getQtyInWarehouse(t,e){let s=this.bin_list.find(i=>i.item_code==t&&i.warehouse==e);return s?s.actual_qty:0}};pos_ar.PointOfSale.pos_payment_cart=class{constructor(t,e,s,i,n,a,o,r,c,l){this.wrapper=t,this.selected_item_map=e,this.selected_tab=s,this.app_data=i,this.payment_methods=n,this.selected_payment_method=a,this.invoice_data=o,this.on_close_cart=r,this.on_complete=c,this.on_input=l,this._payment_method=this.payment_methods[0],this.start_work()}start_work(){this.prepare_payment_cart(),this.calculateGrandTotal(),this.setListeners()}prepare_payment_cart(){this.wrapper.append('<div id="paymentMethodCart" class="columnBox align_center"></div>'),this.paymentCart=this.wrapper.find("#paymentMethodCart"),this.paymentCart.append('<script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"><\/script><div id="payment_waitingContainer" style="position:absolute;background:#00000050;top:0;left:0;inset: 0;display:none;backdrop-filter: blur(2px);z-index: 10;" class="rowBox centerItem" ><dotlottie-player src="https://lottie.host/d6c76206-aab9-4d5a-af73-c4a6cfc5aaa9/H8vnpKcKj9.lottie" background="transparent" speed="1" style="width: 300px; height: 300px" loop autoplay></dotlottie-player></div>'),this.waiting_cart=this.wrapper.find("#payment_waitingContainer"),this.cart=this.wrapper.find("#paymentMethodCart"),this.cart.append('<div id="paymentMethodCartHeader" class="rowBox header align_center row_sbtw"></div>'),this.cart.append('<div id="paymentMethodContent" class="columnBox align_center"></div>'),this.cart.append('<div id="paymentMethodCartFooter" class="columnBox align_center"></div>'),this.cart_header=this.cart.find("#paymentMethodCartHeader"),this.cart_content=this.cart.find("#paymentMethodContent"),this.cart_footer=this.cart.find("#paymentMethodCartFooter"),this.cart_header.append('<h4 class="CartTitle">Item Details</h4>'),this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="paymentMethodCartXBtn" class="xBtn">'),this.cart_header.find("#paymentMethodCartXBtn").on("click",t=>{this.on_close_cart()}),this.cart_content.append('<div id="paymentContentTopSection" class="rowBox"></div>'),this.cart_content.append('<div id="paymentContentBottomSection" class="columnBox"></div>'),this.cart_content_top_section=this.cart_content.find("#paymentContentTopSection"),this.cart_content_bottom_section=this.cart_content.find("#paymentContentBottomSection"),this.payment_methods.forEach(t=>{let e=this._payment_method.name==t.name?"selected":"",s=this.getModeOfPaymentById(t.mode_of_payment).type=="Phone"?"display:none;":"";this.cart_content_top_section.append(`<div id="${t.name}" class="paymentMethodBox ${e}"><div id="BoxTitle" class="title ${e}">${t.mode_of_payment}</div><input type="number" id="cachInput" class="paymentInput" value="0" style="${s}"  ></div>`)}),this.cart_content_bottom_section.append("<h4>Additional Information</h4>"),this.cart_footer.append('<div id="paymentDetailsContainer" class="rowBox align_center"></div>'),this.cart_footer.append('<button class="posBtn1" type="button" id="completeOrderBtn">Complete Order</button>'),this.payment_details=this.cart_footer.find("#paymentDetailsContainer"),this.payment_details.append('<div class="columnBox"><div id="paymentGrandTotalTitle" class="rowBox centerItem">Grand Total</div><div id="paymentGrandTotalValue" class="rowBox centerItem"></div></div>'),this.payment_details.append("<hr>"),this.payment_details.append('<div id="paymentPaidAmount" class="columnBox"><div id="paymentPaidAmountTitle" class="rowBox centerItem">Paid Amount</div><div id="paimentPaidAmountValue"  class="rowBox centerItem"> 0 DA </div></div>'),this.payment_details.append("<hr>"),this.payment_details.append(`<div id="paymentToChange" class="columnBox"><div id="paimentToChangeTitle" class="rowBox centerItem">To Change</div><div id="paimentToChangeValue"  class="rowBox centerItem"> ${this.calculateToChange()} DA </div></div>`)}preparDefault(){this.calculateGrandTotal(),this._payment_method=this.payment_methods[0],this.cart_content_top_section.find(".paymentMethodBox").removeClass("selected"),this.cart_content_top_section.find(`.paymentMethodBox#${this._payment_method.name}`).addClass("selected"),this.cart_content_top_section.find(".paymentMethodBox .title").removeClass("selected"),this.cart_content_top_section.find(`.paymentMethodBox#${this._payment_method.name} .title`).addClass("selected");let t=$(`#${this._payment_method.name}`);t.length&&(t.find(".paymentInput").val(this.invoice_data.grandTotal),this.selected_item_map.get(this.selected_tab.tabName).payments.forEach(e=>{e.mode_of_payment==this._payment_method.mode_of_payment&&(e.amount=this.invoice_data.grandTotal)}),this.updatePaidAmount(),this.updateToChange())}showCart(){this.cart.css("display","flex"),this.preparDefault()}hideCart(){this.cart.css("display","none")}show_waiting(){console.log("we are heeer display",this.waiting_cart),this.waiting_cart.css("display","flex")}hide_waiting(){console.log("we are heeer for hide"),this.waiting_cart.css("display","none")}setListeners(){let t=this;this.cart_content_top_section.on("click",".paymentMethodBox",function(){$(".paymentMethodBox").removeClass("selected"),$(".paymentMethodBox div.title").removeClass("selected"),$(this).addClass("selected"),$(this).find(".title").addClass("selected");let e=$(this).attr("id");t.payment_methods.forEach(s=>{s.name==e&&(t._payment_method=s)}),$(".paymentMethodBox").not(this).find(".paymentInput").val(0),$(this).find(".paymentInput").val(t.invoice_data.grandTotal),t.selected_item_map.get(t.selected_tab.tabName).payments.forEach(s=>{s.mode_of_payment!=t._payment_method.mode_of_payment||t.getModeOfPaymentById(s.mode_of_payment).type=="Phone"?s.amount=0:s.amount=t.invoice_data.grandTotal}),t.updatePaidAmount(),t.updateToChange()}),this.cart_content_top_section.on("input",".paymentInput",function(){let e=parseFloat($(this).val())||0,s=$(this).closest(".paymentMethodBox").attr("id");t.selected_item_map.get(t.selected_tab.tabName).payments.forEach(i=>{i.mode_of_payment==t._payment_method.mode_of_payment&&(i.amount=parseFloat(e))}),t.updatePaidAmount(),t.updateToChange()}),this.cart_footer.find("#completeOrderBtn").on("click",e=>{frappe.confirm("Submit the invoice ?",()=>{this.on_complete()},()=>{})})}handleInput(t){}deleteKeyPress(){let t=this.cashBox.find("#cachInput"),e=0,s=t[0].selectionStart;t.val((i,n)=>n.length<0?(console.log("cnd 1"),e=0,0):n.length==1?(console.log("cnd 2"),e=0,0):s==0?(console.log("cnd 3"),e=n,n):s==n.length?(console.log("cnd 4"),e=n.slice(0,s-1),n.slice(0,s-1)):(console.log("cursor : ",s," current val ==> ",n," cnd 5 newValue ==> ",n.slice(0,s-1)+n.slice(s)),e=n.slice(0,s-1)+n.slice(s),n.slice(0,s-1)+n.slice(s))),console.log("we are in newValue ==> ",e),this.invoice_data.paidAmount=e,setTimeout(()=>{t[0].setSelectionRange(s-1,s-1),t[0].focus()},0),this.refreshData()}calculatePaidAmount(){let t=0;return this.selected_item_map.get(this.selected_tab.tabName).payments.forEach(e=>{t+=e.amount}),t}updatePaidAmount(){this.payment_details.find("#paimentPaidAmountValue").text(`${this.calculatePaidAmount()} DA`)}calculateToChange(){return console.log("see why the error "," calculatePaidAmount ",this.calculatePaidAmount()," grandTotal ",this.invoice_data.grandTotal),this.calculatePaidAmount()-this.invoice_data.grandTotal}updateToChange(){this.payment_details.find("#paimentToChangeValue").text(`${this.calculateToChange().toFixed(2)} DA`)}calculateGrandTotal(){return this.payment_details.find("#paymentGrandTotalValue").text(`${this.invoice_data.grandTotal.toFixed(2)} DA`),parseFloat(this.invoice_data.grandTotal.toFixed(2))}getModeOfPaymentById(t){let e=null;return this.app_data.posProfileModeOfPayments.forEach(s=>{s.name==t&&(e=s)}),e}};pos_ar.PointOfSale.pos_history=class{constructor(t,e,s,i,n,a,o,r){this.wrapper=t,this.db=e,this.selected_pos_profile=s,this.app_data=i,this.app_settings=n,this.company=a,this.sales_taxes=o,this.on_click=r,this.localPosInvoice={lastTime:null,pos_invoices:[]},this.filter="",this.search_value="",this.filtered_pos_list=[],this.selected_pos=null,this.start_work()}async start_work(){this.prepare_history_cart();let t=await this.db.getAllPosInvoice();this.localPosInvoice.pos_invoices=t,this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(e=>e.status=="Unpaid"),console.log("log init data : ",this.filtered_pos_list),this.filtered_pos_list.length==0?this.selected_pos=null:this.selected_pos=structuredClone(this.filtered_pos_list[0]),this.refreshData(),this.setListener()}prepare_history_cart(){this.wrapper.find("#LeftSection").append('<div id="historyLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="historyRightContainer" class="columnBox"></div>'),this.left_container=this.wrapper.find("#historyLeftContainer"),this.right_container=this.wrapper.find("#historyRightContainer"),this.left_container.append('<div id="PosContentHeader" class="rowBox" ><div class="c1 columnBox"><div id="posCustomer">Customer</div><div id="posSoldBy"></div><div id="posStatus" class="Paid"></div></div><div class="c2 columnBox"><div id="posCost">0,0000 DA</div><div id="posId">ACC-PSINV-2024-ID</div><div id="posRealId">POS realI</div></div></div>'),this.pos_header=this.left_container.find("#PosContentHeader"),this.left_container.append('<div id="posContent" class="columnBox"></div>'),this.pos_content=this.left_container.find("#posContent"),this.pos_content.append('<div id="posItemContainer"><div class="posSectionTitle">Items</div><div id="posItemList"></div></div>'),this.itemContainer=this.pos_content.find("#posItemContainer"),this.itemList=this.itemContainer.find("#posItemList"),this.pos_content.append('<div id="posTotalsContainer"><div class="posSectionTitle">Totals</div><div id="posTotalList"></div></div>'),this.totalsContainer=this.pos_content.find("#posTotalsContainer"),this.totalList=this.pos_content.find("#posTotalList"),this.pos_content.append('<div id="posPaymentsContainer"><div class="posSectionTitle">Payments</div><div id="posMethodList"></div></div>'),this.paymentsContainer=this.pos_content.find("#posPaymentsContainer"),this.methodList=this.pos_content.find("#posMethodList"),this.left_container.append('<div id="posActionsContainer" class="rowBox align_content"  style="display = none ;" > <div id="posPrintBtn" class="actionBtn rowBox centerItem"> Print Receipt </div>  <div id="posDuplicateBtn" class="actionBtn rowBox centerItem"> Duplicate </div>   <div id="posReturnBtn" class="actionBtn rowBox centerItem"> Return </div>  </div>'),this.left_container.append('<div id="posDraftActionsContainer" class="rowBox align_content" style="display = none ;"> <div id="posEditBtn" class="actionBtn rowBox centerItem"> Edit Invoice </div>  <div id="posDeleteBtn" class="actionBtn rowBox centerItem"> Delete Invoice </div>  </div>'),this.actionButtonsContainer=this.left_container.find("#posActionsContainer"),this.printBtn=this.actionButtonsContainer.find("#posPrintBtn"),this.duplicateBtn=this.actionButtonsContainer.find("#posDuplicateBtn"),this.returnBtn=this.actionButtonsContainer.find("#posReturnBtn"),this.draftActionButtonsContainer=this.left_container.find("#posDraftActionsContainer"),this.deleteBtn=this.draftActionButtonsContainer.find("#posDeleteBtn"),this.editBtn=this.draftActionButtonsContainer.find("#posEditBtn"),this.right_container.append('<div id="historyRightContainerHeader" class="rowBox align_center" ><h4 class="CartTitle">Recent Orders</h4></div>'),this.right_container.append('<div id="historyRightSearchContainer" class="rowBox align_center" ></div>'),this.search_container=this.right_container.find("#historyRightSearchContainer"),this.search_container.append('<select  id="PosInvoiceTypeInput" placeholder="POS Invoice Type">'),this.filter_input=this.search_container.find("#PosInvoiceTypeInput"),this.filter_input.append('<option value="Draft">Draft</option><option value="Paid">Paid</option> <option value="Unpaid" selected>Unpaid</option>'),this.search_container.append('<input type="text" id="historyInput" placeholder="Search by invoice id or custumer name">'),this.search_field=this.search_container.find("#historyInput"),this.right_container.append('<div id="historyRecentInvoicesContainer" ></div>'),this.right_data_container=this.right_container.find("#historyRecentInvoicesContainer")}refreshData(){this.right_data_container.html(""),this.filtered_pos_list.forEach(t=>{let e=document.createElement("div");e.classList.add("posInvoiceContainer"),e.classList.add("columnBox"),e.classList.add("align_content");let s=document.createElement("div");s.classList.add("l1"),s.classList.add("rowBox"),s.classList.add("align_content");let i=document.createElement("div");i.classList.add("posName"),i.textContent=t.refNum;let n=document.createElement("div");if(n.classList.add("posCost"),n.textContent=t.paid_amount+" DA",s.appendChild(i),t.consolidated_invoice){let d=document.createElement("div");d.classList.add("consolidated-flag"),d.style.margin="0 8px 0 8px",d.innerHTML="Consolidated",s.appendChild(d)}s.appendChild(n);let a=document.createElement("div");a.classList.add("l2"),a.classList.add("rowBox"),a.classList.add("align_content");let o=document.createElement("div");o.classList.add("customer"),o.classList.add("rowBox"),o.classList.add("align_content");let r=document.createElement("img");r.src="/assets/pos_ar/images/customer.png",r.width=16,r.height=16,r.classList.add("customerLogo");let c=document.createElement("div");c.textContent=t.customer,c.classList.add("customerName"),o.appendChild(r),o.appendChild(c),a.appendChild(o);let l=document.createElement("div");l.textContent=t.creation_time,a.appendChild(l),e.appendChild(s),e.appendChild(a),e.addEventListener("click",()=>{console.log("click",t),this.selected_pos=t,this.refreshPosDetailsData()}),this.right_data_container.append(e)}),this.refreshPosDetailsData()}refreshPosDetailsData(){var s,i,n;if(this.selected_pos==null){this.setEmpty();return}else this.setData();this.pos_header.find("#posCustomer").text((s=this.selected_pos.customer)!=null?s:"CustomerName"),this.pos_header.find("#posCost").text(this.selected_pos.paid_amount+" DA"),this.pos_header.find("#posId").text((i=this.selected_pos.refNum)!=null?i:"POS Invoice CachId"),this.pos_header.find("#posRealId").text((n=this.selected_pos.real_name)!=null?n:""),this.pos_header.find("#posStatus").text(this.selected_pos.status),this.pos_header.find("#posStatus").removeClass().addClass(`${this.selected_pos.status}`),this.selected_pos.consolidated_invoice?(this.pos_header.find("#posConsolidated").length||this.pos_header.find(".c1").append('<div id="posConsolidated" class="consolidated-info"></div>'),this.pos_header.find("#posConsolidated").html(`
                <span class="consolidated-label">Consolidated:</span>
                <span class="consolidated-value">${this.selected_pos.consolidated_invoice}</span>
            `)):this.pos_header.find("#posConsolidated").remove(),this.selected_pos.status=="Draft"?(this.draftActionButtonsContainer.css("display","flex"),this.actionButtonsContainer.css("display","none")):(this.draftActionButtonsContainer.css("display","none"),this.actionButtonsContainer.css("display","flex")),this.itemList.html(""),this.selected_pos.items.forEach(a=>{this.itemList.append(`<div class="rowBox align_item">    <div class="itemName rowBox align_center">${a.item_name}</div>   <div class="itemQuantity rowBox align_center">${a.qty}</div>   <div class="itemCost rowBox align_center">${a.qty*a.rate} DA</div>  </div>`)}),this.totalList.html("");let t=0;if(this.selected_pos.items.forEach(a=>{t+=a.rate*a.qty}),this.selected_pos.taxes_and_charges==""||this.selected_pos.taxes_and_charges==null)this.totalList.append(`<div class="rowBox align_item"> <div class="grandTotalName rowBox align_center">Grand Total</div> <div class="grandTotalPrice rowBox align_center">${t} DA</div> </div>`);else{this.totalList.append(`<div class="rowBox align_item"> <div class="name rowBox align_center">Net Total</div> <div class="price rowBox align_center">${t} DA</div> </div>`);let a=0;this.selected_pos.taxes_and_charges!=""&&this.selected_pos.taxes_and_charges!=null&&this.sales_taxes.forEach(o=>{a+=o.rate/100*t,this.totalList.append(`<div class="rowBox align_item"> <div class="name rowBox align_center">${o.description}</div> <div class="price rowBox align_center">${o.rate/100*t} DA</div> </div>`)}),this.totalList.append(`<div class="rowBox align_item"> <div class="grandTotalName rowBox align_center">Grand Total</div> <div class="grandTotalPrice rowBox align_center">${t+a} DA</div> </div>`)}this.methodList.html("");let e=this.selected_pos.payments;e!=null&&e!=""&&e.forEach(a=>{this.methodList.append(`<div class="rowBox align_item"> <div class="name rowBox align_center">${a.mode_of_payment}</div> <div class="price rowBox align_center">${a.amount} DA</div> </div>`)})}show_cart(){this.left_container.css("display","flex"),this.right_container.css("display","flex");let t=this.filter_input.val();this.db.getAllPosInvoice_callback(e=>{this.localPosInvoice.pos_invoices=e,this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(s=>s.status==t),this.filtered_pos_list.length==0?this.selected_pos=null:this.selected_pos=this.filtered_pos_list[0],this.refreshData()},e=>{console.log(e)})}hide_cart(){this.left_container.css("display","none"),this.right_container.css("display","none")}setEmpty(){this.pos_header.css("display","none"),this.pos_content.css("display","none"),this.actionButtonsContainer.css("display","none"),this.draftActionButtonsContainer.css("display","none")}setData(){this.pos_header.css("display","flex"),this.pos_content.css("display","flex")}setListener(){this.filter_input.on("input",t=>{console.log("we are here1"),this.filterList(this.search_field.val(),this.filter_input.val())}),this.search_field.on("input",t=>{console.log("we are here2"),this.filterList(this.search_field.val(),this.filter_input.val())}),this.deleteBtn.on("click",t=>{this.db.deletePosInvoice_callback(this.selected_pos.name,e=>{this.filtered_pos_list=this.filtered_pos_list.filter(s=>s.name!=this.selected_pos.name),this.filtered_pos_list.length>0?this.selected_pos=this.filtered_pos_list[0]:this.selected_pos=null,this.refreshData()},e=>{console.log("error on deleting the pos : ",e)})}),this.editBtn.on("click",t=>{this.on_click("edit",this.selected_pos)}),this.returnBtn.on("click",t=>{console.log("returned invoice : ",this.selected_pos),this.on_click("return",this.selected_pos)}),this.printBtn.on("click",t=>{this.print_receipt(this.selected_pos)}),this.duplicateBtn.on("click",t=>{this.on_click("duplicate",this.selected_pos)})}filterList(t,e){console.log("log : ",this.filtered_pos_list),this.filtered_pos_list=this.localPosInvoice.pos_invoices.filter(s=>{let i=(s.customer||"").toLowerCase().includes(t.toLowerCase()),n=(s.refNum||"").toLowerCase().includes(t.toLowerCase()),a=(s.real_name||"").toLowerCase().includes(t.toLowerCase()),o=t=="";return s.status==e&&(i||n||a||o)}),this.filtered_pos_list.length==0?this.selected_pos=null:(this.selected_pos=this.filtered_pos_list[0],console.log("debuging invoice : ",this.selected_pos,"and : ",this.filtered_pos_list)),this.refreshData()}async print_receipt(t){let e=0,s=0,i=0;console.log("appData : ",this.app_data);let n=this.app_data.appData.customers.find(h=>h.name==t.customer),a=n.custom_debt;console.log("check the condition : ",this.app_settings.settings.onlineDebt),this.app_settings.settings.onlineDebt&&(a=await this.app_data.fetchCustomerDebt(n.name),console.log("the result id : ",a));let o=t.creation_time,[r,c]=o.split(" "),l=`<style>#company_container {width: 100% ; height: 40px ; display:flex; align-items:center; font-size : 12px;}table{width: 100%; margin-top:16px;}tr{width:100%; height:16px;}tr:nth-child(1){}#first_row{border: 5px solid black;}#logContainer{width: 100%;height:80px;display : flex;justify-content:center;}#logContainer img{width:50%; height:100%;}#top_data_container{width:100%;display:flex;}#top_data_container>div.c1{font-size:12px;flex-grow:1;}#top_data_container>div.c2{font-size:12px;flex-grow:1;display:flex;flex-direction:column;align-items:end;}td>div{height:18px; width:100%;font-size:12px;display:flex; justify-content:start; align-items:center;}#footer_message{height:20px;}</style><div style="display:flex; flex-direction:column;"><div id="logContainer"  ><div style="width:20%;"></div><img src="/assets/pos_ar/images/logo.jpg"  id="company_logo"><div style="width:20%;"></div></div><div id="company_container"><div style="flex-grow:1;"></div><p style="margin:0px 25px;">${this.company.company_name}</p><div style="flex-grow:1;"></div></div><div id="top_data_container"><div class="c1"><div class="customer" style="font-weight:600;font-size:18px;"> Customer : ${t.customer} </div><div class="refrence"> Commande : ${t.refNum} </div></div><div class="c2"><div class="date"> ${r}/${c} </div></div></div><table><tr id="first_row" ><th style="boder:1px solid black;">Nom</th><th>Qt\xE9</th><th>Prix</th><th>Value</th>`;t.items.forEach(h=>{e+=h.rate*h.qty,l+=`<tr > <td ><div >${h.item_name}</div></td>  <td><div>${h.qty}</div></td>  <td><div>${h.rate}</div></td>  <td><div>${h.rate*h.qty}</div></td></tr>`}),l+=`<tr style="height:23px;font-size:12px;font-weight:700;" > <td colspan="3" ><div >      </div></td>   <td><div> ${e+e*(s/100)-t.additional_discount_percentage*e} DA </div></td></tr>`,l+=`<tr style="height:23px;font-size:12px;font-weight:700;" > <td colspan="3" ><div >Ancien Sold        </div></td>   <td><div> ${a} DA </div></td></tr>`,l+="</table>",l+='<div id="footer_message" style="width:100%; display:flex; align-items:center; margin-top:30px;"><div style="flex-grow:1;"></div><div style="margin:30px 25px;"> Thank You, Come Again</div><div style="flex-grow:1;"></div></div>',l+="</div>";let d=window.open("","_blank");d.document.write(l),d.document.close();let p=d.document.getElementById("company_logo");p.onload=()=>{d.focus(),d.print(),d.close()},console.log("check the poooooooooooooooooooooos : ",t)}};pos_ar.PointOfSale.pos_db=class{constructor(e){this.db=e,this.setupDatabase()}static async openDatabase(){return new Promise((e,s)=>{let i=window.indexedDB.open("POSDB_test33",8);i.onerror=n=>{s(i.error)},i.onsuccess=n=>{e(new pos_ar.PointOfSale.pos_db(n.target.result))},i.onupgradeneeded=n=>{let a=n.target.result,o,r;a.objectStoreNames.contains("Customer")||a.createObjectStore("Customer",{keyPath:"name"}),a.objectStoreNames.contains("Item Group")||a.createObjectStore("Item Group",{keyPath:"name"}),a.objectStoreNames.contains("Item")||a.createObjectStore("Item",{keyPath:"name"}),a.objectStoreNames.contains("Item Price")||a.createObjectStore("Item Price",{keyPath:"name"}),a.objectStoreNames.contains("Price List")||a.createObjectStore("Price List",{keyPath:"name"}),a.objectStoreNames.contains("Warehouse")||a.createObjectStore("Warehouse",{keyPath:"name"}),a.objectStoreNames.contains("POS Profile")||a.createObjectStore("POS Profile",{keyPath:"name"}),a.objectStoreNames.contains("Bin")||a.createObjectStore("Bin",{keyPath:"name"}),a.objectStoreNames.contains("POS Invoice")?o=n.target.transaction.objectStore("POS Invoice"):o=a.createObjectStore("POS Invoice",{keyPath:"name"}),o.indexNames.contains("docstatus")||o.createIndex("docstatus","docstatus",{unique:!1}),o.indexNames.contains("opened")||o.createIndex("opened","opened",{unique:!1}),o.indexNames.contains("creation_time")||o.createIndex("creation_time","creation_time",{unique:!1}),a.objectStoreNames.contains("check_in_out")?r=n.target.transaction.objectStore("check_in_out"):r=a.createObjectStore("check_in_out",{keyPath:"name"}),r.indexNames.contains("creation_time")||r.createIndex("creation_time","creation_time",{unique:!1}),a.objectStoreNames.contains("POS Settings")||a.createObjectStore("POS Settings",{keyPath:"id"})}})}setupDatabase(){this.db.onerror=e=>{var s;console.error(`Database error: ${(s=e.target.error)==null?void 0:s.message}`)}}getPosCounter(){return new Promise((e,s)=>{let n=this.db.transaction(["Counter"],"readwrite").objectStore("Counter")})}saveItemList(e){return new Promise((s,i)=>{let n=this.db.transaction(["Item"],"readwrite"),a=n.objectStore("Item");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving Item : ",o,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving Item."),i(o)}})}getAllItems(){return new Promise((e,s)=>{let a=this.db.transaction(["Item"],"readwrite").objectStore("Item").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{s(o)}})}savePosProfileList(e){return new Promise((s,i)=>{let n=this.db.transaction(["POS Profile"],"readwrite"),a=n.objectStore("POS Profile");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving POS Profile : ",o,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving POS Profile."),i(o)}})}getAllPosProfile(){return new Promise((e,s)=>{let a=this.db.transaction(["POS Profile"],"readwrite").objectStore("POS Profile").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{let r=event.target.result;s(r)}})}saveBinList(e){return new Promise((s,i)=>{let n=this.db.transaction(["Bin"],"readwrite"),a=n.objectStore("Bin");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving Bin : ",o,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving Bin."),i(o)}})}getAllBin(){return new Promise((e,s)=>{let a=this.db.transaction(["Bin"],"readwrite").objectStore("Bin").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{s(o)}})}saveWarehouseList(e){return new Promise((s,i)=>{let n=this.db.transaction(["Warehouse"],"readwrite"),a=n.objectStore("Warehouse");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving Warehouse : ",o,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving Warehouse List."),i(o)}})}getAllWarehouse(){return new Promise((e,s)=>{let a=this.db.transaction(["Warehouse"],"readwrite").objectStore("Warehouse").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{s(o)}})}savePriceLists(e){return new Promise((s,i)=>{let n=this.db.transaction(["Price List"],"readwrite"),a=n.objectStore("Price List");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving Price List : ",itemPrice,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving Price Lists."),i(o)}})}getAllPriceList(){return new Promise((e,s)=>{let a=this.db.transaction(["Price List"],"readwrite").objectStore("Price List").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{s(o)}})}saveItemPriceList(e){return new Promise((s,i)=>{let n=this.db.transaction(["Item Price"],"readwrite"),a=n.objectStore("Item Price");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving Item Price : ",o,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving Item Price."),i(o)}})}getAllItemPrice(){return new Promise((e,s)=>{let a=this.db.transaction(["Item Price"],"readwrite").objectStore("Item Price").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{s(o)}})}saveItemGroupList(e){return new Promise((s,i)=>{let n=this.db.transaction(["Item Group"],"readwrite"),a=n.objectStore("Item Group");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{i(c),console.error("db => error saving Item Group : ",o,"err : ",c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving Item Group."),i(o)}})}getAllItemGroup(){return new Promise((e,s)=>{let a=this.db.transaction(["Item Group"],"readwrite").objectStore("Item Group").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{s(o)}})}saveCustomerList(e){return new Promise((s,i)=>{let n=this.db.transaction(["Customer"],"readwrite"),a=n.objectStore("Customer");e.forEach(o=>{let r=a.put(o);r.onerror=c=>{console.error("db => error saving customer : ",o,"err : ",c),i(c)}}),n.oncomplete=()=>{s()},n.onerror=o=>{console.error("db => error saving customer."),i(o)}})}getAllCustomers(){return new Promise((e,s)=>{let a=this.db.transaction(["Customer"],"readonly").objectStore("Customer").getAll();a.onsuccess=o=>{let r=o.target.result;e(r)},a.onerror=o=>{console.error("error when getting customer from db"),s(event)}})}savePosInvoice(e){return new Promise((s,i)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").put(e);o.onsuccess=r=>{s(r)},o.onerror=r=>{i(r)}})}updatePosInvoice(e){return new Promise((s,i)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").put(e);o.onsuccess=r=>{s(r.target.result)},o.onerror=r=>{i(r)}})}getAllPosInvoice(){return new Promise((e,s)=>{let a=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("creation_time"),o=[],r=a.openCursor(null,"prev");r.onsuccess=c=>{let l=c.target.result;l?(o.push(l.value),l.continue()):(console.log("check the response : ",o),e(o))},r.onerror=c=>{s(c)}})}getAllOpenedPosInvoice(){return new Promise((e,s)=>{let a=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").getAll();a.onsuccess=o=>{let r=o.target.result;e(r.filter(c=>c.opened==1))},a.onerror=o=>{s(o)}})}getAllPosInvoice_callback(e,s){let a=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("creation_time"),o=[],r=a.openCursor(null,"prev");r.onsuccess=c=>{let l=c.target.result;l?(o.push(l.value),l.continue()):(console.log("check the response : ",o),e(o))},r.onerror=c=>{s(c)}}getDraftPosInvoice(){return new Promise((e,s)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("docstatus").getAll(0);o.onsuccess=r=>{e(r.target.result)},o.onerror=r=>{s(r)}})}getNotSyncedPosNumber(e,s){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("docstatus").getAll(1);o.onsuccess=r=>{let c=r.target.result.filter(l=>l.synced==!1);e(c.length)},o.onerror=r=>{s(r)}}getNotSyncedPos(e,s){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").index("docstatus").getAll(1);o.onsuccess=r=>{let c=r.target.result.filter(l=>l.synced==!1);e(c)},o.onerror=r=>{s(r)}}deletePosInvoice(e){return new Promise((s,i)=>{let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").delete(e);o.onsuccess=()=>{s()},o.onerror=r=>{i(r)}})}deletePosInvoice_callback(e,s,i){let o=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").delete(e);o.onsuccess=()=>{s()},o.onerror=r=>{i(r)}}deleteAllPosInvoice(){return new Promise((e,s)=>{let a=this.db.transaction(["POS Invoice"],"readwrite").objectStore("POS Invoice").clear();a.onsuccess=()=>{e()},a.onerror=o=>{s(o)}})}saveCheckInOut(e,s,i){console.log("saveCheckInOut : ",e);let o=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").put(e);o.onsuccess=r=>{s(r.target.result)},o.onerror=r=>{i(r)}}getAllCheckInOut(){return new Promise((e,s)=>{let a=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").index("creation_time"),o=[],r=a.openCursor(null,"prev");r.onsuccess=c=>{let l=c.target.result;l?(o.push(l.value),l.continue()):(console.log("check the response : ",o),e(o))},r.onerror=c=>{s(c)}})}getAllCheckInOut_callback(e,s){let a=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").index("creation_time"),o=[],r=a.openCursor(null,"prev");r.onsuccess=c=>{let l=c.target.result;l?(o.push(l.value),l.continue()):(console.log("check the response : ",o),e(o))},r.onerror=c=>{s(c)}}deleteAllCheckInOut(){return new Promise((e,s)=>{let a=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out").clear();a.onsuccess=()=>{e()},a.onerror=o=>{s(o)}})}updateCheckInOutSync(e){return new Promise((s,i)=>{let a=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out"),o=a.getAll();o.onsuccess=r=>{let c=r.target.result,l=[];c.forEach(d=>{console.log("date : ",new Date(d.creation_time),"the dat ",new Date(e),"record :  ",d),!d.is_sync&&new Date(d.creation_time)<=new Date(e)&&(d.is_sync=1,l.push(new Promise((p,h)=>{let m=a.put(d);m.onsuccess=()=>p(),m.onerror=f=>h(f)})))}),Promise.all(l).then(()=>s()).catch(d=>i(d))},o.onerror=r=>i(r)})}updateCheckInOutSync_callback(e,s,i){let a=this.db.transaction(["check_in_out"],"readwrite").objectStore("check_in_out"),o=a.getAll();o.onsuccess=r=>{let c=r.target.result,l=0,d=0;if(c.forEach(p=>{!p.is_sync&&new Date(p.creation)<=new Date(e)&&d++}),d===0){s();return}c.forEach(p=>{if(!p.is_sync&&new Date(p.creation)<=new Date(e)){p.is_sync=1;let h=a.put(p);h.onsuccess=()=>{l++,l===d&&s()},h.onerror=m=>{i(m)}}})},o.onerror=r=>i(r)}updateSettings(e){return new Promise((s,i)=>{let o=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").put(y({id:1},e));o.onsuccess=r=>{s(r.target.result)},o.onerror=r=>{i(r)}})}updateSettings_callback(e,s,i){let o=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").put(y({id:1},e));o.onsuccess=r=>{s(r.target.result)},o.onerror=r=>{i(r)}}getSettings(e,s){let a=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").get(1);a.onsuccess=o=>{e(o.target.result)},a.onerror=o=>{s(o)}}deleteAllSettings(){return new Promise((e,s)=>{let a=this.db.transaction(["POS Settings"],"readwrite").objectStore("POS Settings").clear();a.onsuccess=()=>{e()},a.onerror=o=>{s(o)}})}};pos_ar.PointOfSale.pos_settings=class{constructor(t,e,s,i){this.wrapper=t,this.settings_data=e,this.selected_pos_profile=s,this.on_settings_change=i,this.scene="pos_profile",this.start_work()}start_work(){this.prepareSettingsCart(),this.refreshLeftSection(),this.setListener()}prepareSettingsCart(){this.wrapper.find("#RightSection").append('<div id="settingsRightContainer" class="columnBox"></div>'),this.wrapper.find("#LeftSection").append('<div id="settingsLeftContainer" class="columnBox"></div>'),this.leftContainer=this.wrapper.find("#settingsLeftContainer"),this.rightContainer=this.wrapper.find("#settingsRightContainer"),this.rightContainer.append('<div id="pos_profile_btn"      class="settings_tab active" >POS Profile</div>'),this.rightContainer.append('<div id="general_settings_btn" class="settings_tab"        >Generale Settings</div>'),this.rightContainer.append('<div id="about_us_btn"         class="settings_tab"        >About Us</div>'),this.pos_profile_btn=this.rightContainer.find("#pos_profile_btn"),this.general_settings_btn=this.rightContainer.find("#general_settings_btn"),this.about_us_btn=this.rightContainer.find("#about_us_btn")}refreshLeftSection(){this.leftContainer.html(""),this.scene=="pos_profile"?this.refreshPosProfileScene():this.scene=="general_settings"?this.refreshGeneralSettings():this.scene=="about_us"&&this.refreshAboutUs()}refreshPosProfileScene(){this.leftContainer.addClass("columnBox"),this.leftContainer.append('<h4 class="CartTitle" style="margin-bottom:35px; font-size:35px;" >POS Profile</h4>'),this.leftContainer.append('<div id="settingsCartContentsContainer">  </div>'),this.contentsContainer=this.leftContainer.find("#settingsCartContentsContainer"),this.contentsContainer.append('<div id="posProfileContent" class="contentContainer rowBox" style="width:100%;"> <div class="c1 columnBox"></div>   <div class="c2 columnBox"></div> </div>'),this.pos_profile_content=this.contentsContainer.find("#posProfileContent"),this.c1=this.pos_profile_content.find("div.c1"),this.c2=this.pos_profile_content.find("div.c2"),this.c1.append('<label for="pos_profile"> POS Profile </label>'),this.c1.append('<select  name="pos_profile" id="posProfileSelect" disabled ></select>'),this.pos_profile_select=this.c1.find("#posProfileSelect"),this.pos_profile_select.append(`<option value="${this.selected_pos_profile.name} selected ">${this.selected_pos_profile.name}</option>`),this.c1.append('<label for="warehouse">POS Warehouse</label>'),this.c1.append(`<input name="warehouse" value="${this.selected_pos_profile.warehouse}" disabled>`),this.c1.append('<label for="income_account">POS income account</label>'),this.c1.append(`<input name="income_account" value="${this.selected_pos_profile.income_account}" disabled>`),this.c2.append('<label for="write_off_account">POS write off account</label>'),this.c2.append(`<input name="write_off_account" value="${this.selected_pos_profile.write_off_account}" disabled>`),this.c2.append('<label for="write_off_cost_center">POS write off cost center</label>'),this.c2.append(`<input name="write_off_cost_center" value="${this.selected_pos_profile.write_off_cost_center}" disabled>`),this.c2.append('<label for="taxes_and_charges">POS taxes and charges</label>'),this.c2.append(`<input name="taxes_and_charges" value="${this.selected_pos_profile.taxes_and_charges}" disabled>`)}refreshGeneralSettings(){let t=this.settings_data.settings.itemPriceBasedOn,e=this.settings_data.settings.showItemDetails?"checked":"",s=this.settings_data.settings.showItemImage?"checked":"",i=this.settings_data.settings.showDiscountField?"checked":"",n=this.settings_data.settings.search_by_group?"checked":"",a=this.settings_data.settings.onlineDebt?"checked":"",o=this.settings_data.settings.keyboard_style;console.log("check it here : ",this.settings_data.settings.onlineDebt),this.leftContainer.addClass("columnBox"),this.leftContainer.append('<h4 class="CartTitle" style="margin-bottom:35px; font-size:35px;" >General Settings</h4>'),this.leftContainer.append('<div id="settingsCartContentsContainer">  </div>'),this.contentsContainer=this.leftContainer.find("#settingsCartContentsContainer"),this.contentsContainer.append('<div id="generalSettingsContent" class="contentContainer rowBox" style="width:100%;"> <div class="c1 columnBox"></div>   <div class="c2 columnBox"></div> </div>'),this.general_settings_content=this.contentsContainer.find("#generalSettingsContent"),this.general_settings_c1=this.general_settings_content.find("div.c1"),this.general_settings_c2=this.general_settings_content.find("div.c2"),this.general_settings_c1.append('<label for="priceBasedOn" style="font-weight:600;"> Item Price Based On : </label>'),this.general_settings_c1.append('<select  name="priceBasedOn" id="priceBasedOnSelect" ></select>'),this.item_price_based_on_select=this.general_settings_c1.find("#priceBasedOnSelect"),this.settings_data.getAllPriceBases().forEach(r=>{this.settings_data.settings.itemPriceBasedOn==r?this.item_price_based_on_select.append(`<option value="${r}" selected> ${r} </option>`):this.item_price_based_on_select.append(`<option value="${r}"> ${r} </option>`)}),this.general_settings_c2.append('<label for="keyboardStyle" style="font-weight:600;"> Keyboard Style : </label>'),this.general_settings_c2.append('<select  name="keyboardStyle" id="keyboardStyle" ></select>'),this.keyboard_style_select=this.general_settings_c2.find("#keyboardStyle"),this.settings_data.getAllKeyboardStyles().forEach(r=>{this.settings_data.settings.keyboardStyle==r?this.keyboard_style_select.append(`<option value="${r}" selected> ${r} </option>`):this.keyboard_style_select.append(`<option value="${r}"> ${r} </option>`)}),this.general_settings_c2.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Get Client Debt OnLine : </div>'),this.general_settings_c2.append(`<div class="rowBox align_center" style="height:50px;"><label for="onlineDebtCheckBox" style="margin-right:16px;width:50%;" > online debt: </label> <input type="checkbox"  name="onlineDebtCheckBox" id="onlineDebtCheckBoxCheckBox" ${a} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Item Details Cart : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;"><label for="showItemDetailsCartCheckBox" style="margin-right:16px;width:50%;" > show cart: </label> <input type="checkbox"  name="showItemDetailsCartCheckBox" id="showItemDetailsCartCheckBox" ${e} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Item Image : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;" ><label for="showItemImageCheckBox" style="margin-right:16px;width:50%;"> show item image: </label> <input type="checkbox"  name="showItemImageCheckBox" id="showItemImageCheckBox" ${s} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> Discount feature : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;" ><label for="showDiscountFieldCheckBox" style="margin-right:16px;width:50%;"> show discount field: </label> <input type="checkbox"  name="showDiscountFieldCheckBox" id="showDiscountFieldCheckBox" ${i} ></div>`),this.general_settings_c1.append('<div for="showItemDetailsCartCheckBox" style="font-weight:600;"> filter item by group : </div>'),this.general_settings_c1.append(`<div class="rowBox align_center" style="height:50px;" ><label for="showItemGroupFilterCheckBox" style="margin-right:16px;width:50%;"> show item group filter: </label> <input type="checkbox"  name="showItemGroupFilterCheckBox" id="showItemGroupFilterCheckBox" ${n} ></div>`),this.item_price_based_on_select.on("input",r=>{this.settings_data.setPriceItemBasedOn(r.target.value,()=>{this.on_settings_change("itemPriceBasedOn")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.keyboard_style_select.on("input",r=>{this.settings_data.settings.keyboardStyle=r.target.value,this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showItemImage")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showItemDetailsCartCheckBox").on("click",r=>{this.settings_data.settings.showItemDetails=$(r.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showItemDetails")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showItemImageCheckBox").on("click",r=>{this.settings_data.settings.showItemImage=$(r.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showItemImage")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showDiscountFieldCheckBox").on("click",r=>{this.settings_data.settings.showDiscountField=$(r.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("showDiscountField")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c1.find("#showItemGroupFilterCheckBox").on("click",r=>{this.settings_data.settings.search_by_group=$(r.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("")},()=>{console.error("error to save the settings changes (settings.js)")})}),this.general_settings_c2.find("#onlineDebtCheckBoxCheckBox").on("click",r=>{this.settings_data.settings.onlineDebt=$(r.target).is(":checked"),this.settings_data.setSettings(this.settings_data.settings,()=>{this.on_settings_change("")},()=>{console.error("error to save the settings changes (pos_settings.js)")})})}refreshAboutUs(){this.leftContainer.addClass("columnBox"),this.leftContainer.append('<h4 class="CartTitle" style="margin-bottom:35px; font-size:35px;" >About Us</h4>'),this.leftContainer.append('<div id="settingsCartContentsContainer">  </div>'),this.contentsContainer=this.leftContainer.find("#settingsCartContentsContainer")}showCart(){this.rightContainer.css("display","flex"),this.leftContainer.css("display","flex")}hideCart(){this.rightContainer.css("display","none"),this.leftContainer.css("display","none")}setListener(){let t=document.querySelectorAll(".settings_tab"),e=document.querySelectorAll(".contentContainer");t.forEach((s,i)=>{s.addEventListener("click",()=>{t.forEach(n=>{n.classList.remove("active")}),s.classList.add("active")})}),this.pos_profile_btn.on("click",s=>{this.scene="pos_profile",this.refreshLeftSection()}),this.general_settings_btn.on("click",s=>{this.scene="general_settings",this.refreshLeftSection()}),this.about_us_btn.on("click",s=>{this.scene="about_us",this.refreshLeftSection()})}};pos_ar.PointOfSale.pos_check_in_out=class{constructor(t,e){this.wrapper=t,this.db=e,this.checkList=[],this.filter="All",this.selectedCheckInOut=null,this.start_work()}start_work(){this.prepare_checkInOut_cart(),this.getAllCheckInOut(),this.setListeners()}prepare_checkInOut_cart(){this.wrapper.find("#LeftSection").append('<div id="checkInOutLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="checkInOutRightContainer" class="columnBox"></div>'),this.left_container=this.wrapper.find("#checkInOutLeftContainer"),this.right_container=this.wrapper.find("#checkInOutRightContainer"),this.right_container.append('<div id="checkInOutTabContainer" class="rowBox">  <div id="tabAll" class="tab selected">All</div> <div id="tabCheckIn" class="tab">Check In</div> <div id="tabCheckOut" class="tab">Check Out</div>  </div>'),this.tab_container=this.right_container.find("#checkInOutTabContainer"),this.tab_all=this.tab_container.find("#tabAll"),this.tab_in=this.tab_container.find("#tabCheckIn"),this.tab_out=this.tab_container.find("#tabCheckOut"),this.right_container.append('<div id="checkInOutList" class="columnBox"></div>'),this.check_in_out_list=this.right_container.find("#checkInOutList");let t='<div id="detailsCheckInOutHeader" class="rowBox" ><div class="checkInAmount columnBox" ><div class="rowBox centerItem" style="width:100%;height:50%;"><div style="font-size:25px; font-weight:700;">Check In</div></div><div id="TotalCheckInValue" class="rowBox centerItem" style="height:50%; width:100%;">...DA</div></div><div class="checkOutAmount columnBox" ><div class="rowBox centerItem" style="width:100%;height:50%;" ><div style="font-size:25px; font-weight:700;">Check Out</div></div><div id="TotalCheckOutValue" class="rowBox centerItem" style="width:100%;height:50%;"> ...DA </div></div><div class="totalCheckInOutAmount columnBox centerItem"><div class="rowBox centerItem" style="width:100%;height:50%;"><div style="font-size:25px; font-weight:700;">Total</div></div><div id="TotalCheckInOutValue" class="rowBox centerItem" style="height:50%; width:100%;">...DA</div></div></div>';this.left_container.append(t),this.details_checkInOut_header=this.left_container.find("#detailsCheckInOutHeader"),this.check_in_amount=this.details_checkInOut_header.find("#TotalCheckInValue"),this.check_out_amount=this.details_checkInOut_header.find("#TotalCheckOutValue"),this.check_total_in_out_amount=this.details_checkInOut_header.find("#TotalCheckInOutValue"),this.left_container.append('<div id="detailsCheckInOutContent" class="columnBox"></div>'),this.detailsCheckInOutContent=this.left_container.find("#detailsCheckInOutContent");let e='<div class="l1 rowBox"><div><span class="key">Check Type :<span> <span id="selectedCheckInOutType" class="value"> THE_TYPE </span></div><div><span class="value" id="selectedCheckInOutCreationTime"> THE_DATE </span></div></div><div class="l2 rowBox"><div><span class="key">Amount :</span> <span id="selectedCheckInOutAmount" class="value">THE AMOUNT</span></div><div><span id="selectedCheckInOutOwner" class="value">THE OWNER</span></div></div><div class="l3"><div class="title">Reason</div><textarea id="selectedCheckInOutReason" disabled ></textarea></div>';this.detailsCheckInOutContent.append(e),this.checkType=this.detailsCheckInOutContent.find("#selectedCheckInOutType"),this.checkAmount=this.detailsCheckInOutContent.find("#selectedCheckInOutAmount"),this.checkCreationTime=this.detailsCheckInOutContent.find("#selectedCheckInOutCreationTime"),this.checkOwner=this.detailsCheckInOutContent.find("#selectedCheckInOutOwner"),this.checkReason=this.detailsCheckInOutContent.find("#selectedCheckInOutReason")}refreshCheckInOutList(){this.check_in_out_list.empty(),console.log("this.checkList : ",this.checkList),this.checkList.filter(e=>e.check_type==this.filter||this.filter=="All").forEach(e=>{let s=document.createElement("div");s.classList.add("checkInOutItem","rowBox");let i=document.createElement("div");i.classList.add("type");let n=document.createElement("img");n.src="/assets/pos_ar/images/arrow.png",n.style.width="35px",n.style.height="35px",n.style.transform=e.check_type==="In"?"rotate(180deg)":"",console.log("checkInOut.check_type : ",e.check_type==="In"?"rotate(180deg);":"");let a=document.createElement("div");a.textContent=e.check_type;let o=document.createElement("div");o.classList.add("creationTime"),o.textContent=e.creation_time;let r=document.createElement("div");r.classList.add("amount"),r.textContent=e.amount+" DA",i.append(n),i.append(a),s.append(i),s.append(o),s.append(r),s.addEventListener("click",()=>{this.selectedCheckInOut=e,this.refreshCheckInOutDetails()}),this.check_in_out_list.append(s)})}refreshCheckInOutAmount(){this.check_total_in_out_amount.html(""),this.check_in_amount.html(""),this.check_out_amount.html("");let t=0,e=0,s=0;this.checkList.forEach(i=>{s+=parseFloat(i.amount)||0,i.check_type=="In"?t+=parseFloat(i.amount)||0:i.check_type=="Out"&&(e+=parseFloat(i.amount)||0)}),this.check_in_amount.append(`${t.toFixed(2)} DA`),this.check_out_amount.append(`${e.toFixed(2)} DA`),this.check_total_in_out_amount.append(`${s.toFixed(2)} DA`)}refreshCheckInOutDetails(){this.selectedCheckInOut!=null&&(this.checkType.html(""),this.checkCreationTime.html(""),this.checkReason.html(""),this.checkOwner.html(""),this.checkAmount.html(""),this.checkType.append(this.selectedCheckInOut.check_type),this.checkCreationTime.append(this.selectedCheckInOut.creation_time),this.checkAmount.append(this.selectedCheckInOut.amount+" DA"),this.checkReason.append(this.selectedCheckInOut.reason||this.selectedCheckInOut.reason_note),this.checkOwner.append(this.selectedCheckInOut.owner),console.log("this.checkReason.scrollHeight : ",this.checkReason.get(0).scrollHeight),this.checkReason.get(0).style.height="auto",this.checkReason.get(0).style.height=this.checkReason.get(0).scrollHeight+"px")}showCart(){this.left_container.css("display","flex"),this.right_container.css("display","flex")}hideCart(){this.left_container.css("display","none"),this.right_container.css("display","none")}setListeners(){this.tab_all.on("click",t=>{this.filter="All",this.tab_all.addClass("selected"),this.tab_out.removeClass("selected"),this.tab_in.removeClass("selected"),this.refreshCheckInOutList()}),this.tab_in.on("click",t=>{this.filter="In",this.tab_in.addClass("selected"),this.tab_out.removeClass("selected"),this.tab_all.removeClass("selected"),this.refreshCheckInOutList()}),this.tab_out.on("click",t=>{this.filter="Out",this.tab_out.addClass("selected"),this.tab_all.removeClass("selected"),this.tab_in.removeClass("selected"),this.refreshCheckInOutList()})}async getAllCheckInOut(){this.db.getAllCheckInOut_callback(t=>{t.length>0&&(this.selectedCheckInOut=t[0]),this.checkList=t,this.refreshCheckInOutList(),this.refreshCheckInOutAmount(),this.refreshCheckInOutDetails(),console.log("res : ",t)},t=>{console.log("err : ",t)})}};pos_ar.PointOfSale.pos_debt_cart=class{constructor(t,e,s){this.wrapper=t,this.app_data=e,this.refresh_check_in_out=s,this._filtredClientList=this.app_data.appData.customers,this.selected_client={},this.payment_amount=0,this._pos_invoice=[],this._sales_invoice=[],this._selected_invoice=[],this.start_work()}start_work(){this.prepare_cart(),this.refreshClientPart(),this.setListener()}prepare_cart(){this.wrapper.find("#LeftSection").append('<div id="debtLeftContainer" class="columnBox"></div>'),this.wrapper.find("#RightSection").append('<div id="debtRightContainer" class="columnBox"></div>'),this.leftContainer=this.wrapper.find("#debtLeftContainer"),this.rightContainer=this.wrapper.find("#debtRightContainer"),this.rightContainer.append(`
			<div class="debt-header">
				<input type="text" 
					id="debt_filterClientList" 
					placeholder="Search customers..."
				>
			</div>
			<div id="debt_customerList"></div>
		`),this.customerList=this.rightContainer.find("#debt_customerList"),this.leftContainer.append(`
			<div class="payment-header">
				<div class="amount-input">
					<input id="debt_paymentAmount" type="number" placeholder="Enter amount">
				</div>
				<div id="total_client_debt">Total: 0 DA</div>
				<div id="partially_client_debt">Selected: 0 DA</div>
				<button id="pay_selected_invoices_btn">Pay</button>
			</div>
			<div id="debt_debtsList"></div>
		`),this.leftContainer.append(`
			<script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"><\/script>
			<div id="debt_waitingContainer" style="display:none;">
				<dotlottie-player 
					src="https://lottie.host/d6c76206-aab9-4d5a-af73-c4a6cfc5aaa9/H8vnpKcKj9.lottie" 
					background="transparent" 
					speed="1" 
					style="width: 300px; height: 300px" 
					loop 
					autoplay
				></dotlottie-player>
			</div>
		`),this.waiting_cart=this.leftContainer.find("#debt_waitingContainer"),this.total_client_debt=this.leftContainer.find("#total_client_debt"),this.partially_client_debt=this.leftContainer.find("#partially_client_debt"),this.pay_selected_invoices_btn=this.leftContainer.find("#pay_selected_invoices_btn"),this.debtList=this.leftContainer.find("#debt_debtsList")}add_customer_to_list(t){let e=document.createElement("div");e.className="customer-item",e.innerHTML=`
			<div class="customer-name">${t.customer_name}</div>
			<div class="customer-info">
				<span>${t.customer_primary_contact||""}</span>
				<span>${t.mobile_no||""}</span>
			</div>
		`,e.addEventListener("click",()=>{this.customerList.find(".customer-item").removeClass("selected"),e.classList.add("selected"),this.selected_client=structuredClone(t),this.refreshClientDebtPart(t)}),this.customerList.append(e)}showCart(){this.leftContainer.css("display","flex"),this.rightContainer.css("display","flex")}hideCart(){this.leftContainer.css("display","none"),this.rightContainer.css("display","none")}show_waiting(){this.waiting_cart.css("display","flex")}hide_waiting(){this.waiting_cart.css("display","none")}setListener(){this.rightContainer.find("#debt_filterClientList").on("input",t=>{let e=this.rightContainer.find("#debt_filterClientList").val().trim().toLowerCase();this._filtredClientList=this.app_data.appData.customers.filter(s=>s.customer_name.toLowerCase().includes(e)),this.refreshClientPart()}),this.leftContainer.find("#debt_paymentAmount").on("input",t=>{this.payment_amount=parseFloat(this.leftContainer.find("#debt_paymentAmount").val())}),this.pay_selected_invoices_btn.on("click",async()=>{console.log("check the list ==> ",this._selected_invoice),this.paySelectedInvoice()}),this.debtList.on("click",'.invoiceBox input[type="checkbox"]',t=>{let e=$(t.target),s=e.data("invoice-name"),i=e.data("outstanding-amount"),n=e.data("invoice-type"),a={name:s,outstanding_amount:i,type:n};if(e.is(":checked"))this._selected_invoice.some(o=>o.name==s)||this._selected_invoice.push(a);else{let o=this._selected_invoice.findIndex(r=>r.name==s);o>-1&&this._selected_invoice.splice(o,1)}this.refresh_partially_paid()})}refreshClientPart(){this.customerList.html(""),this._filtredClientList.forEach(t=>{this.add_customer_to_list(t)})}refreshTotal(t){this.total_client_debt.text(`Total Debt : ${t} DA`)}refresh_partially_paid(){let t=0;this._selected_invoice.forEach(e=>{t+=e.outstanding_amount}),this.partially_client_debt.text(`Selected Debt : ${t} DA`)}async refreshClientDebtPart(t){this.refreshTotal("Loading ..."),this._selected_invoice=[],this.refresh_partially_paid();let e="width:calc(100% - 40px);height:60px;min-height:60px;border-bottom:2px solid #505050;",s="width:80px;height:35px;color:white;background:green;border-radius:12px;margin:0px 20px;cursor:pointer;",i=0;this.debtList.html("");let n=await this.app_data.fetchDebts(t.name),a=await this.app_data.fetchDebtsSalesInvoices(t.name);n.forEach(o=>{i+=o.outstanding_amount;let r=$(`<div  style="${e}" class="rowBox C_A_Center invoiceBox" data-invoice-name="${o.name}"></div>`),c=$(`<input type="checkbox" class="select_checkbox" style="margin:0px 16px;" data-invoice-type="POS Invoice" data-invoice-name="${o.name}" data-outstanding-amount="${o.outstanding_amount}" ></input>`);r.append(`<div style="flex-grow:1;">${o.name}</div>`),r.append(`<div style="flex-grow:1;">${o.outstanding_amount} DA</div>`),r.append(`<div style="flex-grow:1;">${o.posting_date}</div>`),r.append('<div style="flex-grow:1;">POS Invoice</div>'),r.append(`<div class="rowBox centerItem payBtn" style="${s}">Pay</div>`),r.find(".payBtn").on("click",async()=>{await this.payPosInvoice(o)}),this.debtList.append(r)}),a.forEach(o=>{i+=o.outstanding_amount;let r=$(`<div  style="${e}" class="rowBox C_A_Center invoiceBox" data-invoice-name="${o.name}"></div>`);r.append(`<input type="checkbox" style="margin:0px 16px;" data-invoice-type="Sales Invoice" data-invoice-name="${o.name}" data-outstanding-amount="${o.outstanding_amount}" ></input>`),r.append(`<div style="flex-grow:1;">${o.name}</div>`),r.append(`<div style="flex-grow:1;">${o.outstanding_amount} DA</div>`),r.append(`<div style="flex-grow:1;">${o.posting_date}</div>`),r.append('<div style="flex-grow:1;">Sales Invoice</div>'),r.append(`<div class="rowBox centerItem payBtn" style="${s}">Pay</div>`),r.find(".payBtn").on("click",async()=>{await this.paySalesInvoice(o)}),this.debtList.append(r)}),this.refreshTotal(i)}async payPosInvoice(t){let e=parseFloat(this.payment_amount)||0;if(this.paymentAmount<=0){frappe.msgprint(__("The paid amount should be grant than 0"));return}try{this.show_waiting();let s=await this.app_data.update_invoice_payment(t.name,this.payment_amount);this.payment_amount=s.remaining,this.leftContainer.find("#debt_paymentAmount").val(s.remaining),await this.refreshClientDebtPart(this.selected_client)}catch(s){console.error("Error processing payment:",s),alert("An error occurred while processing the payment. Please try again.")}finally{this.hide_waiting()}}async paySalesInvoice(t){try{this.show_waiting();let e=parseFloat(this.payment_amount)||0;if(e<=0){frappe.msgprint(__("The paid amount should be grant than 0"));return}let s=await this.app_data.update_sales_invoice_payment(t.name,e),i=this.payment_amount-s.remaining,n=frappe.model.get_new_doc("check_in_out");if(n.creation_time=frappe.datetime.now_datetime(),n.user=frappe.session.user,n.check_type="In",n.is_sync=0,n.amount=parseFloat(i),n.reason_note="Debt payment.",this.app_data.saveCheckInOut(n,a=>{this.refresh_check_in_out()},a=>{console.log("err to save checkInOut : ",a)}),s&&typeof s.remaining=="number")this.payment_amount=s.remaining,this.leftContainer.find("#debt_paymentAmount").val(s.remaining),await this.refreshClientDebtPart(this.selected_client);else throw new Error("Unexpected server response. Please try again.")}catch(e){console.error("Error processing sales invoice payment:",e),alert("An error occurred while processing the payment. Please try again later.")}finally{this.hide_waiting()}}async paySelectedInvoice(){try{this.show_waiting();let t=parseFloat(this.payment_amount)||0,e=await this.app_data.paySelectedInvoice(this._selected_invoice,t),s=t-e.remaining,i=frappe.model.get_new_doc("check_in_out");if(i.creation_time=frappe.datetime.now_datetime(),i.user=frappe.session.user,i.check_type="In",i.is_sync=0,i.amount=parseFloat(s),i.reason_note="Debt payment.",this.app_data.saveCheckInOut(i,n=>{this.refresh_check_in_out()},n=>{console.log("err to save checkInOut : ",n)}),e&&typeof e.remaining=="number")this.payment_amount=e.remaining,this.leftContainer.find("#debt_paymentAmount").val(e.remaining),await this.refreshClientDebtPart(this.selected_client);else throw new Error("Unexpected server response. Please try again.")}catch(t){console.error("Error processing sales invoice payment:",t),alert("An error occurred while processing the payment. Please try again later.")}finally{this.hide_waiting()}}};pos_ar.PointOfSale.pos_unsynced_cart=class{constructor(t,e,s,i,n){this.wrapper=t,this.app_data=e,this.db=s,this.view_details_callback=i,this.on_delete_callback=n,this.invoices=[],this.filter="All",this.selectedInvoice=null,this.search_value="",this.start_work()}async start_work(){this.prepare_unsynced_pos_cart(),await this.getAllUnsyncedInvoices(),this.setListeners()}prepare_unsynced_pos_cart(){this.wrapper.find("#LeftSection").append('<div id="unsyncedPosLeftContainer" class="columnBox" style="display:none;"></div>'),this.wrapper.find("#RightSection").append('<div id="unsyncedPosRightContainer" class="columnBox" style="display:none;"></div>'),this.left_container=this.wrapper.find("#unsyncedPosLeftContainer"),this.right_container=this.wrapper.find("#unsyncedPosRightContainer"),this.right_container.append('<div id="unsyncedRightContainerHeader" class="rowBox align_center"><h4 class="CartTitle">Unsynced Invoices</h4></div>'),this.right_container.append('<div id="unsyncedRightSearchContainer" class="rowBox align_center"></div>'),this.search_container=this.right_container.find("#unsyncedRightSearchContainer"),this.search_container.append('<select id="unsyncedFilterInput" placeholder="Filter Status">'),this.filter_input=this.search_container.find("#unsyncedFilterInput"),this.filter_input.append('<option value="All" selected>All</option><option value="Not Synced">Not Synced</option><option value="Failed">Failed</option>'),this.search_container.append('<input type="text" id="unsyncedSearchInput" placeholder="Search by invoice number">'),this.search_field=this.search_container.find("#unsyncedSearchInput"),this.right_container.append('<div id="unsyncedInvoiceList" class="columnBox"></div>'),this.unsynced_invoice_list=this.right_container.find("#unsyncedInvoiceList");let t='<div id="detailsUnsyncedHeader" class="rowBox"><div class="c1 columnBox"><div id="unsyncedCustomer">Customer</div><div id="unsyncedSoldBy"></div><div id="unsyncedStatus" class="status"></div></div><div class="c2 columnBox"><div id="unsyncedCost">0,0000 DA</div><div id="unsyncedId">ACC-PSINV-2024-ID</div><div id="unsyncedRealId">POS realI</div></div></div>';this.left_container.append(t),this.details_unsynced_header=this.left_container.find("#detailsUnsyncedHeader"),this.left_container.append('<div id="unsyncedContent" class="columnBox"></div>'),this.unsyncedContent=this.left_container.find("#unsyncedContent"),this.unsyncedContent.append('<div id="unsyncedItemContainer"><div class="posSectionTitle">Items</div><div id="unsyncedItemList"></div></div>'),this.itemContainer=this.unsyncedContent.find("#unsyncedItemContainer"),this.itemList=this.itemContainer.find("#unsyncedItemList"),this.unsyncedContent.append('<div id="unsyncedTotalsContainer"><div class="posSectionTitle">Totals</div><div id="unsyncedTotalList"></div></div>'),this.totalsContainer=this.unsyncedContent.find("#unsyncedTotalsContainer"),this.totalList=this.unsyncedContent.find("#unsyncedTotalList"),this.unsyncedContent.append('<div id="unsyncedPaymentsContainer"><div class="posSectionTitle">Payments</div><div id="unsyncedMethodList"></div></div>'),this.paymentsContainer=this.unsyncedContent.find("#unsyncedPaymentsContainer"),this.methodList=this.unsyncedContent.find("#unsyncedMethodList"),this.left_container.append('<div id="unsyncedActionsContainer" class="rowBox align_content"><div id="unsyncedRetryBtn" class="actionBtn rowBox centerItem">Retry Sync</div><div id="unsyncedViewBtn" class="actionBtn rowBox centerItem">View Details</div></div>'),this.actionButtonsContainer=this.left_container.find("#unsyncedActionsContainer"),this.retryButton=this.actionButtonsContainer.find("#unsyncedRetryBtn"),this.viewButton=this.actionButtonsContainer.find("#unsyncedViewBtn")}refreshData(){this.unsynced_invoice_list.empty(),console.log("refreshing unsynced invoice list",this.invoices,"unsynced ",this.invoices.filter(e=>!e.synced));let t=this.invoices.filter(e=>!e.synced);if(!t.length){this.unsynced_invoice_list.append('<div class="empty-state">No unsynced invoices found</div>');return}t.forEach(e=>{let s=document.createElement("div");s.classList.add("posInvoiceContainer"),s.classList.add("columnBox"),s.classList.add("align_content");let i=document.createElement("div");i.classList.add("l1"),i.classList.add("rowBox"),i.classList.add("align_content");let n=document.createElement("div");n.classList.add("posName"),n.textContent=e.name;let a=document.createElement("div");a.classList.add("posCost"),a.textContent=format_currency(e.grand_total,e.currency),i.appendChild(n),i.appendChild(a);let o=document.createElement("div");o.classList.add("l2"),o.classList.add("rowBox"),o.classList.add("align_content");let r=document.createElement("div");r.classList.add("customer"),r.classList.add("rowBox"),r.classList.add("align_content");let c=document.createElement("img");c.src="/assets/pos_ar/images/customer.png",c.width=16,c.height=16,c.classList.add("customerLogo");let l=document.createElement("div");l.textContent=e.customer||"Guest",l.classList.add("customerName"),r.appendChild(c),r.appendChild(l),o.appendChild(r);let d=document.createElement("div");d.classList.add("status"),d.classList.add(e.status.toLowerCase().replace(" ","-")),d.textContent=e.status,o.appendChild(d);let p=document.createElement("button");p.classList.add("invoice-delete-btn"),p.innerHTML='<i class="fa fa-trash fa-lg"></i>',o.appendChild(p),p.addEventListener("click",h=>{h.stopPropagation(),this.app_data.deletePosInvoice_callback(e.name,()=>{this.getAllUnsyncedInvoices(),this.on_delete_callback()},m=>{console.error("Error deleting invoice:",m),frappe.msgprint({title:__("Error"),indicator:"red",message:__("Failed to delete invoice")})})}),s.appendChild(i),s.appendChild(o),s.addEventListener("click",()=>{this.selectedInvoice=e,this.refreshInvoiceDetails(),console.log("selected invoice : ",this.selectedInvoice),this.unsynced_invoice_list.find(".posInvoiceContainer").removeClass("selected"),$(s).addClass("selected")}),this.unsynced_invoice_list.append(s)}),this.selectedInvoice&&this.refreshInvoiceDetails()}refreshInvoiceDetails(){if(!this.selectedInvoice||!this.invoices.find(n=>n.name===this.selectedInvoice.name)){this.selectedInvoice=null,this.unsyncedContent.addClass("d-none");let n=this.details_unsynced_header;n.find("#unsyncedCustomer").text(""),n.find("#unsyncedSoldBy").text(""),n.find("#unsyncedStatus").text("").removeClass(),n.find("#unsyncedCost").text(""),n.find("#unsyncedId").text(""),n.find("#unsyncedRealId").text(""),this.itemList.empty(),this.totalList.empty(),this.methodList.empty();return}this.unsyncedContent.removeClass("d-none");let t=this.details_unsynced_header;t.find("#unsyncedCustomer").text(this.selectedInvoice.customer||"Guest"),t.find("#unsyncedSoldBy").text(this.selectedInvoice.owner),t.find("#unsyncedStatus").text(this.selectedInvoice.status).removeClass("not-synced failed").addClass(this.selectedInvoice.status.toLowerCase().replace(" ","-")),t.find("#unsyncedCost").text(format_currency(this.selectedInvoice.grand_total,this.selectedInvoice.currency)),t.find("#unsyncedId").text(this.selectedInvoice.name),t.find("#unsyncedRealId").text(this.selectedInvoice.pos_profile),this.itemList.empty(),this.selectedInvoice.items.forEach(n=>{let a=document.createElement("div");a.classList.add("itemRow","rowBox");let o=document.createElement("div");o.classList.add("itemName"),o.textContent=n.item_name;let r=document.createElement("div");r.classList.add("itemQty"),r.textContent=n.qty;let c=document.createElement("div");c.classList.add("itemRate"),c.textContent=format_currency(n.rate,this.selectedInvoice.currency);let l=document.createElement("div");l.classList.add("itemAmount"),l.textContent=format_currency(n.amount,this.selectedInvoice.currency),a.appendChild(o),a.appendChild(r),a.appendChild(c),a.appendChild(l),this.itemList.append(a)}),this.totalList.empty();let e=document.createElement("div");e.classList.add("totalRow","rowBox");let s=document.createElement("div");s.classList.add("totalLabel"),s.textContent="Grand Total";let i=document.createElement("div");i.classList.add("totalAmount"),i.textContent=format_currency(this.selectedInvoice.grand_total,this.selectedInvoice.currency),e.appendChild(s),e.appendChild(i),this.totalList.append(e),this.methodList.empty(),this.selectedInvoice.payments.forEach(n=>{let a=document.createElement("div");a.classList.add("paymentRow","rowBox");let o=document.createElement("div");o.classList.add("paymentMode"),o.textContent=n.mode_of_payment;let r=document.createElement("div");r.classList.add("paymentAmount"),r.textContent=format_currency(n.amount,this.selectedInvoice.currency),a.appendChild(o),a.appendChild(r),this.methodList.append(a)})}show_cart(){this.left_container.css("display","flex"),this.right_container.css("display","flex"),this.getAllUnsyncedInvoices()}hide_cart(){this.left_container.css("display","none"),this.right_container.css("display","none")}async getAllUnsyncedInvoices(){this.invoices=await this.db.getAllPosInvoice(),this.refreshData(),this.refreshInvoiceDetails()}async retrySync(t){frappe.db.insert(t).then(e=>{let s=structuredClone(t);s.synced=!0,s.real_name=e.name,this.appData.updatePosInvoice(s)}).catch(e=>{console.error("Error retrying sync:",e),frappe.msgprint({title:__("Error"),indicator:"red",message:__("Failed to sync invoice")})})}async deleteInvoice(t){if(!!confirm("Are you sure you want to delete this unsynced invoice?"))try{this.refreshData(),frappe.show_alert({message:__("Invoice deleted successfully"),indicator:"green"})}catch(e){frappe.show_alert({message:__("Failed to delete invoice"),indicator:"red"})}}setListeners(){this.filter_input.on("change",()=>{this.filter=this.filter_input.val(),this.refreshData()}),this.search_field.on("input",()=>{this.search_value=this.search_field.val(),this.refreshData()}),this.retryButton.on("click",()=>{this.selectedInvoice&&this.retrySync(this.selectedInvoice)}),this.viewButton.on("click",()=>{this.selectedInvoice&&this.view_details_callback(this.selectedInvoice)})}};pos_ar.PointOfSale.posSettingsData=class{constructor(t){this.db=t,this.price_bases=["brand","priceList"],this.keyboard_styles=["primery","secondary"];let e={itemPriceBasedOn:"brand",keyboardStyle:"secondary",showItemDetails:!1,showItemImage:!1,showDiscountField:!1,onlineDebt:!0,testing:!1,search_by_group:!1};this.db.getSettings(s=>{s&&s.itemPriceBasedOn?this.settings=y(y({},e),s||{}):this.settings={itemPriceBasedOn:"brand",keyboardStyle:"secondary",showItemDetails:!1,showItemImage:!1,showDiscountField:!1,onlineDebt:!0,search_by_group:!1},console.log("test result : ",this.settings)},s=>{console.log("error when trying to get the setting from local, so we use the default."),this.settings={itemPriceBasedOn:"brand",keyboardStyle:"secondary",showItemDetails:!1,showItemImage:!1,showDiscountField:!1,onlineDebt:!0,search_by_group:!1}})}getAllPriceBases(){return this.price_bases}getAllKeyboardStyles(){return this.keyboard_styles}getPriceBase(){return this.settings.itemPriceBasedOn}setPriceItemBasedOn(t,e,s){this.price_bases.includes(t)?(this.settings.itemPriceBasedOn=t,this.db.updateSettings_callback(this.settings,()=>{e(),console.log("settings update is save successfuly")},()=>{console.error("error occured when trying to save settings")})):console.error("invalide base : ",t,"there are just : ",this.price_bases)}getShowItemDetails(){return this.settings.showItemDetails}setShowItemDetails(t,e,s){this.settings.showItemDetails=t,this.db.updateSettings_callback(this.settings,()=>{e(),console.log("settings update is save successfuly")},()=>{console.error("error occured when trying to save settings")})}setSettings(t,e,s){this.settings=t,this.db.updateSettings_callback(this.settings,()=>{e(),console.log("settings update is save successfuly")},()=>{console.error("error occured when trying to save settings")})}};pos_ar.PointOfSale.posAppData=class{constructor(t,e){this.db=t,this.api_handler=e,this.since=localStorage.getItem("lastTime"),this.appData={}}async getAllData(){try{frappe.show_progress("Please Wait",0,12,"loading deleted documents"),await this.getDeletedDocs(),frappe.show_progress("Please Wait",1,12,"loading customers..."),await this.getCustomers(),frappe.show_progress("Please Wait",2,12,"loading items..."),await this.getItems(),frappe.show_progress("Please Wait",3,12,"loading pos profiles"),await this.getPosProfiles(),frappe.show_progress("Please Wait",4,12,"loading mode of payment"),await this.getPosProfileModeOfPayments(this.appData.pos_profile),await this.getBins(),frappe.show_progress("Please Wait",5,12,"loading warehouses"),await this.getWarehouses(),frappe.show_progress("Please Wait",6,12,"loading price lists"),await this.getPriceLists(),frappe.show_progress("Please Wait",7,12,"loading item prices"),await this.getItemPrices(),frappe.show_progress("Please Wait",8,12,"loading item groups"),await this.getItemGroups(),frappe.show_progress("Please Wait",9,12,"loading invoices"),await this.getPosInvoices(),frappe.show_progress("Please Wait",10,12,"loading check in out"),await this.getCheckInOuts(),frappe.show_progress("Please Wait",11,12,"loading barcodes"),await this.getItemBarcodes(),frappe.show_progress("Please Wait",12,12,"Completed"),frappe.hide_progress(),frappe.hide_progress(),frappe.hide_progress(),frappe.hide_progress(),this.since=frappe.datetime.now_datetime(),localStorage.setItem("lastTime",frappe.datetime.now_datetime()),console.log("app data : ",this.appData)}catch(t){console.error("appData Class Error  : ",t),frappe.hide_progress()}frappe.hide_progress()}async getCustomers(){let t=[],e=await this.api_handler.fetchCustomers(this.since);await this.db.saveCustomerList(e),this.appData.customers=this.combineLocalAndUpdated(t,e)}async getBrands(){this.appData.brands=await this.api_handler.fetchBrands(this.since)}async getItems(){let t=[],e=await this.api_handler.fetchItems(this.since);await this.db.saveItemList(e),this.appData.items=this.combineLocalAndUpdated(t,e)}async getPosProfiles(){this.appData.pos_profile=await this.api_handler.fetchPosProfile(this.since)}async getPosProfileModeOfPayments(t){let e=[];t.payments.forEach(s=>{e.push(s.mode_of_payment)}),this.appData.posProfileModeOfPayments=await this.api_handler.fetchPosProfileModeOfPayments(e,t.company)}async getBins(){let t=[],e=await this.api_handler.fetchBinList(this.since);await this.db.saveBinList(e),this.appData.bins=this.combineLocalAndUpdated(t,e)}async getWarehouses(){let t=[],e=await this.api_handler.fetchWarehouseList(this.since);await this.db.saveWarehouseList(e),this.appData.warehouses=this.combineLocalAndUpdated(t,e)}async getPriceLists(){let t=[],e=await this.api_handler.fetchPriceList(this.since);await this.db.savePriceLists(e),this.appData.price_lists=this.combineLocalAndUpdated(t,e)}async getItemPrices(){let t=[],e=await this.api_handler.fetchItemPrice(this.since);await this.db.saveItemPriceList(e),this.appData.item_prices=this.combineLocalAndUpdated(t,e),console.log()}async getItemGroups(){let t=[],e=await this.api_handler.fetchItemGroups(this.since);await this.db.saveItemGroupList(e),this.appData.item_groups=this.combineLocalAndUpdated(t,e)}async getItemBarcodes(){this.appData.item_barcodes=await this.api_handler.fetchItemBarCodes()}async getPosInvoices(){this.appData.pos_invoices=await this.db.getAllPosInvoice()}async getCheckInOuts(){this.appData.check_in_outs=await this.db.getAllCheckInOut()}async getDeletedDocs(){this.appData.deleted_documents=await this.api_handler.fetchDeletedDocs(this.since)}saveCheckInOut(t,e,s){this.db.saveCheckInOut(t,e,s)}savePosInvoice(t){this.db.savePosInvoice(t)}updatePosInvoice(t){this.db.updatePosInvoice(t)}getNotSyncedPos(t,e){this.db.getNotSyncedPos(s=>{t(s)},s=>{e(s)})}getNotSyncedPosNumber(t,e){this.db.getNotSyncedPosNumber(s=>{t(s)},s=>{e(s)})}async fetchDebts(t){return await this.api_handler.fetchDebts(t)}async fetchDebtsSalesInvoices(t){return await this.api_handler.fetchDebtsSalesInvoices(t)}async fetchCustomerDebt(t){return await this.api_handler.fetchCustomerDebt(t)}async update_invoice_payment(t,e){let s=await this.api_handler.update_invoice_payment(t,e);return await this.getPosInvoices(),this.appData.pos_invoices.forEach(i=>{if(i.real_name==t){let n=structuredClone(i);n.outstanding_amount=s.outstanding_amount,n.paid_amount=s.paid_amount,n.status=s.paid,n.real_name=s.real_name,this.db.updatePosInvoice(n)}}),s}async update_sales_invoice_payment(t,e){let s=await this.api_handler.update_sales_invoice_payment(t,e);return s.invoices.forEach(i=>{this.appData.pos_invoices.forEach(n=>{n.real_name==i.name&&(n.consolidated_invoice=t,n.start_paying=!0,s.status=="Paid"&&(n.outstanding_amount=0,n.paid_amount=i.total,n.grand_paid_amount=i.total,n.status="Paid"),this.db.updatePosInvoice(n))})}),await this.getPosInvoices(),s}async paySelectedInvoice(t,e){let s=await this.api_handler.pay_selected_invoice(t,e);return s.invoices_state_collection.forEach(i=>{i.invoices.forEach(n=>{this.appData.pos_invoices.forEach(a=>{a.real_name==n.name&&(a.consolidated_invoice=i.sales_invoice_name,a.start_paying=!0,i.status=="Paid"&&(a.outstanding_amount=0,a.paid_amount=n.total,a.grand_paid_amount=n.total,a.status="Paid"),this.db.updatePosInvoice(a))})})}),s}async getAllOpenedPosInvoice(){return await this.db.getAllOpenedPosInvoice()}async deletePosInvoice_callback(t,e,s){this.db.deletePosInvoice_callback(t,e,s)}combineLocalAndUpdated(t,e){let s=new Map(t.map(i=>[i.name,i]));return this.appData.deleted_documents.forEach(i=>{s.delete(i.name)}),e.forEach(i=>{s.set(i.name,i)}),Array.from(s.values())}};pos_ar.PointOfSale.FetchHandler=class{constructor(){console.log("testing4")}async fetchCustomers(e){try{let s={disabled:0};return await frappe.db.get_list("Customer",{fields:["name","customer_name","custom_debt","default_price_list"],filters:s,limit:1e5,order_by:"customer_name ASC"})}catch(s){return console.error("Error fetching customers:",s),[]}}async fetchBrands(e){try{let s={};return await frappe.db.get_list("Brand",{fields:["brand"],filters:s,limit:1e5})}catch(s){return console.error("Error fetching customers:",s),[]}}async fetchItemGroups(e){try{let s={};return await frappe.db.get_list("Item Group",{fields:["name","item_group_name","parent_item_group","is_group"],filters:s,limit:1e5,order_by:"item_group_name ASC"})}catch(s){return console.error("Error fetching Item Group :",s),[]}}async fetchItems(e){try{let s={disabled:0};return await frappe.db.get_list("Item",{fields:["name","item_name","image","brand","item_group","description","stock_uom","barcodes"],filters:s,limit:1e5,order_by:"item_name ASC"})}catch(s){return console.error("Error fetching Item Group :",s),[]}}async fetchItemBarCodes(){try{return(await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_item_barcodes",args:{}})).message}catch(e){return console.error("Error fetching Item Barcodes:",e),[]}}async fetchCustomerDebt(e){try{return(await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_customer_debt",args:{name:e}})).message}catch(s){return console.error("Error fetching Item Barcodes:",s),[]}}async fetchItemPrice(e){try{let s={};return await frappe.db.get_list("Item Price",{fields:["name","item_code","item_name","price_list","price_list_rate","brand"],filters:s,limit:1e5})}catch(s){return console.error("Error fetching Item Group :",s),[]}}async fetchPriceList(e){try{let s={selling:1,enabled:1};return await frappe.db.get_list("Price List",{fields:["name","price_list_name","currency"],filters:s,limit:1e5})}catch(s){return console.error("Error fetching Item Group :",s),[]}}async fetchWarehouseList(e){try{let s={};return await frappe.db.get_list("Warehouse",{fields:["name","warehouse_name"],filters:s,limit:1e5})}catch(s){return console.error("Error fetching Warehouse list : ",s),[]}}async fetchPosProfile(){try{let e={disabled:0},s=await frappe.db.get_list("POS Profile",{fields:["name"],filters:e,limit:1});return await frappe.db.get_doc("POS Profile",s[0].name)}catch(e){return console.error("Error fetching pos profile list : ",e),null}}async fetchPosProfileModeOfPayments(e,s){try{return(await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_mode_of_payments",args:{}})).message}catch(i){return console.error("Error fetching mode_of_payments",i),[]}}async fetchCompany(e){try{return await frappe.db.get_doc("Company",e)}catch(s){return console.error("Error fetching company by companyId from the profile list : ",s),[]}}async fetchSalesTaxesAndChargesTemplate(e){try{return await frappe.db.get_doc("Sales Taxes and Charges Template",e)}catch(s){return console.error("Error fetching Warehouse list : ",s),[]}}async fetchBinList(e){try{let s={};return await frappe.db.get_list("Bin",{fields:["name","actual_qty","item_code","warehouse"],filters:s,limit:1})}catch(s){return console.error("Error fetching Bin list : ",s),[]}}async fetchDeletedDocs(e){try{let s={};return e&&(s.modified=[">",e]),await frappe.db.get_list("Deleted Document",{fields:["name","deleted_name","deleted_doctype","restored"],filters:s,limit:1e5})}catch(s){return console.error("Error fetching deleted documents :",s),[]}return[]}async fetchDebts(e){try{let s=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_customer_debts",args:{customer_name:e}});return s.message&&!s.message.error?s.message:[]}catch(s){console.error("Error fetching debts:",s),frappe.msgprint(__("Error fetching debts."))}}async fetchDebtsSalesInvoices(e){try{let s=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.get_customer_debts_sales_invoices",args:{customer_name:e}});return s.message&&!s.message.error?(console.log("customer debts : ",s.message),s.message):[]}catch(s){console.error("Error fetching debts:",s),frappe.msgprint(__("Error fetching debts."))}}async update_invoice_payment(e,s){try{let i=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.update_invoice_payment",args:{invoice_name:e,payment_amount:s}});return i.message&&!i.message.error?i.message:[]}catch(i){console.error("Error fetching debts:",i),frappe.msgprint(__("Error fetching debts."))}}async update_sales_invoice_payment(e,s){try{let i=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.update_sales_invoice_payment",args:{invoice_name:e,payment_amount:s}});return i.message&&!i.message.error?i.message:[]}catch(i){console.error("Error fetching debts:",i),frappe.msgprint(__("Error fetching debts."))}}async pay_selected_invoice(e,s){try{let i=await frappe.call({method:"pos_ar.pos_ar.doctype.pos_info.pos_info.pay_selected_invoice",args:{invoices:e,payment_amount:s}});return i.message&&!i.message.error?i.message:[]}catch(i){console.error("Error fetching debts:",i),frappe.msgprint(__("Error fetching debts."))}}};pos_ar.PointOfSale.ScreenManager=class{constructor(t){this.settings_data=t,this.screens=new Map,this.activeScreen=null}registerScreen(t,e){this.screens.set(t,e)}navigate(t){switch(console.log("debuging 1 ",t),t){case"history_cart":console.log("history_cart"),this.history_cart.show_cart(),this.customer_box.showHomeBar(),this.payment_cart.hideCart(),this.item_details.hide_cart(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.customer_box.hideSyncBar(),this.settings_cart.hideCart(),this.check_in_out_cart.hideCart(),this.debt_cart.hideCart(),this.unsynced_pos_cart.hide_cart();break;case"settings_cart":this.settings_cart.showCart(),this.customer_box.showHomeBar(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.history_cart.hide_cart(),this.check_in_out_cart.hideCart(),this.debt_cart.hideCart(),this.unsynced_pos_cart.hide_cart(),this.customer_box.hideSyncBar();break;case"check_in_out_cart":this.check_in_out_cart.showCart(),this.customer_box.showHomeBar(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.item_details.hide_cart(),this.payment_cart.hideCart(),this.history_cart.hide_cart(),this.settings_cart.hideCart(),this.debt_cart.hideCart(),this.unsynced_pos_cart.hide_cart(),this.customer_box.hideSyncBar();break;case"home":this.item_selector.showCart(),this.customer_box.showSyncBar(),this.selected_item_cart.showCart(),this.payment_cart.hideCart(),this.customer_box.hideHomeBar(),this.item_details.hide_cart(),this.history_cart.hide_cart(),this.settings_cart.hideCart(),this.debt_cart.hideCart(),this.check_in_out_cart.hideCart(),this.settings_data.settings.showItemDetails&&this.selected_item_cart.hideKeyboard(),this.unsynced_pos_cart.hide_cart(),this.selected_item_cart.setKeyboardOrientation("portrait"),this.selected_item_cart.cleanHeighlight(),this.selected_item_cart.refreshTabs(),this.selected_item_cart.refreshSelectedItem();break;case"debt_cart":this.debt_cart.showCart(),this.customer_box.showHomeBar(),this.item_selector.hideCart(),this.selected_item_cart.hideCart(),this.item_details.hide_cart(),this.history_cart.hide_cart(),this.settings_cart.hideCart(),this.payment_cart.hideCart(),this.check_in_out_cart.hideCart(),this.unsynced_pos_cart.hide_cart();break;case"payment_cart":this.payment_cart.showCart(),this.item_selector.hideCart(),this.item_details.hide_cart(),this.settings_cart.hideCart(),this.debt_cart.hideCart(),this.payment_cart.calculateGrandTotal(),this.selected_item_cart.setKeyboardOrientation("landscape"),this.selected_item_cart.cleanHeighlight(),this.selected_item_cart.showKeyboard(),this.unsynced_pos_cart.hide_cart();break;case"item_details":this.settings_data.settings.showItemDetails&&(this.item_details.show_cart(),this.item_selector.hideCart(),this.selected_item_cart.showKeyboard(),this.payment_cart.hideCart(),this.settings_cart.hideCart(),this.unsynced_pos_cart.hide_cart(),this.selected_item_cart.setKeyboardOrientation("landscape")),this.selected_item_cart.makeSelectedButtonHighlighted();break;case"unsynced_pos_cart":this.unsynced_pos_cart.show_cart(),this.customer_box.showHomeBar(),this.history_cart.hide_cart(),this.check_in_out_cart.hideCart(),this.item_selector.hideCart(),this.customer_box.hideSyncBar(),this.selected_item_cart.hideCart(),this.payment_cart.hideCart(),this.item_selector.hideCart(),this.item_details.hide_cart(),this.settings_cart.hideCart(),this.debt_cart.hideCart(),this.payment_cart.calculateGrandTotal(),this.selected_item_cart.setKeyboardOrientation("landscape"),this.selected_item_cart.cleanHeighlight(),this.selected_item_cart.showKeyboard();break;default:break}}};})();
//# sourceMappingURL=pos.bundle.AAS3A6X2.js.map
