
pos_ar.PointOfSale.pos_item_details = class{

	constructor(
		wrapper,
		warehouse,
		priceLists,
		itemPrices,
		binList,
		selectedItem,
		selectedField,
		onInput,
		onClose,
	){
		console.log("hello from item_details 0")
		this.wrapper        = wrapper   ;
		this.warehouse      = warehouse ;
		this.price_lists    = priceLists;
		this.item_prices    = itemPrices;
		this.selected_item  = selectedItem ;
		this.selected_field = selectedField;
		this.on_input       = onInput;
		this.on_close_cart  = onClose;
		this.bin_list       = binList;

		console.log("start with : " , warehouse)

		this.start_the_work();
	}


	// start function

	start_the_work(){
		this.prepare_item_details_cart();
		this.setDetailsFieldsListeners();
	}


	/****************************    ui functions   **********************************/

        prepare_item_details_cart(){
                this.wrapper.append('<div id="itemDetailsCart" class="columnBox align_center"><div>')

                this.item_details_cart = this.wrapper.find("#itemDetailsCart")
                this.item_details_cart.append('<div id="itemDetailsCartHeader" class="rowBox header align_center row_sbtw"></div>')

                this.cart_header = this.item_details_cart.find('#itemDetailsCartHeader')
                this.cart_header.append('<h4 class="CartTitle">Item Details</h4>')
                this.cart_header.append('<img src="/assets/pos_ar/images/cancel.png" alt="Cancel Button" id="itemDetailsCartXBtn" class="xBtn">')

                this.close_btn = this.cart_header.find("#itemDetailsCartXBtn").on("click", (event) =>{
                        this.on_close_cart();
                })

		this.item_details_cart.append('<div id="itemDetailsHeader" class="rowBox"></div>')

		this.header_details = this.item_details_cart.find('#itemDetailsHeader')
		this.header_details.append('<div id="detailsItemImage" class="rowBox centerItem"></div>')
		this.header_details.append('<div id="price_and_name" class="columnBox"></div>')

		this.price_and_name_details = this.header_details.find('#price_and_name')
		this.price_and_name_details.append('<div id="detailsItemName" class="rowBox align_center"></div>')
		this.price_and_name_details.append('<div id="detailsItemGroupWarhouseContainer" class="rowBox align_center row_sa"></divr>')

		this.item_group_warehouse_details = this.price_and_name_details.find('#detailsItemGroupWarhouseContainer')
		this.item_group_warehouse_details.append('<div id="detailsItemGroup" class="rowBox align_center">Group : ...</div>')
		this.item_group_warehouse_details.append('<div id="detailsItemWarehouse" class="rowBox align_center">Warehouse : ...</div>')

		this.item_details_cart.append('<div id="itemDetailsAll"  class="rowBox"></div>')

		this.details_all = this.item_details_cart.find('#itemDetailsAll')
		this.details_all.append('<div id="itemDetails_C1" class="columnBox"></div>')

		this.c1 = this.details_all.find('#itemDetails_C1')
		this.c1.append('<div class="columnBox"><label for="itemDetailsQuantityInput">Quantity</label><input type="float" id="itemDetailsQuantityInput" class="pointerCursor"></div>')
		this.c1.append('<div class="columnBox"><label for="itemDetailsRateInput">Rate</label><input type="float" id="itemDetailsRateInput" class="pointerCursor"></div>')
		this.c1.append('<div class="columnBox"><label for="itemDetailsDiscountInput">Discount (%)</label><input type="float" id="itemDetailsDiscountInput" class="pointerCursor"></div>')
		this.c1.append('<div class="columnBox"><label for="itemDetailsAvailableInput">Available Qty at Warehouse</label><input type="float" id="itemDetailsAvailableInput" disabled></div>')


		this.details_all.append('<div id="itemDetails_C2" class="columnBox"></div>')

		this.c2 = this.details_all.find('#itemDetails_C2')
		this.c2.append('<div class="columnBox"><label for="itemDetailsUomInput">UOM *</label><input type="text" id="itemDetailsUomInput"  disabled></div>')
		this.c2.append('<div class="columnBox"><label for="detailsPriceList">Price List *</label><input list="detailsPriceList" id="detailsItemPriceListInput" class ="rowBox align_center pointerCursor"><datalist id="detailsPriceList"><option>fetching Price Lists ...</option></datalist></div>')
		this.c2.append('<div class="columnBox"><label for="itemDetailsDiscountMontantInput">Discount (montant)</label><input type="float" id="itemDetailsDiscountMontantInput" class="pointerCursor"></div>')
		this.c2.append('<div class="columnBox"><label for="itemDetailsPriceListRateInput">Price List Rate</label><input type="text" id="itemDetailsPriceListRateInput" disabled></div>')



	}

	refreshDate(item){

		console.log("start ref")
		const imageContainer    = document.getElementById("detailsItemImage") ;
		const name  = document.getElementById("detailsItemName");
		const warehouse     = document.getElementById("detailsItemWarehouse");
		const itemGroup     = document.getElementById("detailsItemGroup");

		const quantity             = document.getElementById("itemDetailsQuantityInput");
		const rate                 = document.getElementById("itemDetailsRateInput");
		const discount_percentage  = document.getElementById("itemDetailsDiscountInput");
		const discount_amount      = document.getElementById("itemDetailsDiscountMontantInput");
		const available            = document.getElementById("itemDetailsAvailableInput");

		const uom           = document.getElementById("itemDetailsUomInput");
		const priceList     = document.getElementById("detailsItemPriceListInput");
		const priceListRate = document.getElementById("itemDetailsPriceListRateInput");

		//populate
		if(item.image){
			const image = document.createElement("img");
			image.src = item.image;
			imageContainer.innerHTML = "";
			imageContainer.appendChild(image);
		}
		else{
			const image = document.createElement("div");
			image.textContent = item.item_name[0];
			image.style.fontSize = "xx-large";
			image.style.fontWeight = "700";
			imageContainer.innerHTML = "";
			imageContainer.appendChild(image);
		}

		//name
		name.textContent  = item.item_name;
		name.classList.add("rowBox" , "align_center");


		//quantity
		quantity.value = item.quantity

		//rate
		rate.value = item.amount

		//discount
		discount_amount.value     = item.discount_amount ?? 0.00;
		discount_percentage.value = item.discount_percentage ?? 0.00;


		//available
		available.value = this.getQtyInWarehouse(item.name ,  this.warehouse)


		//uom
		uom.value = item.stock_uom


		//priceList
		priceList.value = this.price_lists[0].price_list_name
		//warehouse
		warehouse.textContent = "Warehouse : " + this.warehouse
		//item group
		itemGroup.textContent = "Item Group : " + item.item_group

		//priceListRate
		priceListRate.value = this.getItemPrice(item.name) + "DA"


		console.log("end ref")


		//hightlited fields
		this.makeSelectedFieldHighlighted()
		//listeners
		//setItemDetailsFieldsListener()
	}

	show_cart(){
		console.log('show 02')
		this.item_details_cart.css("display" , "flex");
	}

	hide_cart(){
		console.log('hide 001')
		this.item_details_cart.css("display" , "none");
	}

	makeSelectedFieldHighlighted(){


		if(this.selected_field.field_name == "quantity"){
			this.c1.find('#itemDetailsQuantityInput').addClass('selected')
			this.c1.find('#itemDetailsRateInput').removeClass('selected')
			this.c1.find('#itemDetailsDiscountInput').removeClass('selected')
		}
		else if(this.selected_field.field_name == "rate"){
			this.c1.find('#itemDetailsQuantityInput').removeClass('selected')
			this.c1.find('#itemDetailsRateInput').addClass('selected')
			this.c1.find('#itemDetailsDiscountInput').removeClass('selected')
		}
		else if(this.selected_field.field_name == "discount_percentage"){
			this.c1.find('#itemDetailsQuantityInput').removeClass('selected')
			this.c1.find('#itemDetailsRateInput').removeClass('selected')
			this.c1.find('#itemDetailsDiscountInput').addClass('selected')
		}
		else{
			this.c1.find('#itemDetailsQuantityInput').removeClass('selected')
			this.c1.find('#itemDetailsRateInput').removeClass('selected')
			this.c1.find('#itemDetailsDiscountInput').removeClass('selected')
		}

	}


	requestFocus(field){
		if(field == "quantity"){
			this.c1.find('#itemDetailsQuantityInput').focus();
		}
		else if(field == "rate"){
			this.c1.find('#itemDetailsRateInput').focus();
		}
		else if(field == "discount_percentage"){
			this.c1.find('#itemDetailsDiscountInput').focus();
		}
		else if(field == "discount_amount"){
			this.c1.find('#itemDetailsDiscountMontantInput').focus();
		}
	}

/*

else if(keyContent == "." && !selectedField.value.includes(".")){
                                        this.on_key_pressed( "addToField" , key.text())
                                }

*/
	addToField(field , value){

		console.log('field : ' , field , 'value : ' , value )

		if(field == "quantity"){
			this.c1.find('#itemDetailsQuantityInput').val( (index,currentValue) =>{
				if(value == "." && currentValue.includes("."))
					return currentValue
				else
					return currentValue + value
			})
		}
		else if(field == "rate"){
			this.c1.find('#itemDetailsRateInput').val( (index,currentValue) =>{
				if(value == "." && currentValue.includes("."))
					return currentValue
				else
					return currentValue + value
			})
		}
		else if(field == "discount_percentage"){
			this.c1.find('#itemDetailsDiscountInput').val( (index,currentValue) =>{
				if(value == "." && currentValue.includes("."))
					return currentValue
				else
					return currentValue + value
			})

		}
		else if(field == "discount_amount"){
			this.c1.find('#itemDetailsDiscountInput').val( (index,currentValue) =>{
				if(value == "." && currentValue.includes("."))
					return currentValue
				else
					return currentValue + value
			})

		}

	}

	/**************************  set listener  ****************************/

	setDetailsFieldsListeners(){

		this.quantityInput        = this.c1.find('#itemDetailsQuantityInput')
		this.rateInput            = this.c1.find('#itemDetailsRateInput')
		this.discountInput        = this.c1.find('#itemDetailsDiscountInput')
		this.discountMontantInput = this.c2.find('#itemDetailsDiscountMontantInput')

		//quantity input
		this.quantityInput.on('input' , (event)=>{
			const value = event.target.value;

			if(value.length == 0){
				event.target.value = 0
			}
			else if (!value.slice(0,-1).includes(".")  && value[value.length-1] == "."){
				event.target.value = value
			}
			else if(value[value.length-1] == "."){
				event.target.value = value.slice(0,-1);
			}
			else if(value[value.length-1] == " "){
				event.target.value = value.slice(0,-1);
			}
			else if(isNaN(value[value.length-1])){
				event.target.value = value.slice(0,-1);
			}
			else{
				event.target.value = value
			}

			//new quantity
			let newQuantity = parseFloat(this.quantityInput.val());
			if(isNaN(newQuantity)){
				console.warn("Invaide Quantity value =>" , this.quantityInput.val())
				return;
			}
			else if(newQuantity <= 0){
				newQuantity = 0;
			}

			this.on_input( "input" , "quantity" , newQuantity)
		})

		this.quantityInput.on('focus' , (event)=>{
			this.on_input( "focus" , "quantity" , null)
		})

		this.quantityInput.on('blur' , (event)=>{
			this.on_input( "blur" , "quantity" , null)
		})

		//rate field listeners
		this.rateInput.on('input' , (event)=>{
			const value = event.target.value ;

			if(value.length == 0){
				event.target.value = 0
			}
			else if (!value.slice(0,-1).includes(".")  && value[value.length-1] == "."){
				event.target.value = value
			}
			else if(value[value.length-1] == "."){
				event.target.value = value.slice(0,-1);
			}
			else if(isNaN(value[value.length-1])){
				event.target.value = value.slice(0,-1);
			}
			else{
				event.target.value = value;
			}

			let newRate = parseFloat(this.rateInput.val());

			console.log("new rate : " , newRate)
			if(isNaN(newRate)){
				console.warn("Invalide Rate value")
				return;
			}


			this.on_input( "input" , "rate" , newRate)
		})
		this.rateInput.on('focus' , (event)=>{
			this.on_input( "focus" , "rate" , null)
		})
		this.rateInput.on('blur' , (event)=>{
			this.on_input( "blur" , "rate" , null)
		})




		//discount field listener
		this.discountInput.on('input' , (event)=>{
			const value = event.target.value ;

			if(value.length == 0){
				event.target.value = 0;
			}
			else if(!value.slice(0,-1).includes(".")  && value[value.length-1] == "."){
				event.target.value = value;
			}
			else if(value[value.length-1] == "."){
				event.target.value = value.slice(0,-1);
			}
			else if(isNaN(value[value.length-1])){
				event.target.value = value.slice(0,-1);
			}
			else{
				event.target.value = value ;
			}

			let newDiscount = this.discountInput.val();

			console.log("the new value " , newDiscount)

			if(isNaN(newDiscount)){
				console.warn("Invalide discount value")
				return
			}

			//console.log("condition ==> " , newDiscount<100 )
			if(newDiscount < 100){
				this.on_input( "input" , "discount_percentage" , newDiscount)
			}
			else{
				event.target.value = 100;
				this.on_input( "input" , "discount_percentage" , 100)
			}

		})

		this.discountInput.on('focus' , (event)=>{
			this.on_input( "focus" , "discount_percentage" , null)
		})

		this.discountInput.on('blur' , (event)=>{
			this.on_input( "blur" , "discount_percentage" , null)
		})


		//discount field listener
		this.discountMontantInput.on('input' , (event)=>{
			const value = event.target.value ;

			if(value.length == 0){
				event.target.value = 0;
			}
			else if(!value.slice(0,-1).includes(".")  && value[value.length-1] == "."){
				event.target.value = value;
			}
			else if(value[value.length-1] == "."){
				event.target.value = value.slice(0,-1);
			}
			else if(isNaN(value[value.length-1])){
				event.target.value = value.slice(0,-1);
			}
			else{
				event.target.value = value ;
			}

			let newDiscount = this.discountMontantInput.val();

			if(isNaN(newDiscount)){
				console.warn("Invalide discount value")
				return
			}

			//console.log("condition ==> " , newDiscount<100 )
			this.on_input( "input" , "discount_amount" , newDiscount)

		})

		this.discountMontantInput.on('focus' , (event)=>{
			console.log("we are here")
			this.on_input( "focus" , "discount_amount" , null)
		})

		this.discountMontantInput.on('blur' , (event)=>{
			this.on_input( "blur" , "discount_amount" , null)
		})

	}


	/*************************** funs  ************************************/

	getItemPrice(itemId){
		const price = this.item_prices.find(itemPrice => itemPrice.item_code == itemId)
		return price ? price.price_list_rate  : 0
	}


	getQtyInWarehouse(itemId , warehouseId){
		const bin = this.bin_list.find(bin => bin.item_code == itemId && bin.warehouse == warehouseId)
		return bin ? bin.actual_qty : 0
	}


}
