[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "POS Closing Entry",
  "enabled": 1,
  "modified": "2025-01-02 19:24:59.671197",
  "module": "POS AR",
  "name": "calculate total money",
  "script": "frappe.ui.form.on('POS Closing Entry', {\n\n    refresh: function(frm) {\n        \n        // Predefined denominations\n        const denominations = [5, 10, 20, 50, 100 , 200 , 500, 1000, 2000];\n        \n\n        \n        // Ensure calculations after all refresh operations\n        frappe.after_ajax(async () => {\n            //frappe.msgprint(\"we are here1\")\n            await waitForDataLoading(frm);\n            calculate_total_money(frm);\n        })\n\n\n        // Check if the table is empty\n        if (!frm.doc.custom_money || frm.doc.custom_money.length === 0) {\n            denominations.forEach(denomination => {\n                frm.add_child('custom_money', {\n                    money : `${denomination} DA`,\n                    qty   : 0, // Default count is 0\n                    total : 0  // Default count is 0\n                });\n            });\n\n            // Refresh the field to reflect changes\n            frm.refresh_field('custom_money');\n        }\n        \n    }\n});\n\nfunction waitForDataLoading(frm) {\n    return new Promise((resolve) => {\n        let checkInterval = setInterval(() => {\n            \n            console.log(\"we are working..... \")\n            // Check if the necessary data is loaded\n            if (frm.doc.payment_reconciliation && frm.doc.payment_reconciliation.length > 0 && frm.doc.pos_transactions && frm.doc.pos_transactions.length > 0) {\n                console.log(\"we are working..... \" , frm.doc.payment_reconciliation.length , \"data\" , frm.doc.payment_reconciliation)\n                clearInterval(checkInterval);\n                resolve();\n            }\n        }, 200); // Check every 200ms\n    });\n}\n\n\nfrappe.ui.form.on('money',{\n    qty: function(frm, cdt, cdn) {\n        let row = frappe.get_doc(cdt, cdn);\n        if (row.money) {\n            let money = parseInt(row.money.split(' ')[0]); // Extract number from money\n            row.total = (row.qty || 0) * money; // Calculate total\n            frm.refresh_field('custom_money'); // Refresh the child table\n            calculate_total_denominations(frm)\n        }\n        \n        calculate_total_money(frm)\n    }\n})\n\nfunction calculate_total_denominations(frm){\n        \n    let total = 0\n    \n    if (frm.doc.custom_money) {\n        frm.doc.custom_money.forEach(row => {\n            total += row.total;\n        });\n    }\n    frm.set_value('custom_closing_amount', total);\n    frm.refresh_field('custom_closing_amount') ;\n}\n\n\n\nfrappe.ui.form.on('POS Invoice Reference',{\n    pos_transactions_add : function(frm , cdt , cdn){\n        calculate_total_money(frm)\t\n    },\n    pos_transactions_remove : function(frm , cdt , cdn){\n        calculate_total_money(frm)\t\n    },\n    pos_transactions : function(frm){\n        calculate_total_money(frm);\n    }\n})\n\n\nfrappe.ui.form.on('POS Closing Entry Detail',{\n    payment_reconciliation_add : function(frm , cdt , cdn){\n        calculate_total_money(frm)\t\n    },\n    payment_reconciliation_remove : function(frm , cdt , cdn){\n        calculate_total_money(frm)\t\n    },\n    closing_amount : function(frm){\n        calculate_total_money(frm)\t\n    }\n})\n\n\nfrappe.ui.form.on('check_in_out',{\n    custom_check_in_out_add : function(frm , cdt , cdn){\n        calculate_total_money(frm)\t\n    },\n    custom_check_in_out_remove : function(frm , cdt , cdn){\n        calculate_total_money(frm)\t\n    },\n    amount : function(frm){\n        calculate_total_money(frm)\t\n    },\n    check_type : function(frm){\n        calculate_total_money(frm)\t\n    }\n})\n\n\n\nfunction calculate_total_money(frm) {\n    //frappe.msgprint(\"we are here\")\n    console.log(\" in cal with : \" , frm.doc.payment_reconciliation )\n    let total_money = 0;\n\n    let total_payment = 0 ;\n    let total_check_in_out = 0 ;\n    let closing_amount     = 0 ;\n\n    closing_amount = frm.doc.custom_closing_amount\n    \n    // Calculate total from Payment Table\n    if (frm.doc.payment_reconciliation) {\n        frm.doc.payment_reconciliation.forEach(row => {\n            total_payment += row.expected_amount || 0;\n        });\n    }\n    \n    // Calculate total from Payment Table\n    if (frm.doc.custom_check_in_out) {\n        frm.doc.custom_check_in_out.forEach(row => {\n            if(row.check_type == \"In\"){\n                total_check_in_out += row.amount || 0;    \n            }else{\n                total_check_in_out -= row.amount || 0;\n            }\n            \n        });\n    }\n    \n    total_money    = total_payment  + total_check_in_out\n\n    console.log(\"total_payment : \" , total_payment ,\" || custom_total_money : \" , total_money , \" || custom_closing_amount : \" , closing_amount , \" || custom_difference :  \" , closing_amount - total_money)\n    \n    \n    // Update Total Money field\n    frm.set_value('custom_total_money', total_money);\n    frm.set_value('custom_difference', closing_amount - total_money);\n    \n    // Refresh the field to reflect changes\n    frm.refresh_field('custom_total_money');\n    frm.refresh_field('custom_difference');\n}",
  "view": "Form"
 }
]